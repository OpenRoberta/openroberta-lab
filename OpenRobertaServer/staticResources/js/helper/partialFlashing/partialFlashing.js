var __awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(n,s){function i(e){try{l(a.next(e))}catch(e){s(e)}}function o(e){try{l(a.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,o)}l((a=a.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,a,n,s,i={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(i=0)),i;)try{if(r=1,a&&(n=2&o[0]?a.return:o[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,o[1])).done)return n;switch(a=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,a=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(n=i.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){i.label=o[1];break}if(6===o[0]&&i.label<n[1]){i.label=n[1],n=o;break}if(n&&i.label<n[2]){i.label=n[2],i.ops.push(o);break}n[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],a=0}finally{r=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};define(["require","exports","dapjs","asyncUtil","partialFlashingUtils"],(function(e,t,r,a,n){Object.defineProperty(t,"__esModule",{value:!0}),t.PartialFlashing=void 0;var s=new Uint32Array([3187719680,620934640,1277184799,4089401629,4089417583,629182287,3014893,788552031,631361788,1364721901,754997661,620810492,4089401629,4089417583,629182287,3014893,788552031,620876028,4089401629,4089417583,1503498063,3506187520,620766848,16122002,3507045013,1360667136,2406478783,2404381631,704666010,3186675964,1363630415,788552095,889508092,1187047404,1073864704,1284]),i=new Uint32Array([1277670896,1151673984,570462721,2432716581,7770883,604504083,620822553,1089159209,3489671424,1006715003,3522505728,1183580305,2835629669,1349202433,3521856178,144415489,588485378,2600683164,3506717340,536919594,1151159061,2667625968,1293196802,1226131988,1040305928,554779467,1225998795,1079657291,1180909661,587547098,1259357018,1180899538,587547101,1259160413,771758317,1610797543,2583730945,416505925,2466263048,3889312769,4294966252,3988292384,1044,516138696,798746316,3432918353,461845907,3864292196]),o=536870912,l=536879104,c=536875008,p=function(){function e(e){this.dapwrapper=e}return e.prototype.getFlashChecksumsAsync=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this.dapwrapper.executeAsync(o,i,c,536870913,4294967295,l,0,this.dapwrapper.pageSize,this.dapwrapper.numPages)];case 1:return e.sent(),[2,this.dapwrapper.readBlockAsync(l,2*this.dapwrapper.numPages)]}}))}))},e.prototype.runFlash=function(e,t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,this.dapwrapper.cortexM.halt(!0)];case 1:return r.sent(),[4,Promise.all([this.dapwrapper.cortexM.writeCoreRegister(n.CoreRegister.PC,536870917),this.dapwrapper.cortexM.writeCoreRegister(n.CoreRegister.LR,536870913),this.dapwrapper.cortexM.writeCoreRegister(n.CoreRegister.SP,c),this.dapwrapper.cortexM.writeCoreRegister(0,e.targetAddr),this.dapwrapper.cortexM.writeCoreRegister(1,t),this.dapwrapper.cortexM.writeCoreRegister(2,this.dapwrapper.pageSize>>2)])];case 2:return r.sent(),[2,this.dapwrapper.cortexM.resume(!1)]}}))}))},e.prototype.partialFlashPageAsync=function(e,t,r){return __awaiter(this,void 0,void 0,(function(){var a,s,i,o,c;return __generator(this,(function(p){switch(p.label){case 0:if(e.targetAddr>=268435456)return[2];if(a=1&r?l:l+this.dapwrapper.pageSize,s=1&r?l+this.dapwrapper.pageSize:l,0!==r)return[3,2];for(i=new Uint32Array(e.data.length/4),o=0;o<e.data.length;o+=4)i[o>>2]=(0,n.read32FromUInt8Array)(e.data,o);return[4,this.dapwrapper.writeBlockAsync(a,i)];case 1:p.sent(),p.label=2;case 2:return[4,this.runFlash(e,a)];case 3:return p.sent(),t?(c=new Uint32Array(t.data.buffer),[4,this.dapwrapper.writeBlockAsync(s,c)]):[3,5];case 4:p.sent(),p.label=5;case 5:return[2,this.dapwrapper.waitForHalt()]}}))}))},e.prototype.partialFlashCoreAsync=function(e,t){return __awaiter(this,void 0,void 0,(function(){var r;return __generator(this,(function(a){switch(a.label){case 0:console.log("Partial flash"),r=0,a.label=1;case 1:return r<e.length?(t(r/e.length),[4,this.partialFlashPageAsync(e[r],e[r+1],r)]):[3,4];case 2:a.sent(),a.label=3;case 3:return++r,[3,1];case 4:return t(1),[2]}}))}))},e.prototype.partialFlashAsync=function(e,t,r){return __awaiter(this,void 0,void 0,(function(){var a,i,l,c,p,u,h;return __generator(this,(function(f){switch(f.label){case 0:return a=t.getIntelHexBytes(e.normalize().id),[4,this.getFlashChecksumsAsync()];case 1:return i=f.sent(),[4,this.dapwrapper.writeBlockAsync(o,s)];case 2:if(f.sent(),l=(0,n.pageAlignBlocks)(a,0,this.dapwrapper.pageSize),c=l.length,console.log("Total pages: "+c),l=(0,n.onlyChanged)(l,i,this.dapwrapper.pageSize),console.log("Changed pages: "+l.length),!(l.length>c/2))return[3,8];f.label=3;case 3:return f.trys.push([3,5,,7]),[4,this.fullFlashAsync(e,t,r)];case 4:return f.sent(),p=!1,[3,7];case 5:return u=f.sent(),console.log(u),console.log("Full flash failed, attempting partial flash."),[4,this.partialFlashCoreAsync(l,r)];case 6:return f.sent(),p=!0,[3,7];case 7:return[3,12];case 8:return f.trys.push([8,10,,12]),[4,this.partialFlashCoreAsync(l,r)];case 9:return f.sent(),p=!0,[3,12];case 10:return h=f.sent(),console.log(h),console.log("Partial flash failed, attempting full flash."),[4,this.fullFlashAsync(e,t,r)];case 11:return f.sent(),p=!1,[3,12];case 12:return f.trys.push([12,14,,15]),[4,this.dapwrapper.reset()];case 13:return f.sent(),[3,15];case 14:return f.sent(),[3,15];case 15:return console.log("Flashing complete"),[2,p]}}))}))},e.prototype.fullFlashAsync=function(e,t,a){return __awaiter(this,void 0,void 0,(function(){var n,s;return __generator(this,(function(i){switch(i.label){case 0:console.log("Full flash"),n=function(e){a(e)},this.dapwrapper.daplink.on(r.DAPLink.EVENT_PROGRESS,n),i.label=1;case 1:return i.trys.push([1,,5,6]),[4,t.fullFlashData(e)];case 2:return s=i.sent(),[4,this.dapwrapper.transport.open()];case 3:return i.sent(),[4,this.dapwrapper.daplink.flash(s)];case 4:return i.sent(),[3,6];case 5:return this.dapwrapper.daplink.removeListener(r.DAPLink.EVENT_PROGRESS,n),[7];case 6:return[2]}}))}))},e.prototype.flashAsync=function(e,t,r){return __awaiter(this,void 0,void 0,(function(){var n,s,i=this;return __generator(this,(function(o){switch(o.label){case 0:n=__awaiter(i,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:console.log("Begin reset"),e.label=1;case 1:return e.trys.push([1,3,,6]),[4,this.dapwrapper.reset(!0)];case 2:return e.sent(),[3,6];case 3:return e.sent(),console.log("Retrying reset"),[4,this.dapwrapper.reconnectAsync()];case 4:return e.sent(),[4,this.dapwrapper.reset(!0)];case 5:return e.sent(),[3,6];case 6:return[2]}}))})),o.label=1;case 1:o.trys.push([1,,10,12]),o.label=2;case 2:return o.trys.push([2,5,,9]),[4,(0,a.withTimeout)(n,1e3)];case 3:return o.sent(),console.log("Begin flashing"),[4,this.partialFlashAsync(e,t,r)];case 4:return[2,o.sent()];case 5:return(s=o.sent())instanceof a.TimeoutError?(console.log("Resetting micro:bit timed out"),console.log("Partial flashing failed. Attempting full flash"),[4,this.fullFlashAsync(e,t,r)]):[3,7];case 6:return o.sent(),[2,!1];case 7:throw s;case 8:return[3,9];case 9:return[3,12];case 10:return[4,this.dapwrapper.disconnectAsync()];case 11:return o.sent(),[7];case 12:return[2]}}))}))},e}();t.PartialFlashing=p}));
//# sourceMappingURL=partialFlashing.js.map
//# sourceMappingURL=partialFlashing.js.map
