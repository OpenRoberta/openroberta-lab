var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign.apply(this,arguments)};define(["require","exports","log","log","util.roberta","message","guiState.controller","galleryList.controller","program.model","userGroup.model","blockly","jquery","table","bootstrap-table"],(function(e,t,r,a,i,n,o,l,s,h,c,p,d){function u(e){for(var t=p("#relationsTable").bootstrapTable("getData"),a=0;a<t.length;a++)if(isNaN(e)||a==parseInt(e)){var l=JSON.parse(JSON.stringify(t[a].sharedWith));if((e=-1).right="NONE",!p("#checkRead"+a).is(":checked")||"User"===l.type&&o.isUserMemberOfUserGroup()&&l.label===o.getUserUserGroupOwner()||(e.right="READ"),p("#checkWrite"+a).is(":checked")&&(e.right="WRITE"),null===l.label){var h=p('#relationsTable tr[data-index="'+a+'"] .shareLabelInput').val();if(!h)continue;if("User"===l.type){if(h===t[a].owner){if(!isNaN(e))return void i.showMsgOnTop("ORA_USER_TO_SHARE_SAME_AS_LOGIN_USER");continue}(e=t.map((function(e){return null!==e.sharedWith?e.sharedWith.label:""})).indexOf(h))>=0&&(l=JSON.parse(JSON.stringify(t[e].sharedWith)))}l.label=h}e.right!==l.right&&(l.right=e.right,function(e,t,a,o){s.shareProgram(e.name,t,(function(l){"ok"===l.rc?(a&&(a.val(""),"UserGroup"===t.type&&a.find('option[value="'+t.label+'"]').remove(),o<0?p("#relationsTable").bootstrapTable("insertRow",{index:2,row:{name:e.name,owner:e.owner,sharedWith:t,read:t.right,write:t.right}}):p("#relationsTable").bootstrapTable("updateRow",{index:o,row:{name:e.name,owner:e.owner,sharedWith:t,read:t.right,write:t.right}})),n.displayMessage(l.message,"TOAST",t.label),r.info("share program "+e.name+" with '"+t.label+"'("+t.type+") having right '"+t.right+"'"),p("#progList").find('button[name="refresh"]').clickWrap()):i.showMsgOnTop(l.message)}))}(t[a],l,!1,updateRowIndex))}isNaN(e)&&p("#show-relations").modal("hide")}Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0,t.init=function(){!function(){p("#relationsTable").bootstrapTable({height:400,theadClasses:"table-dark",iconsPrefix:"typcn",icons:{paginationSwitchDown:"typcn-document-text",paginationSwitchUp:"typcn-book",refresh:"typcn-refresh"},columns:[{title:"Name",field:"name",visible:!1},{title:"Owner",field:"owner",visible:!1},{title:"<span lkey='Blockly.Msg.DATATABLE_SHARED_WITH'>"+(c.Msg.DATATABLE_SHARED_WITH||"Geteilt mit")+"</span>",field:"sharedWith",events:b,formatter:m},{title:"<span class='typcn typcn-eye'></span>",field:"read",events:g,width:"20px",halign:"center",valign:"middle",formatter:y},{title:"<span class='typcn typcn-pencil'></span>",field:"write",events:f,width:"20px",halign:"center",valign:"middle",formatter:w}]});var e={columns:[{sortable:!0,title:"",formatter:d.CardView.robot},{title:"",sortable:!0,formatter:d.CardView.name},{title:"",sortable:!0,formatter:d.CardView.programDescription},{title:"",sortable:!0,formatter:function(e){return d.CardView.titleLabel(e,"GALLERY_BY","cardViewInfo")}},{sortable:!0,title:"",formatter:function(e){return d.CardView.titleLabel(i.formatDate(e),"GALLERY_DATE","cardViewInfo")}},{title:"",formatter:function(e){return d.CardView.titleTypcn(e,"eye-outline")},sortable:!0},{title:"",formatter:function(e){return d.CardView.titleTypcn(e,"heart-full-outline")},sortable:!0},{title:"",sortable:!0,formatter:function(e,t){return d.CardView.programTags(t[2])}},{title:"",events:l.eventsLike,formatter:l.formatLike}],pagination:!1,rowAttributes:l.rowAttributes,height:410,search:!1},t=__assign(__assign({},d.CardView.options),e);p("#galleryPreview").bootstrapTable(t)}(),p("#show-relations").onWrap("updateAndShow",(function(e,t){return function(e){var t=e[0],r=null;p.isEmptyObject(e[2])||(r=e[2]),p("#show-relations h5").text(c.Msg.BUTTON_DO_SHARE+" »"+t+"«").end(),p("#show-relations").find(".modal-header>h5").text(c.Msg.BUTTON_DO_SHARE+" »"+t+"«").end(),p("#relationsTable").bootstrapTable("removeAll"),r&&p.each(r.sharedWith,(function(t,r){"User"===r.type&&"Gallery"===r.label||p("#relationsTable").bootstrapTable("insertRow",{index:-1,row:{name:e[0],owner:e[1],sharedWith:r,read:r.right,write:r.right}})})),p("#relationsTable").bootstrapTable("insertRow",{index:0,row:{name:e[0],owner:e[1],sharedWith:{label:null,type:"UserGroup",right:"NONE"},read:"READ",write:""}}),p("#relationsTable").bootstrapTable("insertRow",{index:0,row:{name:e[0],owner:e[1],sharedWith:{label:null,type:"User",right:"NONE"},read:"READ",write:""}}),p("#show-relations").oneWrap("shown.bs.modal",(function(e){p("#relationsTable").bootstrapTable("resetView"),p("#relationsTable").find("input :first").focus()})),p("#show-relations").modal("show")}(t),!1}),"show relations"),p("#share-with-gallery").onWrap("updateAndShow",(function(e,t){return function(e){var t=e[0],r=e[3];p("#share-with-gallery h5").html(""),p("#galleryPreview").html(""),p("#textShareGallery").html(""),p("#share-with-gallery").data("progName",t),p("#share-with-gallery").data("user",r),s.loadProgramFromListing(t,"Gallery",r,(function(r){"ok"===r.rc?n.displayInformation({rc:"error"},"GALLERY_SHARED_ALREADY","GALLERY_SHARED_ALREADY",t):(p("#textShareGallery").html(c.Msg.PROGLIST_SHARE_WITH_GALLERY),p("#share-with-gallery").data("action","add"),s.loadProgramEntity(t,o.getUserAccountName(),o.getUserAccountName(),(function(t){if("ok"===t.rc){var r=e[0];p("#share-with-gallery h5").text(c.Msg.BUTTON_DO_UPLOAD_GALLERY.replace("$",r)),p("#galleryPreview").bootstrapTable("load",new Array(t.program)),p(".infoTags").tagsinput(),p("#galleryPreview .bootstrap-tagsinput").addClass("galleryTags"),p("#galleryPreview").find(".galleryTags>input").attr("readonly","true"),p("#galleryPreview").find("span[data-role=remove]").addClass("hidden"),p("#share-with-gallery").modal("show")}})))}))}(t),!1}),"share with gallery"),p("#shareProgram").onWrap("click",(function(e){u()}),"ok click for share program"),p("#shareWithGallery").onWrap("click",(function(e){var t,a=p("#share-with-gallery .modal-body").find(">:first-child");a?a.show():p("#textShareGallery").show(),p("#share-with-gallery").data("action"),t=p("#share-with-gallery").data("progName"),s.shareProgramWithGallery(t,(function(e){"ok"===e.rc&&(r.info("share program "+t+" with Gallery"),p("#progList").find('button[name="refresh"]').clickWrap()),n.displayInformation(e,e.message,e.message,t)})),p("#share-with-gallery").modal("hide")}),"ok click for share with gallery"),p("#cancelShareWithGallery").onWrap("click",(function(e){var t=p("#share-with-gallery .modal-body").find(">:first-child");t?t.show():p("#textShareGallery").show(),p("#share-with-gallery").modal("hide")}),"ok click for cancel share with gallery")};var b={"click .addShare":function(e,t,r,a){u(a)}},g={"click #checkRead0":function(e){p(this).is(":checked")||p("#checkWrite0").prop("checked",!0)}},f={"click #checkWrite0":function(){p(this).is(":checked")||p("#checkRead0").prop("checked",!0)}},y=function(e,t,r){return null===t.sharedWith.label&&"UserGroup"===t.sharedWith.type||"User"===t.sharedWith.type&&o.isUserMemberOfUserGroup()&&o.getUserUserGroupOwner()===t.sharedWith.label?'<input type="checkbox" id="checkRead'+r+'" checked disabled>':"READ"===e?'<input type="checkbox" id="checkRead'+r+'" checked>':'<input type="checkbox" id="checkRead'+r+'">'},w=function(e,t,r){return"UserGroup"===t.sharedWith.type?'<input type="checkbox" id="checkWrite'+r+'" disabled>':"WRITE"===e?'<input type="checkbox" id="checkWrite'+r+'" checked>':'<input type="checkbox" id="checkWrite'+r+'">'},m=function(e,t,r){if(null===e||"object"!=typeof e)return a.error.log('unknown share format "'+typeof e+'"'),"";if(null===e.label){if("User"===e.type){var i=p('<div class="input-group"><label class="input-group-btn" for="shareWithUserInput"><button type="button" style="height:48px" class="btn disabled editor"><i class="typcn typcn-user"></i></button></label><span class="input-group-btn"><button class="addShare btn" type="button" style="height: 48px"><i class="typcn typcn-plus"></i></button></span><input class="shareLabelInput form-control" type="text" name="user.account" placeholder="'+c.Msg.SHARE_WITH_USER+'"/></div>');return p("<div></div>").append(i).html()}return"UserGroup"===e.type?(o.isUserMemberOfUserGroup()||h.loadUserGroupList((function(a){if("ok"==a.rc&&a.userGroups&&a.userGroups.length>0){var i=p("#relationsTable").bootstrapTable("getData").filter((function(e){return e.sharedWith&&"UserGroup"===e.sharedWith.type})).map((function(e){return e.sharedWith.label})),n=p('#relationsTable tr[data-index="'+r+'"] script').parent(),o=p('<td><div class="input-group"><label class="input-group-btn" for="shareWithUserGroupInput"><button type="button" style="height:48px" class="btn disabled editor"><i class="typcn typcn-group"></i></button></label><span class="input-group-btn"><button class="addShare btn" type="button" style="height: 48px"><i class="typcn typcn-plus"></i></button></span><select class="shareLabelInput form-control" name="userGroup.name"><option value="">'+c.Msg.SHARE_WITH_USERGROUP+"</option>"+a.userGroups.filter((function(e){return-1===i.indexOf(e.name)})).reduce((function(e,t){return e+'<option value="'+t.name+'">'+t.name+"</option>"}),"")+"</select></div></td>");p("#relationsTable").find('tr[data-index="'+r+'"]').show(),n.replaceWith(o[0]),Object.keys(b).forEach((function(a){if(b.hasOwnProperty(a)){var i=a.split(" ",2);n.find(i[1]).on(i[0],(function(i){b[a](i,e,t,r)}))}}))}})),"<script>$('#relationsTable').find('tr[data-index=\""+r+"\"]').hide();<\/script>"):(a.error.log("unknown share type"),"")}var n="warning-outline";return"User"===e.type?n="user":"UserGroup"===e.type&&(n="group"),'<span class="typcn typcn-'+n+'"></span> <span class="value">'+e.label+"</span>"}}));
//# sourceMappingURL=progShare.controller.js.map
//# sourceMappingURL=progShare.controller.js.map
