var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign.apply(this,arguments)};define(["require","exports","log","util.roberta","message","guiState.controller","galleryList.controller","program.model","userGroup.model","blockly","jquery","table","bootstrap-table"],(function(e,t,r,a,i,n,o,l,s,h,c,p){function d(e){for(var t=c("#relationsTable").bootstrapTable("getData"),o=0;o<t.length;o++)if(isNaN(e)||o==parseInt(e)){var s=JSON.parse(JSON.stringify(t[o].sharedWith)),h=!1;if(updateRowIndex=-1,right="NONE",!c("#checkRead"+o).is(":checked")||"User"===s.type&&n.isUserMemberOfUserGroup()&&s.label===n.getUserUserGroupOwner()||(right="READ"),c("#checkWrite"+o).is(":checked")&&(right="WRITE"),null===s.label){var p=(h=c('#relationsTable tr[data-index="'+o+'"] .shareLabelInput')).val();if(!p)continue;if("User"===s.type){if(p===t[o].owner){if(!isNaN(e))return void a.showMsgOnTop("ORA_USER_TO_SHARE_SAME_AS_LOGIN_USER");continue}updateRowIndex=t.map((function(e){return null!==e.sharedWith?e.sharedWith.label:""})).indexOf(p),updateRowIndex>=0&&(s=JSON.parse(JSON.stringify(t[updateRowIndex].sharedWith)))}s.label=p}right!==s.right&&(s.right=right,function(e,t,n,o){l.shareProgram(e.name,t,(function(l){"ok"===l.rc?(n&&(n.val(""),"UserGroup"===t.type&&n.find('option[value="'+t.label+'"]').remove(),o<0?c("#relationsTable").bootstrapTable("insertRow",{index:2,row:{name:e.name,owner:e.owner,sharedWith:t,read:t.right,write:t.right}}):c("#relationsTable").bootstrapTable("updateRow",{index:o,row:{name:e.name,owner:e.owner,sharedWith:t,read:t.right,write:t.right}})),i.displayMessage(l.message,"TOAST",t.label),r.info("share program "+e.name+" with '"+t.label+"'("+t.type+") having right '"+t.right+"'"),c("#progList").find('button[name="refresh"]').clickWrap()):a.showMsgOnTop(l.message)}))}(t[o],s,h,updateRowIndex))}isNaN(e)&&c("#show-relations").modal("hide")}Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0,t.init=function(){!function(){c("#relationsTable").bootstrapTable({height:400,theadClasses:"table-dark",iconsPrefix:"typcn",icons:{paginationSwitchDown:"typcn-document-text",paginationSwitchUp:"typcn-book",refresh:"typcn-refresh"},columns:[{title:"Name",field:"name",visible:!1},{title:"Owner",field:"owner",visible:!1},{title:"<span lkey='Blockly.Msg.DATATABLE_SHARED_WITH'>"+(h.Msg.DATATABLE_SHARED_WITH||"Geteilt mit")+"</span>",field:"sharedWith",events:u,formatter:w},{title:"<span class='typcn typcn-eye'></span>",field:"read",events:b,width:"20px",halign:"center",valign:"middle",formatter:f},{title:"<span class='typcn typcn-pencil'></span>",field:"write",events:g,width:"20px",halign:"center",valign:"middle",formatter:y}]});var e={columns:[{sortable:!0,title:"",formatter:p.CardView.robot},{title:"",sortable:!0,formatter:p.CardView.name},{title:"",sortable:!0,formatter:p.CardView.programDescription},{title:"",sortable:!0,formatter:function(e){return p.CardView.titleLabel(e,"GALLERY_BY","cardViewInfo")}},{sortable:!0,title:"",formatter:function(e){return p.CardView.titleLabel(a.formatDate(e),"GALLERY_DATE","cardViewInfo")}},{title:"",formatter:function(e){return p.CardView.titleTypcn(e,"eye-outline")},sortable:!0},{title:"",formatter:function(e){return p.CardView.titleTypcn(e,"heart-full-outline")},sortable:!0},{title:"",sortable:!0,formatter:function(e,t){return p.CardView.programTags(t[2])}},{title:"",events:o.eventsLike,formatter:o.formatLike}],rowAttributes:o.rowAttributes,height:410,search:!1},t=__assign(__assign({},p.CardView.options),e);c("#galleryPreview").bootstrapTable(t)}(),c("#show-relations").onWrap("updateAndShow",(function(e,t){return function(e){var t=e[0],r=null;c.isEmptyObject(e[2])||(r=e[2]),c("#show-relations h5").text(h.Msg.BUTTON_DO_SHARE+" »"+t+"«").end(),c("#show-relations").find(".modal-header>h5").text(h.Msg.BUTTON_DO_SHARE+" »"+t+"«").end(),c("#relationsTable").bootstrapTable("removeAll"),r&&c.each(r.sharedWith,(function(t,r){"User"===r.type&&"Gallery"===r.label||c("#relationsTable").bootstrapTable("insertRow",{index:-1,row:{name:e[0],owner:e[1],sharedWith:r,read:r.right,write:r.right}})})),c("#relationsTable").bootstrapTable("insertRow",{index:0,row:{name:e[0],owner:e[1],sharedWith:{label:null,type:"UserGroup",right:"NONE"},read:"READ",write:""}}),c("#relationsTable").bootstrapTable("insertRow",{index:0,row:{name:e[0],owner:e[1],sharedWith:{label:null,type:"User",right:"NONE"},read:"READ",write:""}}),c("#show-relations").oneWrap("shown.bs.modal",(function(e){c("#relationsTable").bootstrapTable("resetView"),c("#relationsTable").find("input :first").focus()})),c("#show-relations").modal("show")}(t),!1}),"show relations"),c("#share-with-gallery").onWrap("updateAndShow",(function(e,t){return function(e){var t=e[0],r=e[3];c("#share-with-gallery h5").html(""),c("#galleryPreview").html(""),c("#textShareGallery").html(""),c("#share-with-gallery").data("progName",t),c("#share-with-gallery").data("user",r),l.loadProgramFromListing(t,"Gallery",r,(function(r){"ok"===r.rc?i.displayInformation({rc:"error"},"GALLERY_SHARED_ALREADY","GALLERY_SHARED_ALREADY",t):(c("#textShareGallery").html(h.Msg.PROGLIST_SHARE_WITH_GALLERY),c("#share-with-gallery").data("action","add"),l.loadProgramEntity(t,n.getUserAccountName(),n.getUserAccountName(),(function(t){if("ok"===t.rc){var r=e[0];c("#share-with-gallery h5").text(h.Msg.BUTTON_DO_UPLOAD_GALLERY.replace("$",r)),c("#galleryPreview").bootstrapTable("load",new Array(t.program)),c(".infoTags").tagsinput(),c("#galleryPreview .bootstrap-tagsinput").addClass("galleryTags"),c("#galleryPreview").find(".galleryTags>input").attr("readonly","true"),c("#galleryPreview").find("span[data-role=remove]").addClass("hidden"),c("#share-with-gallery").modal("show")}})))}))}(t),!1}),"share with gallery"),c("#shareProgram").onWrap("click",(function(e){d()}),"ok click for share program"),c("#shareWithGallery").onWrap("click",(function(e){var t,a=c("#share-with-gallery .modal-body").find(">:first-child");a?a.show():c("#textShareGallery").show(),c("#share-with-gallery").data("action"),t=c("#share-with-gallery").data("progName"),l.shareProgramWithGallery(t,(function(e){"ok"===e.rc&&(r.info("share program "+t+" with Gallery"),c("#progList").find('button[name="refresh"]').clickWrap()),i.displayInformation(e,e.message,e.message,t)})),c("#share-with-gallery").modal("hide")}),"ok click for share with gallery"),c("#cancelShareWithGallery").onWrap("click",(function(e){var t=c("#share-with-gallery .modal-body").find(">:first-child");t?t.show():c("#textShareGallery").show(),c("#share-with-gallery").modal("hide")}),"ok click for cancel share with gallery")};var u={"click .addShare":function(e,t,r,a){d(a)}},b={"click #checkRead0":function(e){c(this).is(":checked")||c("#checkWrite0").prop("checked",!0)}},g={"click #checkWrite0":function(){c(this).is(":checked")||c("#checkRead0").prop("checked",!0)}},f=function(e,t,r){return null===t.sharedWith.label&&"UserGroup"===t.sharedWith.type||"User"===t.sharedWith.type&&n.isUserMemberOfUserGroup()&&n.getUserUserGroupOwner()===t.sharedWith.label?'<input type="checkbox" id="checkRead'+r+'" checked disabled>':"READ"===e?'<input type="checkbox" id="checkRead'+r+'" checked>':'<input type="checkbox" id="checkRead'+r+'">'},y=function(e,t,r){return"UserGroup"===t.sharedWith.type?'<input type="checkbox" id="checkWrite'+r+'" disabled>':"WRITE"===e?'<input type="checkbox" id="checkWrite'+r+'" checked>':'<input type="checkbox" id="checkWrite'+r+'">'},w=function(e,t,r){if(null===e||"object"!=typeof e)return error.log('unknown share format "'+typeof e+'"'),"";if(null===e.label){if("User"===e.type){var a=c('<div class="input-group"><label class="input-group-btn" for="shareWithUserInput"><button type="button" style="height:48px" class="btn disabled editor"><i class="typcn typcn-user"></i></button></label><span class="input-group-btn"><button class="addShare btn" type="button" style="height: 48px"><i class="typcn typcn-plus"></i></button></span><input class="shareLabelInput form-control" type="text" name="user.account" placeholder="'+h.Msg.SHARE_WITH_USER+'"/></div>');return c("<div></div>").append(a).html()}return"UserGroup"===e.type?(n.isUserMemberOfUserGroup()||s.loadUserGroupList((function(a){if("ok"==a.rc&&a.userGroups&&a.userGroups.length>0){var i=c("#relationsTable").bootstrapTable("getData").filter((function(e){return e.sharedWith&&"UserGroup"===e.sharedWith.type})).map((function(e){return e.sharedWith.label})),n=c('#relationsTable tr[data-index="'+r+'"] script').parent(),o=c('<td><div class="input-group"><label class="input-group-btn" for="shareWithUserGroupInput"><button type="button" style="height:48px" class="btn disabled editor"><i class="typcn typcn-group"></i></button></label><span class="input-group-btn"><button class="addShare btn" type="button" style="height: 48px"><i class="typcn typcn-plus"></i></button></span><select class="shareLabelInput form-control" name="userGroup.name"><option value="">'+h.Msg.SHARE_WITH_USERGROUP+"</option>"+a.userGroups.filter((function(e){return-1===i.indexOf(e.name)})).reduce((function(e,t){return e+'<option value="'+t.name+'">'+t.name+"</option>"}),"")+"</select></div></td>");c("#relationsTable").find('tr[data-index="'+r+'"]').show(),n.replaceWith(o[0]),Object.keys(u).forEach((function(a){if(u.hasOwnProperty(a)){var i=a.split(" ",2);n.find(i[1]).on(i[0],(function(i){u[a](i,e,t,r)}))}}))}})),"<script>$('#relationsTable').find('tr[data-index=\""+r+"\"]').hide();<\/script>"):(error.log("unknown share type"),"")}var i="warning-outline";return"User"===e.type?i="user":"UserGroup"===e.type&&(i="group"),'<span class="typcn typcn-'+i+'"></span> <span class="value">'+e.label+"</span>"}}));
//# sourceMappingURL=progShare.controller.js.map
//# sourceMappingURL=progShare.controller.js.map
