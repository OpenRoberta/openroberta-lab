define(["require","exports","message","util.roberta","user.model","guiState.controller","jquery","blockly"],(function(e,r,s,o,n,a,i,t){var l,u,g,d,c,m,f,A,p,F,I,v,_;Object.defineProperty(r,"__esModule",{value:!0}),r.initValidationMessages=r.showResetPassword=r.showUserInfo=r.showDeleteUserModal=r.showUserGroupLoginForm=r.showLoginForm=r.showUserDataForm=r.init=r.logout=r.activateAccount=void 0;var D=300,E=150;function h(){u.validate(),u.valid()&&n.login(i("#loginAccountName").val().toString(),i("#loginPassword").val().toString(),(function(e){"ok"===e.rc&&(a.setLogin(e),1===e.userId&&i("#menuNotificationWrap").removeClass("hidden")),s.displayInformation(e,"MESSAGE_USER_LOGIN",e.message,a.getUserName())}))}function L(){n.logout((function(e){o.response(e),"ok"===e.rc&&(a.isUserMemberOfUserGroup()&&i("#menuDeleteUser, #menuGroupPanel").parent().removeClass("unavailable"),a.setLogout()),s.displayInformation(e,"MESSAGE_USER_LOGOUT",e.message,a.getUserName())}))}function N(){m.validate(),m.valid()&&n.deleteUserOnServer(a.getUserAccountName(),i("#singleModalInput").val().toString(),(function(e){"ok"===e.rc&&L(),s.displayInformation(e,e.message,e.message,a.getUserAccountName())}))}function U(){u.removeData("validator"),i.validator.addMethod("loginRegex",(function(e,r){return this.optional(r)||/^[a-zA-Z0-9=+!?.,%#+&^@_\- ]+$/gi.test(e)}),"This field contains nonvalid symbols."),u.validate({rules:{loginAccountName:{required:!0,loginRegex:!0},loginPassword:{required:!0}},errorClass:"form-invalid",errorPlacement:function(e,r){e.insertBefore(r.parent())},messages:{loginAccountName:{required:t.Msg.VALIDATION_FIELD_REQUIRED,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},loginPassword:{required:t.Msg.VALIDATION_FIELD_REQUIRED}}})}function R(){d.removeData("validator"),i.validator.addMethod("emailRegex",(function(e,r){return this.optional(r)||/^([a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+(\.[a-z\d!#$%&'*+\-\/=?^_`{|}~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)*|"((([ \t]*\r\n)?[ \t]+)?([\x01-\x08\x0b\x0c\x0e-\x1f\x7f\x21\x23-\x5b\x5d-\x7e\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|\\[\x01-\x09\x0b\x0c\x0d-\x7f\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))*(([ \t]*\r\n)?[ \t]+)?")@(([a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\d\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.)+([a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]|[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF][a-z\d\-._~\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]*[a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])\.?$/i.test(e)}),"This field must contain a valid email adress."),i.validator.addMethod("loginRegex",(function(e,r){return this.optional(r)||/^[a-zA-Z0-9=+!?.,%#+&^@_\- ]+$/gi.test(e)}),"This field must contain only letters, numbers, or dashes."),d.validate({rules:{registerAccountName:{required:!0,maxlength:25,loginRegex:!0},registerPass:{required:!0,minlength:6},registerPassConfirm:{required:!0,equalTo:"#registerPass"},registerUserName:{required:!1,maxlength:25,loginRegex:!0},registerUserEmail:{required:!1,emailRegex:!0},registerUserAge:{required:function(e){return""!=i("#registerUserEmail").val()}}},onfocusout:!1,errorClass:"form-invalid",errorPlacement:function(e,r){e.insertBefore(r.parent())},showErrors:function(e,r){if(r.length){var s=r.shift();this.errorList=[s]}this.defaultShowErrors()},messages:{registerAccountName:{required:t.Msg.VALIDATION_FIELD_REQUIRED,maxlength:t.Msg.VALIDATION_MAX_LENGTH,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},registerPass:{required:t.Msg.VALIDATION_FIELD_REQUIRED,minlength:t.Msg.VALIDATION_PASSWORD_MIN_LENGTH},registerPassConfirm:{required:t.Msg.VALIDATION_FIELD_REQUIRED,equalTo:t.Msg.VALIDATION_SECOND_PASSWORD_EQUAL},registerUserName:{required:jQuery.validator.format(t.Msg.VALIDATION_FIELD_REQUIRED),maxlength:t.Msg.VALIDATION_MAX_LENGTH,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},registerUserEmail:{required:t.Msg.VALIDATION_FIELD_REQUIRED,emailRegex:t.Msg.VALIDATION_VALID_EMAIL_ADDRESS},registerUserAge:{required:t.Msg.VALIDATION_FIELD_REQUIRED}}})}function w(){g.removeData("validator"),g.validate({rules:{lost_email:{required:!0,email:!0}},errorClass:"form-invalid",errorPlacement:function(e,r){e.insertBefore(r.parent())},messages:{lost_email:{required:t.Msg.VALIDATION_FIELD_REQUIRED,email:t.Msg.VALIDATION_VALID_EMAIL_ADDRESS}}})}function O(e,r){e.fadeToggle(D,(function(){r.fadeToggle()}))}function P(e,r){e.addClass("hidden"),r.removeClass("hidden")}function C(){d.off("submit"),d.onWrap("submit",(function(e){e.preventDefault(),d.validate(),d.valid()&&n.createUserToServer(i("#registerAccountName").val(),i("#registerUserName").val(),i("#registerUserEmail").val(),i("#registerPass").val(),i("#registerUserAge").val(),a.getLanguage(),(function(e){"ok"===e.rc&&(i("#loginAccountName").val(i("#registerAccountName").val()),i("#loginPassword").val(i("#registerPass").val()),h()),s.displayInformation(e,e.message,e.message,i("#registerAccountName").val())}))}),"submit registration data"),i("#registerUser").text(t.Msg.POPUP_REGISTER_USER),i("#registerAccountName").prop("disabled",!1),i("#userInfoLabel").addClass("hidden"),a.isPublicServerVersion()||i("#fgUserAge").addClass("hidden"),i("#fgRegisterPass").show(),i("#fgRegisterPassConfirm").show(),i("#showChangeUserPassword").addClass("hidden"),i("#resendActivation").addClass("hidden"),i("#register_login_btn").show(),i("#register_lost_btn").show()}function M(){i("#login-user").onWrap("hidden.bs.modal",(function(){u.validate().resetForm(),g.validate().resetForm(),d.validate().resetForm(),i("#register-form .hint").hide(),l.find("input").val(""),i("#registerUserAge").val("none")})),g.onWrap("submit",(function(e){e.preventDefault(),g.validate(),g.valid()&&n.userPasswordRecovery(i("#lost_email").val().toString(),a.getLanguage(),(function(e){s.displayInformation(e,e.message,e.message)}))}),"submit password recovery data"),u.onWrap("submit",(function(e){e.preventDefault(),h()}),"submit login data"),i("#register-form input.form-control, #register-form select.form-control").focus((function(e){var r=i(this).parent().next(".hint");i("#register-form .hint").not(r).slideUp(E),r.slideDown(E)})),i("#registerUserEmail").on("change paste keyup",(function(){""==i("#registerUserEmail").val()?i("#fgUserAge").fadeOut():i("#fgUserAge").fadeIn()})),i("#login_register_btn").onWrap("click",(function(){C(),P(f,A),O(u,d),o.setFocusOnElement(i("#registerAccountName"))}),"login_register_btn"),i("#register_login_btn").onWrap("click",(function(){P(A,f),O(d,u),o.setFocusOnElement(i("#loginAccountName"))}),"register_login_btn"),i("#login_lost_btn").onWrap("click",(function(){P(f,p),O(u,g),o.setFocusOnElement(i("#lost_email"))}),"login_lost_btn"),i("#lost_login_btn").onWrap("click",(function(){P(p,f),O(g,u),o.setFocusOnElement(i("#loginAccountName"))}),"lost_login_btn"),i("#lost_register_btn").onWrap("click",(function(){P(p,A),O(g,d),o.setFocusOnElement(i("#registerAccountName"))}),"lost_register_btn"),i("#register_lost_btn").onWrap("click",(function(){P(A,p),O(d,g),o.setFocusOnElement(i("#lost_email"))}),"register_lost_btn"),U(),R(),w()}function S(){i("#usergroupLoginPopup").onWrap("hidden.bs.modal",(function(){F.validate().resetForm(),F.find("input, select").val("")})),F.onWrap("submit",(function(e){e.preventDefault(),function(){if(F.validate(),F.valid()){for(var e=F.serializeArray(),r={},o=0;o<e.length;o++)void 0!==e[o].name&&void 0!==e[o].value&&(r[e[o].name]=e[o].value);n.loginUserGroup(r.userGroupOwner,r.userGroupName,r.userGroupName+":"+r.accountName,r.password,(function(e){"ok"===e.rc?(i("#menuDeleteUser, #menuGroupPanel").parent().addClass("unavailable"),a.setLogin(e),s.displayInformation(e,"MESSAGE_USER_LOGIN",e.message,a.getUserName()),r.password===r.userGroupName+":"+r.accountName&&(i("#passOld").val(r.password),i("#grOldPassword").hide(),i("#change-user-password").modal("show"))):s.displayInformation(e,"MESSAGE_USER_LOGIN",e.message,a.getUserName())}))}}()})),F.find("input, select").focus((function(e){var r=i(this).parent().next(".hint");F.find(".hint").not(r).slideUp(E),r.slideDown(E)})),i("#lostPasswordUsergroupLogin").onWrap("click",(function(){P(v,_),O(F,I),o.setFocusOnElement(I)})),i("#loginUsergroupLogin").onWrap("click",(function(){P(_,v),O(I,F),o.setFocusOnElement(i("#usergroupLoginOwner"))})),F.removeData("validator"),i.validator.addMethod("loginRegex",(function(e,r){return this.optional(r)||/^[a-zA-Z0-9=+!?.,%#+&^@_\- ]+$/gi.test(e)}),"This field contains nonvalid symbols."),F.validate({rules:{usergroupLoginOwner:{required:!0,loginRegex:!0},usergroupLoginUserGroup:{required:!0},usergroupLoginAccount:{required:!0,loginRegex:!0},usergroupLoginPassword:{required:!0}},errorClass:"form-invalid",errorPlacement:function(e,r){e.insertBefore(r.parent())},messages:{usergroupLoginOwner:{required:t.Msg.VALIDATION_FIELD_REQUIRED,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},usergroupLoginUserGroup:{required:t.Msg.VALIDATION_FIELD_REQUIRED},loginAccountName:{required:t.Msg.VALIDATION_FIELD_REQUIRED,loginRegex:t.Msg.VALIDATION_CONTAINS_SPECIAL_CHARACTERS},loginPassword:{required:t.Msg.VALIDATION_FIELD_REQUIRED}}})}function T(){c.onWrap("submit",(function(e){var r;e.preventDefault(),r=i("#resetPassLink").val(),c.validate(),c.valid()&&(r?n.resetPasswordToServer(r.toString(),i("#passNew").val().toString(),(function(e){"ok"===e.rc?(i("#change-user-password").modal("hide"),i("#resetPassLink").val(void 0),s.displayMessage(e.message,"TOAST","")):s.displayInformation(e,"",e.message)})):n.updateUserPasswordToServer(a.getUserAccountName(),i("#passOld").val().toString(),i("#passNew").val().toString(),(function(e){"ok"===e.rc&&i("#change-user-password").modal("hide"),s.displayInformation(e,"",e.message)})))})),i("#showChangeUserPassword").onWrap("click",(function(){i("#change-user-password").modal("show")})),i("#resendActivation").onWrap("click",(function(){n.userSendAccountActivation(a.getUserAccountName(),a.getLanguage(),(function(e){s.displayInformation(e,e.message,e.message)}))})),i("#change-user-password").onWrap("hidden.bs.modal",(function(){c.validate().resetForm(),i("#grOldPassword").show(),i("#passOld").val(""),i("#passNew").val(""),i("#passNewRepeat").val("")})),c.removeData("validator"),c.validate({rules:{passOld:"required",passNew:{required:!0,minlength:6},passNewRepeat:{required:!0,equalTo:"#passNew"}},errorClass:"form-invalid",errorPlacement:function(e,r){e.insertBefore(r.parent())},messages:{passOld:{required:t.Msg.VALIDATION_FIELD_REQUIRED},passNew:{required:t.Msg.VALIDATION_FIELD_REQUIRED,minlength:t.Msg.VALIDATION_PASSWORD_MIN_LENGTH},passNewRepeat:{required:t.Msg.VALIDATION_FIELD_REQUIRED,equalTo:t.Msg.VALIDATION_SECOND_PASSWORD_EQUAL}}})}function b(){i("#loggedIn").text(a.getUserAccountName()),a.isUserLoggedIn()?i("#popup_username").text(t.Msg.POPUP_USERNAME+": "):i("#popup_username").text(t.Msg.POPUP_USERNAME_LOGOFF),i("#programName").text(a.getProgramName()),i("#configurationName").text(a.getConfigurationName()),"beginner"===a.getProgramToolboxLevel()?i("#toolbox").text(t.Msg.MENU_BEGINNER):i("#toolbox").text(t.Msg.MENU_EXPERT),i("#show-state-info").modal("show")}r.activateAccount=function(e){n.userActivateAccount(e,(function(e){s.displayInformation(e,e.message,e.message)}))},r.logout=L,r.init=function(){var e=i.Deferred();return i.when(n.clear((function(e){o.response(e)}))).then((function(){l=i("#div-login-forms"),u=i("#login-form"),g=i("#lost-form"),d=i("#register-form"),c=i("#change-user-password-form"),m=i("#single-modal-form"),f=i("#loginLabel"),A=i("#registerInfoLabel"),p=i("#forgotPasswordLabel"),F=i("#loginUsergroupLoginForm"),I=i("#lostPasswordUsergroupLoginArticle"),v=i("#loginUsergroupLoginTitle"),_=i("#lostPasswordUsergroupLoginTitle"),i("#iconDisplayLogin").onWrap("click",(function(){b()}),"icon user click"),M(),S(),T(),e.resolve()})),e.promise()},r.showUserDataForm=function(){n.getUserFromServer(a.getUserAccountName(),(function(e){"ok"===e.rc&&(i("#registerAccountName").val(e.userAccountName),i("#registerUserEmail").val(e.userEmail),i("#registerUserName").val(e.userName),i("#registerUserAge").val(e.isYoungerThen14?1:2))})),d.off("submit"),d.onWrap("submit",(function(e){e.preventDefault(),a.isUserMemberOfUserGroup()?i("#login-user").modal("hide"):(d.validate(),d.valid()&&n.updateUserToServer(a.getUserAccountName(),i("#registerUserName").val(),i("#registerUserEmail").val(),i("#registerUserAge").val(),a.getLanguage(),(function(e){"ok"===e.rc&&n.getUserFromServer((function(e){"ok"===e.rc&&a.setLogin(e)})),s.displayInformation(e,e.message,e.message)})))})),i("#registerUser").text("OK"),i("#registerAccountName").prop("disabled",!0),i("#userInfoLabel").removeClass("hidden"),i("#loginLabel").addClass("hidden"),i("#registerInfoLabel").addClass("hidden"),i("#forgotPasswordLabel").addClass("hidden"),i("#fgRegisterPass").hide(),i("#fgRegisterPassConfirm").hide(),i("#register_login_btn").hide(),i("#showChangeUserPassword").removeClass("hidden"),a.isPublicServerVersion()&&i("#resendActivation").removeClass("hidden"),i("#register_lost_btn").hide(),u.hide(),d.show(),a.isUserMemberOfUserGroup()?i("#change-user-password").modal("show"):i("#login-user").modal("show")},r.showLoginForm=function(){i("#userInfoLabel").addClass("hidden"),i("#registerInfoLabel").addClass("hidden"),i("#forgotPasswordLabel").addClass("hidden"),u.show(),g.hide(),d.hide(),i("#login-user").modal("show")},r.showUserGroupLoginForm=function(){i("#lostPasswordUsergroupLoginTitle").addClass("hidden"),F.show(),I.hide(),i("#usergroupLoginPopup").modal("show")},r.showDeleteUserModal=function(){o.showSingleModal((function(){i("#singleModalInput").attr("type","password"),i("#single-modal h5").text(t.Msg.MENU_DELETE_USER),i("#single-modal label").text(t.Msg.POPUP_PASSWORD),i("#single-modal span").removeClass("typcn-pencil"),i("#single-modal span").addClass("typcn-lock-closed")}),N,(function(){i("#single-modal span").addClass("typcn-pencil"),i("#single-modal span").removeClass("typcn-lock-closed")}),{rules:{singleModalInput:{required:!0}},errorClass:"form-invalid",errorPlacement:function(e,r){e.insertBefore(r.parent())},messages:{singleModalInput:{required:jQuery.validator.format(t.Msg.VALIDATION_FIELD_REQUIRED)}}})},r.showUserInfo=b,r.showResetPassword=function(e){n.checkTargetRecovery(e,(function(r){"ok"===r.rc?(i("#passOld").val(e),i("#resetPassLink").val(e),i("#grOldPassword").hide(),i("#change-user-password").modal("show")):(r.rc="error",s.displayInformation(r,"",r.message))}))},r.initValidationMessages=function(){U(),R(),w()}}));
//# sourceMappingURL=user.controller.js.map
//# sourceMappingURL=user.controller.js.map
