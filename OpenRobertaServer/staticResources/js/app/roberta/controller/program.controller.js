define(["require","exports","message","log","util.roberta","guiState.controller","robot.controller","nn.controller","program.model","user.model","configuration.controller","blockly","jquery","aceEditor","jquery-validate"],(function(o,e,r,a,t,n,i,s,l,g,m,c,d,f){var u,p;Object.defineProperty(e,"__esModule",{value:!0}),e.programToBlocklyWorkspace=e.loadExternalToolbox=e.loadToolbox=e.resetView=e.reloadView=e.reloadProgram=e.getBlocklyWorkspace=e.exportAllXml=e.exportXml=e.linkProgram=e.newProgram=e.initProgramEnvironment=e.showSaveAsModal=e.initProgramForms=e.loadFromGallery=e.saveToServer=e.init=e.getPassword=e.setPassword=e.getSSID=e.setSSID=void 0;var P=!0,v=!0,b="",h="";function A(){return b}function S(){return h}function C(){d(".modal").modal("hide");var o=c.Xml.workspaceToDom(p),e=c.Xml.domToText(o),t=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,i=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0;l.saveProgramToServer(n.getProgramName(),n.getProgramOwnerName(),e,t,i,n.getProgramTimestamp(),(function(o){"ok"===o.rc&&(n.setProgramTimestamp(o.lastChanged),n.setProgramSaved(!0),n.setConfigurationSaved(!0),a.info("save program "+n.getProgramName())),r.displayInformation(o,"MESSAGE_EDIT_SAVE_PROGRAM",o.message,n.getProgramName())}))}function T(){if(u.validate(),u.valid()){d(".modal").modal("hide");var o=d("#singleModalInput").val().trim(),e=c.Xml.workspaceToDom(p),t=c.Xml.domToText(e),i=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,s=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0,g=n.getUserAccountName();a.info("saveAs program "+n.getProgramName()),l.saveAsProgramToServer(o,g,t,i,s,n.getProgramTimestamp(),(function(e){if("ok"===e.rc)a.info("saved program "+n.getProgramName()+" as "+o),e.name=o,e.programShared=!1,n.setProgram(e,g,g),r.displayInformation(e,"MESSAGE_EDIT_SAVE_PROGRAM_AS",e.message,n.getProgramName());else if("ORA_PROGRAM_SAVE_AS_ERROR_PROGRAM_EXISTS"===e.cause){var m=e.lastChanged,f=c.Msg.POPUP_BACKGROUND_REPLACE||"A program with the same name already exists! <br> Would you like to replace it?";d("#show-message-confirm").oneWrap("shown.bs.modal",(function(e){d("#confirm").off(),d("#confirm").onWrap("click",(function(e){e.preventDefault(),l.saveProgramToServer(o,g,t,i,s,m,(function(e){"ok"===e.rc?(a.info("saved program "+n.getProgramName()+" as "+o+" and overwrote old content"),e.name=o,n.setProgram(e,g,g),r.displayInformation(e,"MESSAGE_EDIT_SAVE_PROGRAM_AS",e.message,n.getProgramName())):(a.info("failed to overwrite "+o),r.displayMessage(e.message,"POPUP",""))}))}),"confirm modal"),d("#confirmCancel").off(),d("#confirmCancel").onWrap("click",(function(o){o.preventDefault(),d(".modal").modal("hide")}),"cancel modal")})),r.displayPopupMessage("ORA_PROGRAM_SAVE_AS_ERROR_PROGRAM_EXISTS",f,c.Msg.POPUP_REPLACE,c.Msg.POPUP_CANCEL)}}))}}function w(){u=d("#single-modal-form"),d("#buttonCancelFirmwareUpdateAndRun").onWrap("click",(function(){start()}),"cancel firmware update and run")}function y(){var o,e;d(window).width()<768?(o=d(window).width()/50,e=25):(o=d(window).width()/5,e=50),_(n.getProgramProg());var r=p.getTopBlocks(!0);if(r[0]){var a=r[0].getRelativeToSurfaceXY();r[0].moveBy(o-a.x,e-a.y)}}function x(o){var e;o||!1||n.isProgramSaved()?(e={rc:"ok",name:"NEPOprog",programShared:!1,lastChanged:""},n.setProgram(e),y(),s.programWasReplaced(),a.info("New program loaded")):(d("#show-message-confirm").oneWrap("shown.bs.modal",(function(o){d("#confirm").off(),d("#confirm").on("click",(function(o){o.preventDefault(),x(!0)})),d("#confirmCancel").off(),d("#confirmCancel").on("click",(function(o){o.preventDefault(),d(".modal").modal("hide")}))})),n.isUserLoggedIn()?r.displayMessage("POPUP_BEFOREUNLOAD_LOGGEDIN","POPUP","",!0):r.displayMessage("POPUP_BEFOREUNLOAD","POPUP","",!0))}function E(o,e){var r;o?(r=o.progXML,d.isEmptyObject(o.confAnnos)||(n.confAnnos=o.confAnnos,t.alertTab("tabConfiguration"))):r=n.getProgramXML(),_(r,e)}function M(){if("tabProgram"==n.getView()){var o=c.Xml.workspaceToDom(p);_(c.Xml.domToText(o));var e=n.getProgramToolbox();p.updateToolbox(e),v=!0}else v=!1}function k(o){n.setProgramToolboxLevel(o);var e=n.getToolbox(o);e&&p.updateToolbox(e),"beginner"===o?d(".help.expert").hide():d(".help.expert").show()}function _(o,e){if(o){P=!1,p.clear();var r=c.Xml.textToDom(o,p);c.Xml.domToWorkspace(r,p),p.setVersion(r.getAttribute("xmlversion")),d("#infoContent").html(p.description),"string"==typeof p.description&&p.description.length?d("#infoButton").addClass("notEmpty"):d("#infoButton").removeClass("notEmpty");var a=p.tags;d("#infoTags").tagsinput("removeAll"),d(".bootstrap-tagsinput input").attr("placeholder","Tags"),d("#infoTags").tagsinput("add",a);n.getConfigurationXML(),r=c.Xml.workspaceToDom(p);var t=c.Xml.domToText(r),i=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,s=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0;n.setProgramSaved(!0);var g=n.getLanguage();d("#codeDiv").hasClass("rightActive")&&e&&l.showSourceProgram(n.getProgramName(),i,t,s,g,A(),S(),(function(o){f.setViewCode(o.sourceCode)})),setTimeout((function(){P=!0}),500)}}e.setSSID=function(o){b=o},e.getSSID=A,e.setPassword=function(o){h=o},e.getPassword=S,e.init=function(){var o;o=n.getProgramToolbox(),p=c.inject(document.getElementById("blocklyDiv"),{path:"/blockly/",toolbox:o,trashcan:!0,scrollbars:!0,media:"../blockly/media/",zoom:{controls:!0,wheel:!1,startScale:1,maxScale:4,minScale:.25,scaleSpeed:1.1},variableDeclaration:!0,robControls:!0,theme:n.getTheme()}),d(window).resize(),p.setDevice({group:n.getRobotGroup(),robot:n.getRobot()}),n.setBlocklyWorkspace(p),p.robControls.disable("saveProgram"),p.robControls.refreshTooltips(n.getRobotRealName()),n.checkSim(),d("#program").find(".blocklyToolboxDiv:first").wrap("<div id='toolboxDiv' style='position: absolute;'></div>"),d("#toolboxDiv").prepend('<ul class="nav nav-tabs levelTabs"><li class="nav-item"><a class="nav-link typcn typcn-media-stop-outline active beginner" href="#beginner" data-bs-toggle="tab">1</a></li><li class="nav-item"><a href="#expert" class="nav-link typcn typcn-star-outline expert" data-bs-toggle="tab">2</a></li></ul>'),y(),d("#sliderDiv").draggable({axis:"x",cursor:"col-resize"}),d("#tabProgram").onWrap("click",(function(o){if(o.preventDefault(),"tabConfiguration"===n.getView()&&n.isUserLoggedIn()&&!n.isConfigurationSaved()&&!n.isConfigurationAnonymous())return d("#show-message-confirm").oneWrap("shown.bs.modal",(function(o){d("#confirm").off(),d("#confirm").on("click",(function(o){o.preventDefault(),n.setConfigurationName(""),d("#tabProgram").tabWrapShow()})),d("#confirmCancel").off(),d("#confirmCancel").on("click",(function(o){o.preventDefault(),d(".modal").modal("hide")}))})),r.displayMessage("POPUP_CONFIGURATION_UNSAVED","POPUP","",!0),!1;d("#tabProgram").tabWrapShow()})),d("#tabProgram").onWrap("show.bs.tab",(function(o){n.setView("tabProgram")})),d("#tabProgram").onWrap("shown.bs.tab",(function(o){p.markFocused(),p.setVisible(!0),v||M(),d(window).resize()})),d("#tabProgram").onWrap("hide.bs.tab",(function(o){v=!1})),d("#tabProgram").onWrap("hidden.bs.tab",(function(o){p.setVisible(!1)})),d(".expert, .beginner").onWrap("click",(function(o){var e=d(o.target).attr("href")&&d(o.target).attr("href").substring(1)||d(o.target.parentElement).attr("href")&&d(o.target.parentElement).attr("href").substring(1);d('.levelTabs a[href="'+e+'"]').tabWrapShow(),o.preventDefault(),k(e),o.stopPropagation(),a.info("toolbox clicked, switched to "+e)})),c.bindEvent_(p.robControls.saveProgram,"mousedown",null,(function(o){return a.info("saveProgram from blockly button"),C(),!1})),p.robControls.disable("saveProgram"),p.addChangeListener((function(o){if(P&&o.type!=c.Events.UI&&n.isProgramSaved()&&n.setProgramSaved(!1),o.type===c.Events.DELETE&&0===p.getAllBlocks().length&&x(!0),d(".selectedHelp").removeClass("selectedHelp"),c.selected&&d("#blocklyDiv").hasClass("rightActive")){var e=c.selected.type;d("#"+e).addClass("selectedHelp"),d("#helpContent").scrollTo("#"+e,1e3,{offset:-10})}return!1})),w()},e.saveToServer=C,e.loadFromGallery=function(o){var e,a=o[1],t=o[3],s=o[0];e=s===n.getRobotGroup()?n.getRobot():n.findRobot(s);var g="Gallery";i.switchRobot(e,{},!1,(function(){l.loadProgramFromListing(a,g,t,(function(o){"ok"===o.rc&&(o.programShared="READ",o.name=a,n.setProgram(o,g,t),n.setProgramXML(o.progXML),void 0===o.configName?void 0===o.confXML?(n.setConfigurationNameDefault(),n.setConfigurationXML(n.getConfigurationConf())):(n.setConfigurationName(""),n.setConfigurationXML(o.confXML)):(n.setConfigurationName(o.configName),n.setConfigurationXML(o.confXML)),d("#tabProgram").oneWrap("shown.bs.tab",(function(o){m.reloadConf(),E()})),d("#tabProgram").tabWrapShow()),r.displayInformation(o,"",o.message)}))}))},e.initProgramForms=w,e.showSaveAsModal=function(){d.validator.addMethod("regex",(function(o,e,r){return(o=o.trim()).match(r)}),"No special Characters allowed here. Use only upper and lowercase letters (A through Z; a through z) and numbers."),t.showSingleModal((function(){d("#singleModalInput").attr("type","text"),d("#single-modal h5").text(c.Msg.MENU_SAVE_AS),d("#single-modal label").text(c.Msg.POPUP_NAME)}),T,(function(){}),{rules:{singleModalInput:{required:!0,regex:/^[a-zA-Z_öäüÖÄÜß$€][a-zA-Z0-9_öäüÖÄÜß$€]{0,254}$/}},errorClass:"form-invalid",errorPlacement:function(o,e){o.insertAfter(e)},messages:{singleModalInput:{required:c.Msg.VALIDATION_FIELD_REQUIRED,regex:c.Msg.MESSAGE_INVALID_NAME}}})},e.initProgramEnvironment=y,e.newProgram=x,e.linkProgram=function(){var o=c.Xml.workspaceToDom(p),e=c.Xml.domToText(o);e='<export xmlns="http://de.fhg.iais.roberta.blockly"><program>'+e+"</program><config>"+n.getConfigurationXML()+"</config></export>";var t=new URL(document.location),i=t.protocol+"//"+t.host+"?loadSystem=";i+=n.getRobot(),i+="&loadProgram="+e,i=encodeURI(i);var s=d("<input>");d("body").append(s),s.val(i).select(),document.execCommand("copy"),s.remove();var l='</br><textarea readonly style="width:100%;" type="text">'+i+"</textarea>";a.info("ProgramLinkShare"),r.displayMessage("POPUP_GET_LINK","POPUP",l)},e.exportXml=function(){var o=c.Xml.workspaceToDom(p),e='<export xmlns="http://de.fhg.iais.roberta.blockly"><program>'+c.Xml.domToText(o)+"</program><config>"+n.getConfigurationXML()+"</config></export>";a.info("ProgramExport"),t.download(n.getProgramName()+".xml",e),r.displayMessage("MENU_MESSAGE_DOWNLOAD","TOAST",n.getProgramName())},e.exportAllXml=function(){g.userLoggedInCheck((function(o){"ok"===o.rc?l.exportAllProgramsXml():r.displayMessage(o.cause,"TOAST","Log in check failed for Export")}))},e.getBlocklyWorkspace=function(){return p},e.reloadProgram=E,e.reloadView=M,e.resetView=function(){p.setDevice({group:n.getRobotGroup(),robot:n.getRobot()}),y();var o=n.getProgramToolbox();p.updateToolbox(o)},e.loadToolbox=k,e.loadExternalToolbox=function(o){o&&p.updateToolbox(o)},e.programToBlocklyWorkspace=_}));
//# sourceMappingURL=program.controller.js.map
//# sourceMappingURL=program.controller.js.map
