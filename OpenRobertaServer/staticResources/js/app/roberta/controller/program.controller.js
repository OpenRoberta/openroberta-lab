define(["require","exports","message","log","util.roberta","guiState.controller","robot.controller","nn.controller","program.model","user.model","configuration.controller","progCode.controller","blockly","jquery","jquery-validate"],(function(o,e,r,a,t,n,i,s,l,g,m,c,d,f){var u,p;Object.defineProperty(e,"__esModule",{value:!0}),e.programToBlocklyWorkspace=e.loadExternalToolbox=e.loadToolbox=e.resetView=e.reloadView=e.reloadProgram=e.getBlocklyWorkspace=e.exportAllXml=e.exportXml=e.linkProgram=e.newProgram=e.initProgramEnvironment=e.showSaveAsModal=e.initProgramForms=e.loadFromGallery=e.saveToServer=e.init=e.password=e.SSID=void 0;var P=!0,v=!0;function b(){f(".modal").modal("hide");var o=d.Xml.workspaceToDom(p),e=d.Xml.domToText(o),t=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,i=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0;l.saveProgramToServer(n.getProgramName(),n.getProgramOwnerName(),e,t,i,n.getProgramTimestamp(),(function(o){"ok"===o.rc&&(n.setProgramTimestamp(o.lastChanged),n.setProgramSaved(!0),n.setConfigurationSaved(!0),a.info("save program "+n.getProgramName())),r.displayInformation(o,"MESSAGE_EDIT_SAVE_PROGRAM",o.message,n.getProgramName())}))}function h(){if(u.validate(),u.valid()){f(".modal").modal("hide");var o=f("#singleModalInput").val().trim(),e=d.Xml.workspaceToDom(p),t=d.Xml.domToText(e),i=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,s=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0,g=n.getUserAccountName();a.info("saveAs program "+n.getProgramName()),l.saveAsProgramToServer(o,g,t,i,s,n.getProgramTimestamp(),(function(e){if("ok"===e.rc)a.info("saved program "+n.getProgramName()+" as "+o),e.name=o,e.programShared=!1,n.setProgram(e,g,g),r.displayInformation(e,"MESSAGE_EDIT_SAVE_PROGRAM_AS",e.message,n.getProgramName());else if("ORA_PROGRAM_SAVE_AS_ERROR_PROGRAM_EXISTS"===e.cause){var m=e.lastChanged,c=d.Msg.POPUP_BACKGROUND_REPLACE||"A program with the same name already exists! <br> Would you like to replace it?";f("#show-message-confirm").oneWrap("shown.bs.modal",(function(e){f("#confirm").off(),f("#confirm").onWrap("click",(function(e){e.preventDefault(),l.saveProgramToServer(o,g,t,i,s,m,(function(e){"ok"===e.rc?(a.info("saved program "+n.getProgramName()+" as "+o+" and overwrote old content"),e.name=o,n.setProgram(e,g,g),r.displayInformation(e,"MESSAGE_EDIT_SAVE_PROGRAM_AS",e.message,n.getProgramName())):(a.info("failed to overwrite "+o),r.displayMessage(e.message,"POPUP",""))}))}),"confirm modal"),f("#confirmCancel").off(),f("#confirmCancel").onWrap("click",(function(o){o.preventDefault(),f(".modal").modal("hide")}),"cancel modal")})),r.displayPopupMessage("ORA_PROGRAM_SAVE_AS_ERROR_PROGRAM_EXISTS",c,d.Msg.POPUP_REPLACE,d.Msg.POPUP_CANCEL)}}))}}function A(){u=f("#single-modal-form"),f("#buttonCancelFirmwareUpdateAndRun").onWrap("click",(function(){start()}),"cancel firmware update and run")}function C(){var o,e;f(window).width()<768?(o=f(window).width()/50,e=25):(o=f(window).width()/5,e=50),E(n.getProgramProg());var r=p.getTopBlocks(!0);if(r[0]){var a=r[0].getRelativeToSurfaceXY();r[0].moveBy(o-a.x,e-a.y)}}function T(o){var e;o||!1||n.isProgramSaved()?(e={rc:"ok",name:"NEPOprog",programShared:!1,lastChanged:""},n.setProgram(e),C(),s.programWasReplaced(),a.info("ProgramNew")):(f("#show-message-confirm").oneWrap("shown.bs.modal",(function(o){f("#confirm").off(),f("#confirm").on("click",(function(o){o.preventDefault(),T(!0)})),f("#confirmCancel").off(),f("#confirmCancel").on("click",(function(o){o.preventDefault(),f(".modal").modal("hide")}))})),n.isUserLoggedIn()?r.displayMessage("POPUP_BEFOREUNLOAD_LOGGEDIN","POPUP","",!0):r.displayMessage("POPUP_BEFOREUNLOAD","POPUP","",!0))}function S(o,e){var r;o?(r=o.progXML,f.isEmptyObject(o.confAnnos)||(n.confAnnos=o.confAnnos,t.alertTab("tabConfiguration"))):r=n.getProgramXML(),E(r,e)}function w(){if("tabProgram"==n.getView()){var o=d.Xml.workspaceToDom(p);E(d.Xml.domToText(o));var e=n.getProgramToolbox();p.updateToolbox(e),v=!0}else v=!1}function y(o){n.setProgramToolboxLevel(o);var e=n.getToolbox(o);e&&p.updateToolbox(e),"beginner"===o?f(".help.expert").hide():f(".help.expert").show()}function E(o,r){if(o){P=!1,p.clear();var a=d.Xml.textToDom(o,p);d.Xml.domToWorkspace(a,p),p.setVersion(a.getAttribute("xmlversion")),f("#infoContent").html(p.description),"string"==typeof p.description&&p.description.length?f("#infoButton").addClass("notEmpty"):f("#infoButton").removeClass("notEmpty");var t=p.tags;f("#infoTags").tagsinput("removeAll"),f(".bootstrap-tagsinput input").attr("placeholder","Tags"),f("#infoTags").tagsinput("add",t);n.getConfigurationXML(),a=d.Xml.workspaceToDom(p);var i=d.Xml.domToText(a),s=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,g=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0,m=n.getLanguage();f("#codeDiv").hasClass("rightActive")&&r&&l.showSourceProgram(n.getProgramName(),s,i,g,m,e.SSID,e.password,(function(o){c.setCode(o.sourceCode)})),setTimeout((function(){P=!0}),500)}}e.SSID="",e.password="",e.init=function(){var o;o=n.getProgramToolbox(),p=d.inject(document.getElementById("blocklyDiv"),{path:"/blockly/",toolbox:o,trashcan:!0,scrollbars:!0,media:"../blockly/media/",zoom:{controls:!0,wheel:!1,startScale:1,maxScale:4,minScale:.25,scaleSpeed:1.1},checkInTask:["start","_def","event"],variableDeclaration:!0,robControls:!0,theme:n.getTheme()}),f(window).resize(),p.setDevice({group:n.getRobotGroup(),robot:n.getRobot()}),n.setBlocklyWorkspace(p),p.robControls.disable("saveProgram"),p.robControls.refreshTooltips(n.getRobotRealName()),n.checkSim(),(o=f("#program .blocklyToolboxDiv")).prepend('<ul class="nav nav-tabs levelTabs"><li class="nav-item"><a class="nav-link typcn typcn-media-stop-outline active beginner" href="#beginner" data-bs-toggle="tab">1</a></li><li class="nav-item"><a href="#expert" class="nav-link typcn typcn-star-outline expert" data-bs-toggle="tab">2</a></li></ul>'),C(),f("#sliderDiv").draggable({axis:"x",cursor:"col-resize"}),f("#tabProgram").onWrap("click",(function(o){if(o.preventDefault(),"tabConfiguration"===n.getView()&&n.isUserLoggedIn()&&!n.isConfigurationSaved()&&!n.isConfigurationAnonymous())return f("#show-message-confirm").oneWrap("shown.bs.modal",(function(o){f("#confirm").off(),f("#confirm").on("click",(function(o){o.preventDefault(),n.setConfigurationName(""),f("#tabProgram").tabWrapShow()})),f("#confirmCancel").off(),f("#confirmCancel").on("click",(function(o){o.preventDefault(),f(".modal").modal("hide")}))})),r.displayMessage("POPUP_CONFIGURATION_UNSAVED","POPUP","",!0),!1;f("#tabProgram").tabWrapShow()})),f("#tabProgram").onWrap("show.bs.tab",(function(o){n.setView("tabProgram")})),f("#tabProgram").onWrap("shown.bs.tab",(function(o){p.markFocused(),p.setVisible(!0),v||w(),f(window).resize()})),f("#tabProgram").onWrap("hide.bs.tab",(function(o){v=!1})),f("#tabProgram").onWrap("hidden.bs.tab",(function(o){p.setVisible(!1)})),f(".expert, .beginner").onWrap("click",(function(o){var e=f(o.target).attr("href")&&f(o.target).attr("href").substring(1)||f(o.target.parentElement).attr("href")&&f(o.target.parentElement).attr("href").substring(1);f('.levelTabs a[href="'+e+'"]').tabWrapShow(),o.preventDefault(),y(e),o.stopPropagation(),a.info("toolbox clicked, switched to "+e)})),d.bindEvent_(p.robControls.saveProgram,"mousedown",null,(function(o){return a.info("saveProgram from blockly button"),b(),!1})),p.robControls.disable("saveProgram"),p.addChangeListener((function(o){if(P&&o.type!=d.Events.UI&&n.isProgramSaved()&&n.setProgramSaved(!1),o.type===d.Events.DELETE&&0===p.getAllBlocks().length&&T(!0),f(".selectedHelp").removeClass("selectedHelp"),d.selected&&f("#blocklyDiv").hasClass("rightActive")){var e=d.selected.type;f("#"+e).addClass("selectedHelp"),f("#helpContent").scrollTo("#"+e,1e3,{offset:-10})}return!1})),A()},e.saveToServer=b,e.loadFromGallery=function(o){var e,a=o[1],t=o[3],s=o[0];e=s===n.getRobotGroup()?n.getRobot():n.findRobot(s);var g="Gallery";i.switchRobot(e,null,(function(){l.loadProgramFromListing(a,g,t,(function(o){"ok"===o.rc&&(o.programShared="READ",o.name=a,n.setProgram(o,g,t),n.setProgramXML(o.progXML),void 0===o.configName?void 0===o.confXML?(n.setConfigurationNameDefault(),n.setConfigurationXML(n.getConfigurationConf())):(n.setConfigurationName(""),n.setConfigurationXML(o.confXML)):(n.setConfigurationName(o.configName),n.setConfigurationXML(o.confXML)),f("#tabProgram").oneWrap("shown.bs.tab",(function(o){m.reloadConf(),S()})),f("#tabProgram").tabWrapShow()),r.displayInformation(o,"",o.message)}))}))},e.initProgramForms=A,e.showSaveAsModal=function(){f.validator.addMethod("regex",(function(o,e,r){return(o=o.trim()).match(r)}),"No special Characters allowed here. Use only upper and lowercase letters (A through Z; a through z) and numbers."),t.showSingleModal((function(){f("#singleModalInput").attr("type","text"),f("#single-modal h5").text(d.Msg.MENU_SAVE_AS),f("#single-modal label").text(d.Msg.POPUP_NAME)}),h,(function(){}),{rules:{singleModalInput:{required:!0,regex:/^[a-zA-Z_öäüÖÄÜß$€][a-zA-Z0-9_öäüÖÄÜß$€]{0,254}$/}},errorClass:"form-invalid",errorPlacement:function(o,e){o.insertAfter(e)},messages:{singleModalInput:{required:d.Msg.VALIDATION_FIELD_REQUIRED,regex:d.Msg.MESSAGE_INVALID_NAME}}})},e.initProgramEnvironment=C,e.newProgram=T,e.linkProgram=function(){var o=d.Xml.workspaceToDom(p),e=d.Xml.domToText(o);e='<export xmlns="http://de.fhg.iais.roberta.blockly"><program>'+e+"</program><config>"+n.getConfigurationXML()+"</config></export>";var t="https://lab.open-roberta.org/#loadProgram";t+="&&"+n.getRobot(),t+="&&"+n.getProgramName(),t+="&&"+e,t=encodeURI(t);var i=f("<input>");f("body").append(i),i.val(t).select(),document.execCommand("copy"),i.remove();var s='</br><textarea readonly style="width:100%;" type="text">'+t+"</textarea>";a.info("ProgramLinkShare"),r.displayMessage("POPUP_GET_LINK","POPUP",s)},e.exportXml=function(){var o=d.Xml.workspaceToDom(p),e='<export xmlns="http://de.fhg.iais.roberta.blockly"><program>'+d.Xml.domToText(o)+"</program><config>"+n.getConfigurationXML()+"</config></export>";a.info("ProgramExport"),t.download(n.getProgramName()+".xml",e),r.displayMessage("MENU_MESSAGE_DOWNLOAD","TOAST",n.getProgramName())},e.exportAllXml=function(){g.userLoggedInCheck((function(o){"ok"===o.rc?l.exportAllProgramsXml():r.displayMessage(o.cause,"TOAST","Log in check failed for Export")}))},e.getBlocklyWorkspace=function(){return p},e.reloadProgram=S,e.reloadView=w,e.resetView=function(){p.setDevice({group:n.getRobotGroup(),robot:n.getRobot()}),C();var o=n.getProgramToolbox();p.updateToolbox(o)},e.loadToolbox=y,e.loadExternalToolbox=function(o){o&&p.updateToolbox(o)},e.programToBlocklyWorkspace=E}));
//# sourceMappingURL=program.controller.js.map
//# sourceMappingURL=program.controller.js.map
