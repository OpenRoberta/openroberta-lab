define(["require","exports","log","util.roberta","message","guiState.controller","blockly","configuration.model","confVisualization","jquery","jquery-validate"],(function(o,e,n,i,t,a,r,s,l,g){var u,f,c;Object.defineProperty(e,"__esModule",{value:!0}),e.configurationToBricklyWorkspace=e.resetView=e.changeRobotSvg=e.reloadView=e.reloadConf=e.getBricklyWorkspace=e.showConfiguration=e.newConfiguration=e.showSaveAsModal=e.initConfigurationEnvironment=e.loadFromListing=e.saveAsToServer=e.saveToServer=e.initConfigurationForms=e.init=void 0;var m=!0,d=!1;function v(){u=g("#single-modal-form")}function C(){if(g(".modal").modal("hide"),a.isConfigurationStandard()||a.isConfigurationAnonymous())n.error("saveToServer may only be called with an explicit config name");else{var o=c?c.getXml():r.Xml.workspaceToDom(f),e=r.Xml.domToText(o);s.saveConfigurationToServer(a.getConfigurationName(),e,(function(o){"ok"===o.rc&&(a.setConfigurationSaved(!0),n.info("save brick configuration "+a.getConfigurationName())),t.displayInformation(o,"MESSAGE_EDIT_SAVE_CONFIGURATION",o.message,a.getConfigurationName())}))}}function b(){if(u.validate(),u.valid()){g(".modal").modal("hide");var o=g("#singleModalInput").val().trim();if(a.getConfigurationStandardName()===o)return void n.error("saveAsToServer may NOT use the config standard name");var e=c?c.getXml():r.Xml.workspaceToDom(f),i=r.Xml.domToText(e);s.saveAsConfigurationToServer(o,i,(function(e){if("ok"===e.rc)e.name=o,a.setConfiguration(e),a.setProgramSaved(!1),n.info("save brick configuration "+a.getConfigurationName()),t.displayInformation(e,"MESSAGE_EDIT_SAVE_CONFIGURATION_AS",e.message,a.getConfigurationName());else if("ORA_CONFIGURATION_SAVE_AS_ERROR_CONFIGURATION_EXISTS"==e.cause){var l=r.Msg.POPUP_BACKGROUND_REPLACE_CONFIGURATION||"A configuration with the same name already exists! <br> Would you like to replace it?";g("#show-message-confirm").onWrap("shown.bs.modal",(function(e){g("#confirm").off(),g("#confirm").onWrap("click",(function(e){e.preventDefault,s.saveConfigurationToServer(o,i,(function(e){"ok"==e.rc?(e.name=o,a.setConfiguration(e),a.setProgramSaved(!1),n.info("saved configuration"+a.getConfigurationName()+" as"+o+" and overwrote old content"),t.displayInformation(e,"MESSAGE_EDIT_SAVE_CONFIGURATION_AS",e.message,a.getConfigurationName())):(n.info("failed to overwrite "+o),t.displayMessage(e.message,"POPUP",""))}))}),"confirm modal"),g("#confirmCancel").off(),g("#confirmCancel").onWrap("click",(function(o){o.preventDefault(),g(".modal").modal("hide")}),"cancel modal")})),t.displayPopupMessage("ORA_CONFIGURATION_SAVE_AS_ERROR_CONFIGURATION_EXISTS",l,r.Msg.POPUP_REPLACE,r.Msg.POPUP_CANCEL)}}))}}function p(){if(A(a.getConfigurationConf()),w()){g(window).width()<768?(x=g(window).width()/50,y=25):(x=g(window).width()/5,y=50);for(var o=f.getTopBlocks(!0),e=0;e<o.length;e++){var n=r.getSvgXY_(o[e].svgGroup_,f),i=o[e].getRelativeToSurfaceXY();o[e].moveBy(i.x-n.x+x,i.y-n.y+y)}d=!0}else d=!1,f.setVisible(!1);var t=c?c.getXml():r.Xml.workspaceToDom(f);r.Xml.domToText(t)}function S(o){if(o||!1||a.isConfigurationSaved()){var e={};e.name=a.getRobotGroup().toUpperCase()+"basis",e.lastChanged="",a.setConfiguration(e),p()}else g("#show-message-confirm").oneWrap("shown.bs.modal",(function(o){g("#confirm").off(),g("#confirm").onWrap("click",(function(o){o.preventDefault(),S(!0)})),g("#confirmCancel").off(),g("#confirmCancel").onWrap("click",(function(o){o.preventDefault(),g(".modal").modal("hide")}))})),a.isUserLoggedIn()?t.displayMessage("POPUP_BEFOREUNLOAD_LOGGEDIN","POPUP","",!0):t.displayMessage("POPUP_BEFOREUNLOAD","POPUP","",!0)}function T(o){"ok"==o.rc&&(A(o.confXML),a.setConfiguration(o),n.info("show configuration "+a.getConfigurationName()))}function w(){return"tabConfiguration"==a.getView()}function A(o){m=!1,f.clear(),r.svgResize(f);var e,n=r.Xml.textToDom(o,f);c&&(c.dispose(),c=null),l.CircuitVisualization.isRobotVisualized(a.getRobotGroup(),a.getRobot())?c=l.CircuitVisualization.domToWorkspace(n,f):r.Xml.domToWorkspace(n,f),f.setVersion(n.getAttribute("xmlversion"));var i=null==a.getConfigurationName()?"":a.getConfigurationName();e=o==a.getConfigurationConf()?a.getRobotGroup().toUpperCase()+"basis":i,a.setConfigurationName(e),a.setConfigurationSaved(!0),g("#tabConfigurationName").html(e),setTimeout((function(){m=!0}),500),d=!!w(),a.isConfigurationUsed()?f.setVisible(!0):f.setVisible(!1)}e.init=function(){var o;o=a.getConfigurationToolbox(),(f=r.inject(document.getElementById("bricklyDiv"),{path:"/blockly/",toolbox:o,trashcan:!0,scrollbars:!0,media:"../blockly/media/",zoom:{controls:!0,wheel:!1,startScale:1,maxScale:4,minScale:.25,scaleSpeed:1.1},checkInTask:["-Brick","robConf"],variableDeclaration:!0,robControls:!0,theme:a.getTheme()})).setDevice({group:a.getRobotGroup(),robot:a.getRobot()}),f.robControls.runOnBrick.setAttribute("style","display : none"),a.setBricklyWorkspace(f),f.robControls.disable("saveProgram"),g("#tabConfiguration").onWrap("show.bs.tab",(function(o){a.setView("tabConfiguration")})),g("#tabConfiguration").onWrap("shown.bs.tab",(function(o){f.markFocused(),a.isConfigurationUsed()?f.setVisible(!0):f.setVisible(!1),g(window).resize(),i.clearAnnotations(f),void 0!==a.confAnnos&&(i.annotateBlocks(f,a.confAnnos),delete a.confAnnos),c&&c.refresh()}),"tabConfiguration clicked"),g("#tabConfiguration").onWrap("hidden.bs.tab",(function(o){var e=c?c.getXml():r.Xml.workspaceToDom(f),n=r.Xml.domToText(e);a.setConfigurationXML(n),f.setVisible(!1)})),r.bindEvent_(f.robControls.saveProgram,"mousedown",null,(function(o){n.info("saveConfiguration from brickly button"),C()})),f.addChangeListener((function(o){m&&o.type!=r.Events.UI&&a.isConfigurationSaved()&&(a.isConfigurationStandard()&&a.setConfigurationName(""),a.setConfigurationSaved(!1),a.setProgramSaved(!1)),o.type===r.Events.DELETE&&0===f.getAllBlocks().length&&S(!0)})),v(),p()},e.initConfigurationForms=v,e.saveToServer=C,e.saveAsToServer=b,e.loadFromListing=function(o){n.info("loadFromList "+o[0]),s.loadConfigurationFromListing(o[0],o[1],(function(e){"ok"===e.rc&&(e.name=o[0],g("#tabConfiguration").oneWrap("shown.bs.tab",(function(){T(e)})),g("#tabConfiguration").tabWrapShow()),t.displayInformation(e,"",e.message)}))},e.initConfigurationEnvironment=p,e.showSaveAsModal=function(){var o=new RegExp("^(?!\\b"+a.getConfigurationStandardName()+"\\b)([a-zA-Z_öäüÖÄÜß$€][a-zA-Z0-9_öäüÖÄÜß$€]*)$");g.validator.addMethod("regex",(function(o,e,n){return(o=o.trim()).match(n)}),"No special Characters allowed here. Use only upper and lowercase letters (A through Z; a through z) and numbers."),i.showSingleModal((function(){g("#singleModalInput").attr("type","text"),g("#single-modal h5").text(r.Msg.MENU_SAVE_AS),g("#single-modal label").text(r.Msg.POPUP_NAME)}),b,(function(){}),{rules:{singleModalInput:{required:!0,regex:o}},errorClass:"form-invalid",errorPlacement:function(o,e){o.insertAfter(e)},messages:{singleModalInput:{required:jQuery.validator.format(r.Msg.VALIDATION_FIELD_REQUIRED),regex:jQuery.validator.format(r.Msg.MESSAGE_INVALID_CONF_NAME)}}})},e.newConfiguration=S,e.showConfiguration=T,e.getBricklyWorkspace=function(){return f},e.reloadConf=function(o){var e;if(e=o?o.confXML:a.getConfigurationXML(),d)A(e);else{var n,i;A(e),g(window).width()<768?(n=g(window).width()/50,i=25):(n=g(window).width()/5,i=50);for(var t=f.getTopBlocks(!0),s=0;s<t.length;s++){var l=r.getSvgXY_(t[s].svgGroup_,f),u=t[s].getRelativeToSurfaceXY();t[s].moveBy(u.x-l.x+n,u.y-l.y+i)}}},e.reloadView=function(){var o=c?c.getXml():r.Xml.workspaceToDom(f);A(r.Xml.domToText(o));var e=a.getConfigurationToolbox();f.updateToolbox(e)},e.changeRobotSvg=function(){l.CircuitVisualization.isRobotVisualized(a.getRobotGroup()+"_"+a.getRobot())&&(f.setDevice({group:a.getRobotGroup(),robot:a.getRobot()}),c.resetRobot())},e.resetView=function(){f.setDevice({group:a.getRobotGroup(),robot:a.getRobot()}),p();var o=a.getConfigurationToolbox();f.updateToolbox(o)},e.configurationToBricklyWorkspace=A}));
//# sourceMappingURL=configuration.controller.js.map
//# sourceMappingURL=configuration.controller.js.map
