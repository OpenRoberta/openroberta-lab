var __extends=this&&this.__extends||function(){var t=function(e,o){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])},t(e,o)};return function(e,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function i(){this.constructor=e}t(e,o),e.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}}(),__awaiter=this&&this.__awaiter||function(t,e,o,i){return new(o||(o=Promise))((function(n,a){function r(t){try{l(i.next(t))}catch(t){a(t)}}function s(t){try{l(i.throw(t))}catch(t){a(t)}}function l(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,s)}l((i=i.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var o,i,n,a,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(l){return function(s){if(o)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(r=0)),r;)try{if(o=1,i&&(n=2&s[0]?i.return:s[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,s[1])).done)return n;switch(i=0,n&&(s=[2&s[0],n.value]),s[0]){case 0:case 1:n=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,i=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==s[0]&&2!==s[0])){r=0;continue}if(3===s[0]&&(!n||s[1]>n[0]&&s[1]<n[3])){r.label=s[1];break}if(6===s[0]&&r.label<n[1]){r.label=n[1],n=s;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(s);break}n[2]&&r.ops.pop(),r.trys.pop();continue}s=e.call(t,r)}catch(t){s=[6,t],i=0}finally{o=n=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}};define(["require","exports","message","util.roberta","guiState.controller","tour.controller","program.controller","program.model","program.model","blockly","jquery","simulation.objects","simulation.webots","simulation.roberta","simulation.constants","progList.model","jquery-validate"],(function(t,e,o,i,n,a,r,s,l,c,m,u,d,p,g,f){Object.defineProperty(e,"__esModule",{value:!0}),e.createProgSimMultiInstance=e.createProgSimDebugInstance=e.createProgSimInstance=void 0;var h=function(){function t(){this.blocklyWorkspace=n.getBlocklyWorkspace(),this.initEvents()}return t.createProgSimInstance=function(){this._progSimInstance||(this._progSimInstance=new t)},t.prototype.initEvents=function(){var t=this;m("#simButton").off(),m("#simButton").onWrap("click touchend",(function(e,o){return n.hasWebotsSim()?t.SIM=d.default:(t.SIM=p.SimulationRoberta.Instance,p.SimulationRoberta.Instance.debugMode&&p.SimulationRoberta.Instance.updateDebugMode(!1)),window.speechSynthesis&&window.speechSynthesis.speak&&window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),t.toggleSim(m(this)),!1}),"sim open/close clicked")},t.prototype.addControlEvents=function(){var t=this.SIM,e=this;m("#simControl").onWrap("click.sim",(function(){if(t.isInterpreterRunning())m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-stop"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_START_TOOLTIP),t.stopProgram();else{e.prepareProgram((function(e){"ok"==e.rc?(o.displayMessage("MESSAGE_EDIT_START","TOAST",n.getProgramName(),null,null),m("#simControl").addClass("typcn-media-stop").removeClass("typcn-media-play-outline"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_STOP_TOOLTIP),e.savedName=n.getProgramName(),e.updateNNView=!0,t.run([e],(function(){m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-stop"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_START_TOOLTIP)}))):o.displayInformation(e,"",e.message,"",null),r.reloadProgram(e)}))}return!1}),"sim control clicked")},t.prototype.addConfigEvents=function(){var t=this.SIM;i.isIE()||i.isEdge()?m("#simImport").hide():(m("#simImport").show(),m("#simImport").onWrap("click.sim",(function(){return t.importImage(),!1}))),m("#simRobot").onWrap("click.sim",(function(){n.getRobot();var t=m("#simDiv").position();return t.left+=48,m("#simRobotWindow").toggleSimPopup(t),!1}),"sim robot view clicked"),m("#simValues").onWrap("click.sim",(function(){var t=m("#simDiv").position();return t.left=m(window).width()-(m("#simValuesWindow").width()+12),m("#simValuesWindow").toggleSimPopup(t),!1}),"sim values view clicked"),m(".simWindow .close").onWrap("click.sim",(function(){return m(m(this).parents(".simWindow:first")).animate({opacity:"hide",top:"hide"},300),!1}),"sim window close clicked"),m("#simResetPose").onWrap("click.sim",(function(){return t.resetPose(),!1}),"sim reset pose clicked"),m(".simAddMarker").onWrap("click.sim",(function(e){var o=e.target.getAttribute("data-marker")||e.currentTarget.text;return t.addMarker&&t.addMarker(o),!1}),"sim add marker clicked"),m("#simMarkerDeleteAll").onWrap("click.sim",(function(e){return t.deleteAllMarker&&t.deleteAllMarker(),!1}),"sim delete all marker clicked"),m("#simAddObstacleRectangle").onWrap("click.sim",(function(){return t.addObstacle&&t.addObstacle(u.SimObjectShape.Rectangle),!1}),"sim add rectangle obstacle clicked"),m("#simAddObstacleTriangle").onWrap("click.sim",(function(){return t.addObstacle&&t.addObstacle(u.SimObjectShape.Triangle),!1}),"sim add triangle obstacle clicked"),m("#simAddObstacleCircle").onWrap("click.sim",(function(){return t.addObstacle&&t.addObstacle(u.SimObjectShape.Circle),!1}),"sim add circle obstacle clicked"),m("#simObstacleDeleteAll").onWrap("click.sim",(function(){return t.deleteAllObstacle&&t.deleteAllObstacle(),!1}),"sim delete all obstacles clicked"),m("#simAddAreaRectangle").onWrap("click.sim",(function(){return t.addColorArea&&t.addColorArea(u.SimObjectShape.Rectangle),!1})),m("#simAddAreaTriangle").onWrap("click.sim",(function(){return t.addColorArea&&t.addColorArea(u.SimObjectShape.Triangle),!1}),"sim add triangle color area clicked"),m("#simAddAreaCircle").onWrap("click.sim",(function(){return t.addColorArea&&t.addColorArea(u.SimObjectShape.Circle),!1}),"sim add circle color area clicked"),m("#simAreaDeleteAll").onWrap("click.sim",(function(){return t.deleteAllColorArea&&t.deleteAllColorArea(),!1}),"sim delete all color areas clicked"),m("#simChangeObjectColor").onWrap("click.sim",(function(){return m("#simChangeObjectColor").hasClass("disabled")||t.toggleColorPicker&&t.toggleColorPicker(),!1}),"sim change color clicked"),m("#simDeleteObject").onWrap("click.sim",(function(){return m("#simDeleteObject").hasClass("disabled")||t.deleteSelectedObject&&t.deleteSelectedObject(),!1}),"sim delete selected object clicked"),m("#simDownloadConfig").onWrap("click.sim",(function(){if(t.exportConfigData){var e=n.getProgramName()+"-sim_configuration.json";i.download(e,JSON.stringify(t.exportConfigData())),o.displayMessage("MENU_MESSAGE_DOWNLOAD","TOAST",e,null,null)}return!1}),"sim download configuration clicked"),m("#simUploadConfig").onWrap("click.sim",(function(){return t.importConfigData&&t.importConfigData(),!1}),"sim upload configuration clicked"),m("#simScene").onWrap("click.sim",(function(){return t.setBackground&&t.setBackground(-1),!1}),"sim scroll background image clicked"),m("#simTrail").onWrap("click.sim",(function(){return m(this).toggleClass("typcn-chart-line-outline"),m(this).toggleClass("typcn-chart-line"),t.toggleTrail&&t.toggleTrail(),!1}),"sim toggle draw trail clicked")},t.prototype.removeControl=function(){m("*").off("click.sim")},t.prototype.toggleSim=function(t){if(!m(".fromRight.rightActive").hasClass("shifting")){var e=this;if(t.hasClass("rightActive"))m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-play").removeClass("typcn-media-stop"),e.SIM.endDebugging&&e.SIM.endDebugging(),e.SIM.stopProgram(),m("#blocklyDiv").closeRightView((function(){e.SIM.stop()})),i.closeSimRobotWindow();else{this.resetButtons(),this.removeControl(),this.addControlEvents(),this.addConfigEvents();this.prepareProgram((function(s){"ok"==s.rc?(s.savedName=n.getProgramName(),e.SIM.init([s],!0,null,n.getRobotGroup()),m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-play"),a.getInstance()&&a.getInstance().trigger&&a.getInstance().trigger("startSim"),t.openRightView(m("#simDiv"),.5),i.openSimRobotWindow()):o.displayInformation(s,"",s.message,"",null),r.reloadProgram(s)}))}return!1}},t.prototype.resetButtons=function(){m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-stop debug"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_START_TOOLTIP),m("#simTrail").addClass("typcn-chart-line-outline").removeClass("typcn-chart-line"),m(".simChangeObject").removeClass("disabled").addClass("disabled"),m(".debug").hide()},t.prototype.prepareProgram=function(t){var e=c.Xml.workspaceToDom(this.blocklyWorkspace),o=c.Xml.domToText(e),i=!n.isConfigurationStandard()&&!n.isConfigurationAnonymous()?n.getConfigurationName():void 0,a=n.isConfigurationAnonymous()?n.getConfigurationXML():void 0,r=n.getLanguage();s.runInSim(n.getProgramName(),i,o,a,r,t)},t}();e.createProgSimInstance=h.createProgSimInstance;var b=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.createProgSimDebugInstance=function(){this._progSimDebugInstance||(this._progSimDebugInstance=new e)},e.prototype.initEvents=function(){var t=this;m("#simDebugButton").off(),m("#simDebugButton").onWrap("click touchend",(function(e,o){return t.SIM=p.SimulationRoberta.Instance,p.SimulationRoberta.Instance.updateDebugMode(!0),window.speechSynthesis&&window.speechSynthesis.speak&&window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),t.toggleSim(m(this)),!1}),"sim debug open/close clicked")},e.prototype.addControlEvents=function(){var t=this;m("#simControl").onWrap("click.sim",(function(e){t.toggleSimEvent(g.default.DEBUG_BREAKPOINT)}),"sim control clicked"),m("#simControlStepInto").onWrap("click.sim",(function(e){t.toggleSimEvent(g.default.DEBUG_STEP_INTO)}),"sim debug step into clicked"),m("#simControlStepOver").onWrap("click.sim",(function(e){t.toggleSimEvent(g.default.DEBUG_STEP_OVER)}),"sim debug step over clicked"),m("#simStop").onWrap("click.sim",(function(e){m("#simStop").addClass("disabled"),m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-play"),t.SIM.stopProgram()}),"sim stop clicked")},e.prototype.toggleSimEvent=function(t){var e=this.SIM;if(m("#simControl").hasClass("typcn-media-play-outline")){this.prepareProgram((function(o){"ok"==o.rc&&(o.savedName=n.getProgramName(),o.updateNNView=!0,e.run([o],(function(){m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-play"),m("#simStop").addClass("disabled")})),e.interpreterAddEvent(t)),m("#simControl").removeClass("typcn-media-play-outline").addClass("typcn-media-play"),m("#simStop").removeClass("disabled")}))}else m("#simControl").hasClass("typcn-media-play")?(e.setPause(!1),e.interpreterAddEvent(t)):(m("#simControl").hasClass("typcn-media-stop")&&(m("#simControl").addClass("blue").removeClass("typcn-media-stop"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_DEBUG_STEP_BREAKPOINT_TOOLTIP),m("#simStop").show()),m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-play"),e.stopProgram())},e.prototype.resetButtons=function(){t.prototype.resetButtons.call(this),m("#simStop").addClass("disabled"),m("#simControl").addClass("debug"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_DEBUG_STEP_BREAKPOINT_TOOLTIP),m(".debug").show()},e}(h);e.createProgSimDebugInstance=b.createProgSimDebugInstance;var y=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.eventTimesProgram={"input .quantity-field":function(t,e,o,i){t.preventDefault();var n=m(t.target).closest("div"),a=parseInt(n.find("input[name=quantity]").val(),10),r=a;a<0?r=0:a>10&&(r=9),n.find("input[name=quantity]").val(r),m("#multipleRobotsTable").bootstrapTable("updateCell",{index:i,field:"num",value:r})},"click .input-group .button-plus":function(t,e,o,i){t.preventDefault();var n=m(t.target).data("field"),a=m(t.target).closest("div"),r=parseInt(a.find("input[name="+n+"]").val(),10),s=r;isNaN(r)?s=0:r<9&&s++,a.find("input[name=quantity]").val(s),m("#multipleRobotsTable").bootstrapTable("updateCell",{index:i,field:"num",value:s})},"click .input-group .button-minus":function(t,e,o,i){t.preventDefault();var n=m(t.target).data("field"),a=m(t.target).closest("div"),r=parseInt(a.find("input[name="+n+"]").val(),10),s=r;isNaN(r)?s=0:r>0&&s--,a.find("input[name=quantity]").val(s),m("#multipleRobotsTable").bootstrapTable("updateCell",{index:i,field:"num",value:s})}},e}return __extends(e,t),e.createProgSimMultiInstance=function(){this._progSimMultiInstance||(this._progSimMultiInstance=new e)},e.prototype.initEvents=function(){var t=this;m("#head-navigation-program-edit").onWrap("click",".dropdown-menu li:not(.disabled) a",(function(e){if("menuRunMulipleSim"===(e.target.id||e.currentTarget.id))return t.SIM=p.SimulationRoberta.Instance,t.showListProg(),m(".debug").hide(),!1})),m("#loadMultipleSimPrograms").off(),m("#loadMultipleSimPrograms").onWrap("click",(function(){window.speechSynthesis&&window.speechSynthesis.speak&&window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),t.selectedPrograms=[],m("#multipleRobotsTable").bootstrapTable("getData").forEach((function(e,o){if(e.num>0){var i=e;i.times=e.num,i.updateNNView=0===o,t.selectedPrograms.push(i)}})),t.loadProgramms().then((function(e){Promise.all(e).then((function(e){t.extractedPrograms.length>=1&&t.toggleMultiSim(m("#simButton"),t.getSortedExtractedPrograms())}),(function(e){m("#blocklyDiv").closeRightView((function(){t.SIM.stop()})),o.displayInformation({rc:"error"},"",e.message,e.name,null)})),m("#showMultipleSimPrograms").modal("hide")}))}),"multi sim load clicked"),m("#showMultipleSimPrograms").on("show.bs.modal",(function(){var t=Math.min(m(window).height()-200,532);m("#showMultipleSimPrograms .fixed-table-body").height(t)}))},e.prototype.getSortedExtractedPrograms=function(){var t=[],e=this;return this.selectedPrograms.forEach((function(o){for(var i=e.extractedPrograms.find((function(t){return t.programName==o.programName})),n=0;n<o.times;n++)t.push(i)})),t},e.prototype.loadProgramms=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,o,i,n,a;return __generator(this,(function(r){for(0,(t=this).extractedPrograms=[],e=[],o=function(o){o.blockly?e.push(new Promise((function(e,i){t.prepareProgram((function(n){t.loadStackMachineCode(o,e,i,n)}))}))):e.push(new Promise((function(e,i){l.loadProgramFromListing(o.programName,o.owner,o.creator,(function(n){t.loadStackMachineCode(o,e,i,n)}))})))},i=0,n=this.selectedPrograms;i<n.length;i++)a=n[i],o(a);return[2,e]}))}))},e.prototype.loadStackMachineCode=function(t,e,o,i){var a=this;if("ok"===i.rc){var r=i,s=i.progXML,c=i.configName!==n.getRobotGroup().toUpperCase()+"basis"&&""!==i.configName?i.configName:void 0,m=""!==i.configName?i.confXML?i.confXML:n.isConfigurationAnonymous()?n.getConfigurationXML():void 0:void 0,u=n.getLanguage();l.runInSim(i.programName,c,s,m,u,(function(i){if("ok"===i.rc){var n=r;for(var s in i)n[s]=i[s];n.updateNNView=t.updateNNView,a.extractedPrograms.push(n),e("ok")}else o({message:i.message,name:t.programName})}))}else o({message:i.message,name:t.programName})},e.prototype.showListProg=function(){var t=this,e=[];e.push({programName:n.getProgramName(),robot:n.getRobotGroup(),creator:"",date:"",num:0,blockly:!0}),n.isUserLoggedIn()?f.loadProgList((function(o){if("ok"===o.rc){t.progList=o,m("#multipleRobotsTable").bootstrapTable("destroy");var i=n.getRobot();o.programNames.forEach((function(t,o,n){e.push({programName:t[0],robot:i,creator:t[1],owner:t[3],date:t[4],num:0})}))}t.showTable(e)})):this.showTable(e)},e.prototype.showTable=function(t){var e=this,o=n.getLanguage();m("#multipleRobotsTable").bootstrapTable("destroy").bootstrapTable({locale:o,sortName:"name",toggle:"multipleRobotsTable",theadClasses:"table-dark",iconsPrefix:"typcn",search:!0,icons:{paginationSwitchDown:"typcn-document-text",paginationSwitchUp:"typcn-book",refresh:"typcn-refresh"},pagination:"true",buttonsAlign:"right",resizable:"true",rowStyle:e.rowStyle,columns:[{field:"programName",title:"<span lkey='Blockly.Msg.DATATABLE_PROGRAM_NAME'>"+(c.Msg.DATATABLE_PROGRAM_NAME||"Name des Programms")+"</span>",sortable:!0},{field:"creator",title:"<span lkey='Blockly.Msg.DATATABLE_CREATED_BY'>"+(c.Msg.DATATABLE_CREATED_BY||"Erzeugt von")+"</span>",sortable:!0},{field:"owner",visible:!1},{field:"date",title:"<span lkey='Blockly.Msg.DATATABLE_CREATED_ON'>"+(c.Msg.DATATABLE_CREATED_ON||"Erzeugt am")+"</span>",sortable:!0,formatter:i.formatDate},{field:"num",events:e.eventTimesProgram,align:"left",valign:"top",formatter:e.formatTimesProgram,width:"117px"}],data:t}),m("#showMultipleSimPrograms").modal("show")},e.prototype.rowStyle=function(t,e){return""===t.creator?{css:{"background-color":"#EEEEEE"}}:{}},e.prototype.formatTimesProgram=function(t,e,o){return'<div class="input-group"><input type="button" value="-" class="button-minus" data-field="quantity"><input type="number" step="1" max="9" min="0" value='+t+' name="quantity" class="quantity-field"><input type="button" value="+" class="button-plus" data-field="quantity"></div>'},e.prototype.addControlEvents=function(){var t=this.SIM,e=this;m("#simControl").onWrap("click.sim",(function(){var i=this;return t.isInterpreterRunning()?(m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-stop"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_START_TOOLTIP),t.stopProgram()):(m("#simControl").addClass("typcn-media-stop").removeClass("typcn-media-play-outline"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_STOP_TOOLTIP),e.loadProgramms().then((function(n){Promise.all(n).then((function(o){t.run(e.getSortedExtractedPrograms(),(function(){m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-stop"),m("#simControl").attr("data-bs-original-title",c.Msg.MENU_SIM_START_TOOLTIP)}))}),(function(t){m("#blocklyDiv").closeRightView((function(){i.SIM.stop()})),o.displayInformation({rc:"error"},"",t.message,t.name,null)}))}))),!1}),"sim control clicked")},e.prototype.toggleMultiSim=function(t,e){if(!m(".fromRight.rightActive").hasClass("shifting")){return this.SIM.stopProgram(),this.resetButtons(),this.removeControl(),this.addControlEvents(),this.addConfigEvents(),this.SIM.init(e,!0,null,n.getRobotGroup()),m("#simControl").addClass("typcn-media-play-outline").removeClass("typcn-media-play"),a.getInstance()&&a.getInstance().trigger&&a.getInstance().trigger("startSim"),t.openRightView(m("#simDiv"),.5),i.openSimRobotWindow(),!1}},e}(h);e.createProgSimMultiInstance=y.createProgSimMultiInstance}));
//# sourceMappingURL=progSim.controller.js.map
//# sourceMappingURL=progSim.controller.js.map
