var __extends=this&&this.__extends||function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),__awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((r=r.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}};define(["require","exports","abstract.connections","jquery","guiState.controller","program.model","util.roberta","message","guiState.model","robot.controller","dapjs","blockly","thymio","program.controller","webview.controller","comm","log","socket.io","connection.controller"],(function(t,e,n,r,o,i,s,a,c,u,l,d,h,p,f,g,m,v,b){Object.defineProperty(e,"__esModule",{value:!0}),e.LocalConnection=e.WedoConnection=e.ThymioConnection=e.SpikeConnection=e.SpikePybricksConnection=e.RobotinoROSConnection=e.RobotinoConnection=e.NxtConnection=e.NaoConnection=e.Microbitv2Connection=e.MicrobitConnection=e.JoycarConnection=e.Calliope2017NoBlueConnection=e.Calliope2017Connection=e.Calliope2016Connection=e.XNNConnection=e.Ev3lejosv1Connection=e.Ev3lejosv0Connection=e.Ev3devConnection=e.Ev3c4ev3Connection=e.Ev3Connection=e.EdisonConnection=e.Mbot2Connection=e.Unowifirev2Connection=e.UnoConnection=e.SenseboxConnection=e.Rob3rtaConnection=e.Nano33bleConnection=e.NanoConnection=e.MegaConnection=e.MbotConnection=e.FestobionicConnection=e.FestobionicflowerConnection=e.BotnrollConnection=e.Bob3Connection=e.AudioConnection=void 0;var _=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.run=function(t){if("ok"!==t.rc)o.setConnectionState("wait"),a.displayInformation(t,t.message,t.message,o.getProgramName(),o.getRobot());else{var e,n=s.base64decode(t.compiledCode);if(r("#changedDownloadFolder").addClass("hidden"),window.msCrypto)this.createDownloadLink(o.getProgramName()+".wav",n);else{r("#OKButtonModalFooter").addClass("hidden");var i=new Blob([n],{type:"audio/wav"});e=new Audio(window.URL.createObjectURL(i)),this.createPlayButton(e)}var c=r("#popupDownloadHeader").text();r("#popupDownloadHeader").text(c.replace("$",r.trim(o.getRobotRealName())));for(var u=1;d.Msg["POPUP_DOWNLOAD_STEP_"+u];u++){var l=r('<li class="typcn typcn-roberta">'),h=d.Msg["POPUP_DOWNLOAD_STEP_"+u+"_"+o.getRobotGroup().toUpperCase()]||d.Msg["POPUP_DOWNLOAD_STEP_"+u]||"POPUP_DOWNLOAD_STEP_"+u;l.html('<span class="download-message">'+h+"</span>"),l.css("opacity","0"),r("#download-instructions").append(l)}r("#save-client-compiled-program").oneWrap("shown.bs.modal",(function(t){r("#download-instructions li").each((function(t){r(this).delay(750*t).animate({opacity:1},1e3)}))})),r("#save-client-compiled-program").oneWrap("hidden.bs.modal",(function(n){window.msCrypto||(e.pause(),e.load());var i=r("#popupDownloadHeader").text();r("#popupDownloadHeader").text(i.replace(r.trim(o.getRobotRealName()),"$")),r("#programLink").remove(),r("#download-instructions").empty(),o.setConnectionState("wait"),a.displayInformation(t,t.message,t.message,o.getProgramName(),o.getRobot()),r("#changedDownloadFolder").removeClass("hidden"),r("#OKButtonModalFooter").removeClass("hidden")})),r("#save-client-compiled-program").modal("show")}},e.prototype.terminate=function(){t.prototype.terminate.call(this),this.clearDownloadModal()},e.prototype.setState=function(){},e.prototype.createPlayButton=function(t){var e;if(r("#trA").removeClass("hidden"),"Blob"in window){(e=document.createElement("button")).setAttribute("type","button"),e.setAttribute("class","btn btn-primary");var n=!1;e.onclick=function(){0==n?(t.play(),o.setAttribute("class","typcn typcn-media-stop"),n=!0,t.addEventListener("ended",(function(){r("#save-client-compiled-program").modal("hide")}))):(o.setAttribute("class","typcn typcn-media-play"),t.pause(),t.load(),n=!1)};var o=document.createElement("span");o.setAttribute("class","typcn typcn-media-play"),o.setAttribute("style","color : black"),e.appendChild(o)}if(e){var i=document.createElement("div");i.setAttribute("id","programLink"),i.setAttribute("style","text-align: center;"),i.appendChild(document.createElement("br")),i.appendChild(e),e.setAttribute("style","font-size:36px"),r("#downloadLink").append(i)}},e}(n.AbstractPromptConnection);e.AudioConnection=_;var y,C,w,R=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.selectedNode=void 0,e.startTime=void 0,e.terminated=!1,e}return __extends(e,t),e.prototype.runOnBrick=function(t,e,n){var r=this;i.showSourceProgram(o.getProgramName(),t,e,n,p.getSSID(),p.getPassword(),o.getLanguage(),(function(t){r.run(t),p.reloadProgram(t)}))},e.prototype.init=function(){o.setPing(!0),o.setPingTime(o.SHORT),o.getBlocklyWorkspace().robControls.showStopProgram(),this.initNode()},e.prototype.initNode=function(){var t=this;this.terminated?this.terminate():this.selectedNode?this.selectedNode.status==h.NodeStatus.ready&&this.publishConnected():(this.client=h.createClient(e.URL),this.client.onClose=function(e){t.selectedNode=void 0,t.publishDisonnected(),setTimeout((function(){t.initNode()}),1e3)},this.client.onNodesChanged=function(e){return __awaiter(t,void 0,void 0,(function(){var t,n,r,i;return __generator(this,(function(s){switch(s.label){case 0:s.trys.push([0,8,,9]),t=0,n=e,s.label=1;case 1:if(!(t<n.length))return[3,7];if(r=n[t],this.selectedNode&&this.selectedNode.id!=r.id)return[3,6];if(this.selectedNode&&(this.selectedNode.status==h.NodeStatus.ready||r.status!=h.NodeStatus.available))return[3,5];s.label=2;case 2:return s.trys.push([2,4,,5]),[4,r.lock()];case 3:return s.sent(),this.selectedNode=r,this.publishConnected(),[3,5];case 4:return s.sent(),console.log("Unable To Lock ".concat(r.id," (").concat(r.name,")")),[3,5];case 5:if(!this.selectedNode)return[3,6];this.selectedNode.status==h.NodeStatus.disconnected&&(this.selectedNode=void 0,o.updateMenuStatus(0),this.initNode()),s.label=6;case 6:return t++,[3,1];case 7:return[3,9];case 8:return i=s.sent(),console.log(i),[3,9];case 9:return[2]}}))}))})},e.prototype.isRobotConnected=function(){return null!=this.selectedNode||!1},e.prototype.run=function(t){r("#menuRunProg").parent().addClass("disabled"),o.setConnectionState("busy"),c.robot.state="busy",o.setState(t),"ok"==t.rc?(this.uploadProgram(t.sourceCode).then((function(e){"done"==e&&a.displayInformation(t,"MESSAGE_EDIT_START",t.message,o.getProgramName(),o.getRobot())}),(function(t){a.displayInformation({rc:"error"},null,t,o.getProgramName(),o.getRobot())})),setTimeout((function(){o.setConnectionState("wait"),c.robot.state="wait"}),1e3)):(o.setConnectionState("wait"),c.robot.state="wait",a.displayInformation(t,t.message,t.message,o.getProgramName(),o.getRobot()))},e.prototype.setState=function(){b.getIsAgent()||(r("#menuConnect").parent().removeClass("disabled"),"wait"===c.robot.state?(r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").addClass("wait"),o.setRunEnabled(!0),r("#runSourceCodeEditor").removeClass("disabled")):"busy"===c.robot.state?(r("#head-navi-icon-robot").removeClass("wait"),r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").addClass("busy"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled")):(r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").removeClass("wait"),r("#head-navi-icon-robot").addClass("error"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled")))},e.prototype.terminate=function(){t.prototype.terminate.call(this),this.terminated=!0,this.selectedNode=void 0,this.publishDisonnected(),c.gui.blocklyWorkspace.robControls.hideStopProgram()},e.prototype.publishConnected=function(){this.startTime=Date.now(),c.robot.fWName=o.getRobotRealName(),c.robot.time=0,c.robot.battery="-",c.robot.name=this.selectedNode.name,c.robot.state="wait",o.updateMenuStatus(1)},e.prototype.publishDisonnected=function(){c.robot.fWName="",c.robot.time=-1,c.robot.battery="-",c.robot.name="",c.robot.state="error",o.updateMenuStatus(0)},e.prototype.uploadProgram=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:if(c.robot.time=this.startTime-Date.now(),!this.selectedNode||this.selectedNode.status!==h.NodeStatus.ready)return[3,8];e.label=1;case 1:return e.trys.push([1,6,,7]),[4,this.selectedNode.lock()];case 2:return e.sent(),[4,this.selectedNode.sendAsebaProgram(t)];case 3:return e.sent(),[4,this.selectedNode.runProgram()];case 4:return e.sent(),[4,this.selectedNode.unlock()];case 5:return e.sent(),[2,"done"];case 6:throw e.sent();case 7:return[3,9];case 8:throw new Error("Exception on upload program");case 9:return[2]}}))}))},e.prototype.stopProgram=function(){this.uploadProgram(e.STOP_PROGRAM).then((function(t){"done"==t&&a.displayInformation({rc:"ok"},"MESSAGE_EDIT_START",null,o.getProgramName(),o.getRobot())}),(function(t){a.displayInformation({rc:"error"},null,t,o.getProgramName(),o.getRobot())}))},e.URL="ws://localhost:8597",e.STOP_PROGRAM="motor.left.target = 0\nmotor.right.target = 0\ncall sound.system(-1)\ncall leds.circle(32,32,32,32,32,32,32,32)\ntimer.period[0] = 100\nonevent timer0\ncall leds.circle(0,0,0,0,0,0,0,0)\n",e}(n.AbstractConnection);!function(t){t[t.DEVICE_INFORMATION_SERVICE_UUID=6154]="DEVICE_INFORMATION_SERVICE_UUID",t.NORDIC_UART_SERVICE_UUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e",t.PYBRICKS_SERVICE_UUID="c5f50001-8280-46da-89f4-6d8051e4aeef",t.PYBRICKS_COMMAND_EVENT_UUID="c5f50002-8280-46da-89f4-6d8051e4aeef",t.PYBRICKS_HUB_CAPABILITIES_CHARACTERISTIC_UUID="c5f50003-8280-46da-89f4-6d8051e4aeef"}(y||(y={})),function(t){t[t.STOP_USER_PROGRAM=0]="STOP_USER_PROGRAM",t[t.START_USER_PROGRAM=1]="START_USER_PROGRAM",t[t.START_REPL=2]="START_REPL",t[t.WRITE_USER_PROGRAM_META=3]="WRITE_USER_PROGRAM_META",t[t.COMMAND_WRITE_USER_RAM=4]="COMMAND_WRITE_USER_RAM",t[t.PBIO_PYBRICKS_COMMAND_REBOOT_TO_UPDATE_MODE=5]="PBIO_PYBRICKS_COMMAND_REBOOT_TO_UPDATE_MODE",t[t.WRITE_STDIN=6]="WRITE_STDIN"}(C||(C={})),function(t){t[t.PASS=0]="PASS",t[t.INFORMATION=1]="INFORMATION",t[t.ALERT=2]="ALERT"}(w||(w={}));var P=function(t){function e(n,r,o){var i=t.call(this," ")||this;return i.blocklyMessage="",i.alertType=w.PASS,void 0!==n&&null!=n&&(i.message=n.message),i.blocklyMessage=r,i.alertType=o,i.name=e.NAME,i}return __extends(e,t),e.NAME="BleError",e}(Error),S=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.gattServer=null,e.bleDevice=null,e.downloadInProgress=!1,e.oldProgram="",e.ping=!1,e}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),o.getBlocklyWorkspace().robControls.showStopProgram(),r("#stopProgram").addClass("disabled")},e.prototype.terminate=function(){t.prototype.terminate.call(this),r("#stopProgram").addClass("disabled"),o.getBlocklyWorkspace().robControls.hideStopProgram(),this.disconnect()},e.prototype.run=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n=this;return __generator(this,(function(i){switch(i.label){case 0:if("ok"!=t.rc)return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.connect().then((function(){return __awaiter(n,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:return this.showProgressBarModal(),this.setResetModalListener(),[4,this.downloadProgram(t.compiledCode,this.setTransferProgress).then((function(){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(t){return setTimeout((function(){r("#save-client-compiled-program").modal("hide")}),500),[2]}))}))})).finally((function(){e.downloadInProgress||e.startPingDevice()}))];case 1:return n.sent(),[2]}}))}))}))];case 2:return i.sent(),[3,4];case 3:return e=i.sent(),console.log(e),e.name===P.NAME&&(console.log(e.blocklyMessage),e.alertType===w.ALERT&&("BLE_ERROR_COMMUNICATION"==e.blocklyMessage&&r("#save-client-compiled-program").modal("hide"),a.displayInformation({rc:"error"},null,e.blocklyMessage))),[3,4];case 4:return[3,6];case 5:a.displayInformation(t,t.message,t.message,o.getProgramName(),o.getRobot()),i.label=6;case 6:return r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").addClass("wait"),o.setRunEnabled(!0),r("#stopProgram").addClass("disabled"),[2]}}))}))},e.prototype.stopProgram=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.writeGatt(y.PYBRICKS_COMMAND_EVENT_UUID,new Uint8Array([C.STOP_USER_PROGRAM]))];case 1:return e.sent(),[3,3];case 2:throw t=e.sent(),new P(t,"BLE_ERROR_STOP",w.INFORMATION);case 3:return[2]}}))}))},e.prototype.setState=function(){},e.prototype.showRobotInfo=function(){t.prototype.showRobotInfo.call(this)},e.prototype.stopPingDevice=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.ping=!1,[4,new Promise((function(t){return setTimeout(t,500)}))];case 1:return t.sent(),[2]}}))}))},e.prototype.startPingDevice=function(){this.ping=!0,this.pingDevice()},e.prototype.pingDevice=function(){return __awaiter(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(e){return this.ping&&this.isConnected()?(r("#stopProgram").removeClass("disabled"),setTimeout((function(){r("#stopProgram").removeClass("disabled"),t.pingDevice()}),250)):r("#stopProgram").addClass("disabled"),[2]}))}))},e.prototype.connect=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.stopPingDevice()];case 1:return t.sent(),this.isConnected()?[2]:[4,this.assertWebBleAvailability()];case 2:return t.sent(),[4,this.requestDevice()];case 3:return t.sent(),[4,this.connectToGattServer()];case 4:return t.sent(),[4,this.getHubCapabilities()];case 5:return t.sent(),[2]}}))}))},e.prototype.downloadProgram=function(t,n){return __awaiter(this,void 0,void 0,(function(){var r,o,i;return __generator(this,(function(s){switch(s.label){case 0:if(r=e.encodeProgram(t),o=this.maxWriteSize-e.HEADER_SIZE,this.downloadInProgress)throw new P(null,"BLE_DOWNLOAD_IN_PROGRESS",w.INFORMATION);if(r.size>this.maxProgramSize)throw new P(null,"BLE_ERROR_PROGRAM_SIZE",w.ALERT);return this.downloadInProgress||this.oldProgram!=t?[3,3]:(n(1),[4,this.stopProgram()]);case 1:return s.sent(),[4,this.startProgram()];case 2:return[2,s.sent()];case 3:return s.trys.push([3,9,10,11]),this.downloadInProgress=!0,[4,this.stopProgram()];case 4:return s.sent(),[4,this.invalidateProgram()];case 5:return s.sent(),[4,this.transferProgramAsChunks(r,o,n)];case 6:return s.sent(),[4,this.updateProgramSize(r.size)];case 7:return s.sent(),this.oldProgram=t,[4,this.startProgram()];case 8:return s.sent(),[3,11];case 9:throw i=s.sent(),this.oldProgram="",new P(i,"BLE_ERROR_COMMUNICATION",w.ALERT);case 10:return this.downloadInProgress=!1,[7];case 11:return[2]}}))}))},e.prototype.disconnect=function(){null!=this.gattServer&&this.gattServer.disconnect(),this.gattServer=null,this.bleDevice=null},e.prototype.isConnected=function(){return null!==this.gattServer&&this.gattServer.connected},e.prototype.assertWebBleAvailability=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(!s.isWebBleSupported())throw new P(null,"BLE_NOT_SUPPORTED",w.ALERT);if(void 0===navigator.bluetooth)throw new P(null,"BLE_FEATURE_DISABLED",w.ALERT);return[4,navigator.bluetooth.getAvailability()];case 1:if(!t.sent())throw new P(null,"BLE_ADAPTER_DISABLED",w.ALERT);return[2]}}))}))},e.prototype.requestDevice=function(){return __awaiter(this,void 0,void 0,(function(){var t,e;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),t=this,[4,navigator.bluetooth.requestDevice({filters:[{services:[y.PYBRICKS_SERVICE_UUID]}],optionalServices:[y.PYBRICKS_SERVICE_UUID,y.DEVICE_INFORMATION_SERVICE_UUID,y.NORDIC_UART_SERVICE_UUID]})];case 1:return t.bleDevice=n.sent(),[3,3];case 2:throw e=n.sent(),new P(e,"BLE_NO_DEVICE_SELECTED",w.ALERT);case 3:return[2]}}))}))},e.prototype.connectToGattServer=function(){return __awaiter(this,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.bleDevice.gatt.connect().then((function(t){return e.gattServer=t}))];case 1:return n.sent(),[3,3];case 2:throw t=n.sent(),new P(t,"BLE_ERROR_DEVICE_BUSY",w.ALERT);case 3:return[2]}}))}))},e.prototype.getHubCapabilities=function(){return __awaiter(this,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.gattServer.getPrimaryService(y.PYBRICKS_SERVICE_UUID).then((function(t){return __awaiter(e,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:return[4,t.getCharacteristic(y.PYBRICKS_HUB_CAPABILITIES_CHARACTERISTIC_UUID).then((function(t){return __awaiter(e,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:return[4,t.readValue()];case 1:return e=n.sent(),this.maxWriteSize=e.getUint16(0,!0),this.maxProgramSize=e.getUint32(6,!0),[2]}}))}))}))];case 1:return n.sent(),[2]}}))}))}))];case 1:return n.sent(),[3,3];case 2:throw t=n.sent(),new P(t,"BLE_ERROR_CAPABILITIES",w.ALERT);case 3:return[2]}}))}))},e.prototype.transferProgramAsChunks=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){var r,o,i;return __generator(this,(function(s){switch(s.label){case 0:r=t.size>e?e:t.size,o=0,s.label=1;case 1:return o<t.size?[4,t.slice(o,o+r).arrayBuffer()]:[3,5];case 2:return i=s.sent(),[4,this.writeToUserRam(o,i)];case 3:s.sent(),null!==n&&n((o+i.byteLength)/t.size),s.label=4;case 4:return o+=r,[3,1];case 5:return[2]}}))}))},e.prototype.writeGatt=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.gattServer.getPrimaryService(y.PYBRICKS_SERVICE_UUID).then((function(r){return __awaiter(n,void 0,void 0,(function(){var n=this;return __generator(this,(function(o){switch(o.label){case 0:return[4,r.getCharacteristic(t).then((function(t){return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,t.writeValueWithResponse(e)];case 1:return n.sent(),[2]}}))}))}))];case 1:return o.sent(),[2]}}))}))}))];case 1:return r.sent(),[2]}}))}))},e.prototype.startProgram=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.writeGatt(y.PYBRICKS_COMMAND_EVENT_UUID,new Uint8Array([C.START_USER_PROGRAM]))];case 1:return t.sent(),[2]}}))}))},e.prototype.writeToUserRam=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(r){switch(r.label){case 0:return[4,this.writeGatt(y.PYBRICKS_COMMAND_EVENT_UUID,e.createWriteUserRamCommand(t,n))];case 1:return r.sent(),[2]}}))}))},e.prototype.updateProgramSize=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.writeGatt(y.PYBRICKS_COMMAND_EVENT_UUID,e.createWriteUserProgramMetaCommand(t))];case 1:return n.sent(),[2]}}))}))},e.prototype.invalidateProgram=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.updateProgramSize(0)];case 1:return t.sent(),[2]}}))}))},e.encodeProgram=function(t){var n=e.encodeMpyBinary(t),r=[];return r.push(e.encodeProgramLength(n.length)),r.push(e.encodeProgramName("__main__")),r.push(n),new Blob(r)},e.encodeMpyBinary=function(t){for(var e=t.split(","),n=new Uint8Array(e.length),r=0;r<e.length;r++)n[r]=Number(e[r]);return n},e.encodeProgramLength=function(t){var e=new ArrayBuffer(4);return new DataView(e).setUint32(0,t,!0),e},e.encodeProgramName=function(t){return(new TextEncoder).encode(t+"\0")},e.createWriteUserRamCommand=function(t,n){var r=new Uint8Array(e.HEADER_SIZE+n.byteLength),o=new DataView(r.buffer);return o.setUint8(0,C.COMMAND_WRITE_USER_RAM),o.setUint32(1,t,!0),r.set(new Uint8Array(n),e.HEADER_SIZE),r},e.createWriteUserProgramMetaCommand=function(t){var n=new Uint8Array(e.HEADER_SIZE),r=new DataView(n.buffer);return r.setUint8(0,C.WRITE_USER_PROGRAM_META),r.setUint32(1,t,!0),n},e.HEADER_SIZE=5,e}(n.AbstractPromptConnection),E=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),this.isSelected=!1,this.shortFormForDownloadPopup=o.getRobotGroup().toUpperCase()},e.prototype.run=function(t){var e=this;if(o.setState(t),"ok"==t.rc){var n=!1;if(s.isWebUsbSupported()&&o.getVendor()&&"na"!==o.getVendor()){n=!0;var i=r("#popupDownloadHeader").text();r("#popupDownloadHeader").text(i.replace("$",r.trim(o.getRobotRealName()))),r("#programHint").addClass("hidden"),r("#changedDownloadFolder").addClass("hidden"),r("#OKButtonModalFooter").addClass("hidden"),this.isWebUsbSelected()?this.runWebUsbConnection(t):(r("#downloadType").removeClass("hidden"),r("#webUsb").oneWrap("click",(function(n){e.setIsWebUsbSelected(!0),e.runWebUsbConnection(t)})),r("#fileDownload").oneWrap("click",(function(n){r("#downloadType").addClass("hidden"),r("#programHint").removeClass("hidden"),r("#changedDownloadFolder").removeClass("hidden"),r("#OKButtonModalFooter").removeClass("hidden"),e.runFileDownload(t,e.shortFormForDownloadPopup,e.skipDownloadPopup)})))}else this.runFileDownload(t,this.shortFormForDownloadPopup,this.skipDownloadPopup);if(n=n||!(this.skipDownloadPopup||null!==navigator.userAgent.toLowerCase().match(/iPad|iPhone|android/i))){i=r("#popupDownloadHeader").text();r("#popupDownloadHeader").text(i.replace("$",r.trim(o.getRobotRealName()))),r("#save-client-compiled-program").oneWrap("hidden.bs.modal",(function(t){var n=r("#popupDownloadHeader").text();r("#popupDownloadHeader").text(n.replace(r.trim(o.getRobotRealName()),"$")),r("#label-checkbox").is(":checked")&&e.setSkipDownloadPopup(!0),r("#programLink").remove(),r("#download-instructions").empty(),r("#programHint").removeClass("hidden"),r("#changedDownloadFolder").removeClass("hidden"),r("#OKButtonModalFooter").removeClass("hidden"),r("#downloadType").addClass("hidden"),r("#status").addClass("hidden"),r("#progressBar").width("0%"),r("#transfer").text("0%"),r("#webUsb").off("click"),r("#fileDownload").off("click"),o.setConnectionState("wait")})),r("#save-client-compiled-program").modal("show")}}else o.setConnectionState("wait"),a.displayInformation(t,t.message,t.message,o.getProgramName(),o.getRobot())},e.prototype.terminate=function(){t.prototype.terminate.call(this),this.clearDownloadModal(),this.isConnected()&&this.removeDevice()},e.prototype.runWebUsbConnection=function(t){var e=this;r("#downloadType").addClass("hidden"),r("#status").removeClass("hidden"),this.connect(o.getVendor(),t.compiledCode).then((function(n){"done"==n?a.displayInformation(t,"MESSAGE_EDIT_START",t.message,o.getProgramName(),o.getRobot()):"disconnected"==n?setTimeout((function(){e.runWebUsbConnection(t)}),100):"flashing"==n||r("#save-client-compiled-program").modal("hide"),o.setConnectionState("wait"),c.robot.state="wait"}))},e.prototype.setState=function(){},e.prototype.connect=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),void 0!==this.device?[3,2]:(n=this,[4,navigator.usb.requestDevice({filters:[{vendorId:Number(t)}]})]);case 1:n.device=i.sent(),i.label=2;case 2:return[4,this.upload(e)];case 3:return[2,i.sent()];case 4:return(r=i.sent()).message&&-1===r.message.indexOf("selected")&&a.displayInformation({rc:"error"},null,r.message,o.getProgramName(),o.getRobot()),[3,5];case 5:return[2]}}))}))},e.prototype.upload=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,r,i=this;return __generator(this,(function(s){switch(s.label){case 0:return s.trys.push([0,6,,7]),void 0!==this.target&&this.target.connected?[3,4]:(e=new l.WebUSB(this.device),this.target=new l.DAPLink(e),n=this.stringToArrayBuffer(t),this.target.on(l.DAPLink.EVENT_PROGRESS,(function(t){i.setTransferProgress(t)})),[4,this.target.connect()]);case 1:return s.sent(),[4,this.target.flash(n)];case 2:return s.sent(),[4,this.target.disconnect()];case 3:return s.sent(),[3,5];case 4:return[2,"flashing"];case 5:return[3,7];case 6:return r=s.sent(),this.removeDevice(),r.message&&-1!==r.message.indexOf("disconnected")?[2,"disconnected"]:(a.displayInformation({rc:"error"},null,r.message,o.getProgramName(),o.getRobot()),[2,"error"]);case 7:return[2,"done"]}}))}))},e.prototype.stringToArrayBuffer=function(t){return(new TextEncoder).encode(t)},e.prototype.removeDevice=function(){this.target=void 0,this.device=void 0},e.prototype.isConnected=function(){return void 0!==this.device},e.prototype.isWebUsbSelected=function(){return this.isSelected},e.prototype.setIsWebUsbSelected=function(t){this.isSelected=t},e}(n.AbstractPromptConnection),A=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").removeClass("wait"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled"),r("#menuConnect").parent().removeClass("disabled"),o.setPingTime(o.SHORT),o.setPing(!0)},e.prototype.setState=function(){r("#menuConnect").parent().removeClass("disabled"),"wait"===c.robot.state?(r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").addClass("wait"),o.setRunEnabled(!0),r("#runSourceCodeEditor").removeClass("disabled")):"busy"===c.robot.state?(r("#head-navi-icon-robot").removeClass("wait"),r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").addClass("busy"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled")):(r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").removeClass("wait"),r("#head-navi-icon-robot").addClass("error"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled"))},e.prototype.isRobotConnected=function(){return c.robot.time>0},e.prototype.run=function(t){o.setState(t),a.displayInformation(t,t.message,t.message,t.programName||o.getProgramName(),o.getRobot()),"ok"==t.rc?d.Msg["MENU_ROBOT_STOP_HINT_"+o.getRobotGroup().toUpperCase()]&&a.displayMessage("MENU_ROBOT_STOP_HINT_"+o.getRobotGroup().toUpperCase(),"TOAST"):o.setConnectionState("error")},e.prototype.showConnectionModal=function(){r("#buttonCancelFirmwareUpdate").css("display","inline"),r("#buttonCancelFirmwareUpdateAndRun").css("display","none"),u.showSetTokenModal()},e.prototype.stopProgram=function(){i.stopProgram((function(){}))},e}(n.AbstractConnection),I=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.portList=[],e.vendorList=[],e.productList=[],e.robotList=[],e.agentPortList='[{"Name":"none","IdVendor":"none","IdProduct":"none"}]',e}return __extends(e,t),e.prototype.init=function(){var e=this;t.prototype.init.call(this);var n=b.getSocket();null!=n&&0!=b.getIsAgent()||(n=v("ws://127.0.0.1:8991/"),b.setSocket(n),b.setIsAgent(!0),r("#menuConnect").parent().addClass("disabled"),n.on("connect_error",(function(t){b.setIsAgent(!1)})),n.on("connect",(function(){n.emit("command","log on"),b.setIsAgent(!0),window.setInterval((function(){e.portList=[],e.vendorList=[],e.productList=[],e.robotList=[],n.emit("command","list")}),3e3)})),n.on("message",(function(t){if(t.includes('"Network": false'))(i=JSON.parse(t)).Ports.forEach((function(t){o.getVendor()===t.VendorID.toLowerCase()&&(e.portList.push(t.Name),e.vendorList.push(t.VendorID),e.productList.push(t.ProductID),e.robotList.push(o.getRobotRealName()))})),b.setIsAgent(!0),n.on("connect_error",(function(t){b.setIsAgent(!1),r("#menuConnect").parent().removeClass("disabled")})),e.portList.indexOf(o.getRobotPort())<0&&(o.getRobotPort(),o.setRobotPort("")),1==e.portList.length&&u.setPort(e.portList[0]),o.updateMenuStatus(e.getPortList().length);else if(t.includes("OS")){var i=JSON.parse(t);e.system=i.OS}})),n.on("disconnect",(function(){})),n.on("error",(function(t){}))),this.listRobotStart()},e.prototype.isRobotConnected=function(){return!0},e.prototype.terminate=function(){this.listRobotStop(),this.closeConnection(),t.prototype.terminate.call(this)},e.prototype.showConnectionModal=function(){if(1==b.getIsAgent()){var e=this.getPortList(),n=this.getRobotList();r("#singleModalListInput").empty();var o=0;e.forEach((function(t){r("#singleModalListInput").append('<option value="'+t+'" selected>'+n[o]+" "+t+"</option>"),o++})),u.showListModal()}else t.prototype.showConnectionModal.call(this)},e.prototype.run=function(t){r("#menuRunProg").parent().addClass("disabled"),r("#head-navi-icon-robot").addClass("busy"),o.setState(t),"ok"==t.rc?(this.uploadProgram(t.compiledCode,o.getRobotPort()),setTimeout((function(){o.setConnectionState("error")}),5e3)):o.setConnectionState("error"),a.displayInformation(t,t.message,t.message,o.getProgramName())},e.prototype.setState=function(){!0!==b.getIsAgent()&&(r("#menuConnect").parent().removeClass("disabled"),"wait"===c.robot.state?(r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").addClass("wait"),o.setRunEnabled(!0),r("#runSourceCodeEditor").removeClass("disabled")):"busy"===c.robot.state?(r("#head-navi-icon-robot").removeClass("wait"),r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").addClass("busy"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled")):(r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").removeClass("wait"),r("#head-navi-icon-robot").addClass("error"),o.setRunEnabled(!1),r("#runSourceCodeEditor").addClass("disabled")))},e.prototype.updateMenuStatus=function(t){switch(t){case 0:b.setIsAgent(!1);break;case 1:b.setIsAgent(!0),r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").addClass("wait"),o.setRunEnabled(!0),r("#runSourceCodeEditor").removeClass("disabled"),r("#menuConnect").parent().addClass("disabled");break;default:b.setIsAgent(!0),r("#menuConnect").parent().removeClass("disabled"),""==o.getRobotPort()?(r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").removeClass("wait"),o.setRunEnabled(!1)):(r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").addClass("wait"),o.setRunEnabled(!0),r("#runSourceCodeEditor").removeClass("disabled"))}},e.prototype.makeRequest=function(){var t=this;this.portList=[],this.vendorList=[],this.productList=[],this.robotList=[],g.listRobotsFromAgent((function(t){}),(function(e){t.agentPortList=e.responseText}),(function(){}));try{JSON.parse(this.agentPortList).forEach((function(e){o.getVendor()===e.IdVendor.toLowerCase()&&(t.portList.push(e.Name),t.vendorList.push(e.IdVendor),t.productList.push(e.IdProduct),t.robotList.push(o.getRobotRealName()))}))}catch(t){o.setRobotPort("")}this.portList.indexOf(o.getRobotPort())<0&&o.setRobotPort(""),1==this.portList.length&&u.setPort(this.portList[0]),o.updateMenuStatus(this.getPortList().length)},e.prototype.listRobotStart=function(){var t=this;r("#menuConnect").parent().addClass("disabled"),this.makeRequest(),this.timerId=window.setInterval((function(){t.makeRequest()}),3e3)},e.prototype.listRobotStop=function(){r("#menuConnect").parent().addClass("disabled"),window.clearInterval(this.timerId)},e.prototype.closeConnection=function(){var t=b.getSocket();null!=t&&(t.disconnect(),b.setSocket(null))},e.prototype.getPortList=function(){return this.portList},e.prototype.getRobotList=function(){return this.robotList},e.prototype.uploadProgram=function(t,e){g.sendProgramHexToAgent(t,e,o.getProgramName(),o.getSignature(),o.getCommandLine(),(function(){m.text("Create agent upload success"),r("#menuRunProg").parent().removeClass("disabled"),r("#runOnBrick").parent().removeClass("disabled")}))},e}(A),N=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){this.reset=!1,r("#head-navi-icon-robot").removeClass("error"),r("#head-navi-icon-robot").removeClass("busy"),r("#head-navi-icon-robot").removeClass("wait"),o.setRunEnabled(!1),r("#menuConnect").parent().removeClass("disabled"),o.inWebview()?r("#robotConnect").removeClass("disabled"):r("#robotConnect").addClass("disabled"),r("#runSourceCodeEditor").addClass("disabled"),o.setPingTime(o.LONG)},e.prototype.isRobotConnected=function(){return f.isRobotConnected()},e.prototype.run=function(t){if(a.displayInformation(t,t.message,t.message,o.getProgramName()),"ok"===t.rc){var e=t.compiledCode,n=JSON.parse(e);if(this.interpreter=f.getInterpreter(n),null!==this.interpreter){o.setConnectionState("busy"),o.getBlocklyWorkspace().robControls.switchToStop();try{this.runStepInterpreter()}catch(t){this.interpreter.terminate(),this.interpreter=null,alert(t)}}}},e.prototype.runStepInterpreter=function(){if(!this.interpreter.isTerminated()&&!this.reset){var t=(new Date).getTime()+100,e=Math.max(100,this.interpreter.run(t));this.timeout(this.runStepInterpreter,e)}},e.prototype.timeout=function(t,e){e>100?(e-=100,setTimeout(this.timeout,100,(function(){t()}),e)):setTimeout((function(){t()}),e)},e.prototype.setState=function(){},e.prototype.stopProgram=function(){null!==this.interpreter&&this.interpreter.terminate()},e.prototype.showConnectionModal=function(){u.showScanModal()},e}(n.AbstractConnection),M=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),this.shortFormForDownloadPopup="MINI"},e}(E),T=(function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.log=console.log,e.pageSize=null,e.numPages=null,e.CSW_VALUE=587202640,e.flashPageBIN=new Uint32Array([3187719680,620934640,1277184799,4089401629,4089417583,629182287,3014893,788552031,631361788,1364721901,754997661,620810492,4089401629,4089417583,629182287,3014893,788552031,620876028,4089401629,4089417583,1503498063,3506187520,620766848,16122002,3507045013,1360667136,2406478783,2404381631,704666010,3186675964,1363630415,788552095,889508092,1187047404,1073864704,1284]),e.computeChecksums2=new Uint32Array([1277670896,1151673984,570462721,2432716581,7770883,604504083,620822553,1089159209,3489671424,1006715003,3522505728,1183580305,2835629669,1349202433,3521856178,144415489,588485378,2600683164,3506717340,536919594,1151159061,2667625968,1293196802,1226131988,1040305928,554779467,1225998795,1079657291,1180909661,587547098,1259357018,1180899538,587547101,1259160413,771758317,1610797543,2583730945,416505925,2466263048,3889312769,4294966252,3988292384,1044,516138696,798746316,3432918353,461845907,3864292196]),e.reconnected=!0,e}__extends(e,t),e.prototype.connect=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),void 0!==this.device?[3,2]:(n=this,[4,navigator.usb.requestDevice({filters:[{vendorId:Number(t)}]})]);case 1:n.device=i.sent(),this.allocBoardInfo(),this.allocDAP(),i.label=2;case 2:return this.readDeviceMemory(),[4,this.upload(e)];case 3:return[2,i.sent()];case 4:return(r=i.sent()).message&&-1===r.message.indexOf("selected")&&a.displayInformation({rc:"error"},null,r.message,o.getProgramName(),o.getRobot()),[3,5];case 5:return[2]}}))}))},e.prototype.upload=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){try{if(void 0!==this.target&&this.target.connected)return[2,"flashing"];e=this.stringToArrayBuffer(t),this.flashAsync(e,e)}catch(t){return this.removeDevice(),t.message&&-1!==t.message.indexOf("disconnected")?[2,"disconnected"]:(a.displayInformation({rc:"error"},null,t.message,o.getProgramName(),o.getRobot()),[2,"error"])}return[2,"done"]}))}))},e.prototype.readDeviceMemory=function(){this.pageSize=this.cortexM.readMem32(this.FICR.CODEPAGESIZE),this.numPages=this.cortexM.readMem32(this.FICR.CODESIZE)},e.prototype.allocBoardInfo=function(){if(!this.device)throw new Error("Could not obtain device info.");if(0==this.device.deviceClass)throw new Error("device-bootloader");if(!this.device.serialNumber)throw new Error("Could not detected ID from connected board.");this.boardId=this.device.serialNumber.substring(0,4),this.boardFamilyId=this.device.serialNumber.substring(4,8),this.boardHic=this.device.serialNumber.slice(-8),48!==this.device.serialNumber.length&&this.log("USB serial number unexpected length: "+this.device.serialNumber.length),this.log("Detected board ID "+this.boardId);var t=this.boardFamilyId+this.boardHic;this.loggedBoardId==this.boardId&&this.loggedBoardFamilyHic==t||(document.dispatchEvent(new CustomEvent("webusb",{detail:{"flash-type":"webusb","event-type":"info",message:"board-id/"+this.boardId}})),document.dispatchEvent(new CustomEvent("webusb",{detail:{"flash-type":"webusb","event-type":"info",message:"board-family-hic/"+t}})),this.loggedBoardId=this.boardId,this.loggedBoardFamilyHic=t)},e.prototype.allocDAP=function(){this.transport=new l.WebUSB(this.device),this.target=new l.DAPLink(this.transport),this.cortexM=new l.CortexM(this.transport)},e.prototype.waitForHaltCore=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){return n=this,(new Date).getTime()>e?[2,Promise.reject("Timeout waiting for halt core.")]:t?[2,Promise.resolve()]:[2,this.cortexM.isHalted().then((function(t){return n.waitForHaltCore(t,e)}))]}))}))},e.prototype.reconnectAsync=function(){var t=this,e=Promise.resolve();return t.reconnected||(t.reconnected=!0,e=e.then((function(){return t.allocDAP()})).then((function(){return t.disconnectAsync()}))),e.then((function(){return t.target.connect()})).then((function(){return t.cortexM.connect()}))},e.prototype.waitForHalt=function(t){return void 0===t&&(t=1e4),__awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){return[2,this.waitForHaltCore(!1,(new Date).getTime()+t)]}))}))},e.prototype.softwareReset=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return[4,this.cortexM.writeMem32(3758157068,100270084)];case 1:return e.sent(),[4,this.cortexM.readMem32(3758157296)];case 2:t=e.sent(),e.label=3;case 3:return 0==(33554432&t)?[3,5]:[4,this.cortexM.readMem32(3758157296)];case 4:return t=e.sent(),[3,3];case 5:return[2]}}))}))},e.prototype.reset=function(t){return void 0===t&&(t=!1),__awaiter(this,void 0,void 0,(function(){var e,n;return __generator(this,(function(r){switch(r.label){case 0:return t?[4,this.cortexM.halt(!0)]:[3,7];case 1:return r.sent(),e=3758157308,[4,this.cortexM.readMem32(e)];case 2:return n=r.sent(),[4,this.cortexM.writeMem32(e,1|n)];case 3:return r.sent(),[4,this.softwareReset()];case 4:return r.sent(),[4,this.waitForHalt()];case 5:return r.sent(),[4,this.cortexM.writeMem32(e,n)];case 6:return r.sent(),[3,9];case 7:return[4,this.softwareReset()];case 8:r.sent(),r.label=9;case 9:return[2]}}))}))},e.prototype.disconnectAsync=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){return[2,this.target.disconnect()]}))}))},e.prototype.executeAsync=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return __awaiter(this,void 0,void 0,(function(){var e,n=this;return __generator(this,(function(r){switch(r.label){case 0:return t.length>12?[2,Promise.resolve()]:[4,this.cortexM.halt(!0).then((function(){return n.writeBlockAsync(t[0],t[1])})).then((function(){return n.cortexM.writeCoreRegister(n.CoreRegister.PC,t[2])})).then((function(){return n.cortexM.writeCoreRegister(n.CoreRegister.LR,t[3])})).then((function(){return n.cortexM.writeCoreRegister(n.CoreRegister.SP,t[4])}))];case 1:r.sent(),e=5,r.label=2;case 2:return e<t.length?[4,this.cortexM.writeCoreRegister(e-5,t[e])]:[3,5];case 3:r.sent(),r.label=4;case 4:return++e,[3,2];case 5:return[2,Promise.resolve().then((function(){return n.cortexM.resume(!0)})).then((function(){return n.waitForHalt()}))]}}))}))},e.prototype.writeBlockAsync=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r,o,i;return __generator(this,(function(s){switch(s.label){case 0:if(n=this.transport.packetSize-8,!(e.buffer.byteLength>n))return[3,4];r=0,o=n,s.label=1;case 1:return r==o?[3,3]:(i=new Uint32Array(e.buffer.slice(r,o)),[4,this.writeBlockCore(t+r,i)]);case 2:return s.sent(),r=o,o=Math.min(e.buffer.byteLength,o+n),[3,1];case 3:return[3,6];case 4:return[4,this.writeBlockCore(t,e)];case 5:s.sent(),s.label=6;case 6:return[2]}}))}))},e.prototype.readBlockAsync=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r,o,i,s,a,c;return __generator(this,(function(u){switch(u.label){case 0:n=[],r=t+4*e,o=t,u.label=1;case 1:return o<r?(i=o+this.pageSize,o===t&&(i&=~(this.pageSize-1)),s=Math.min(i-o,r-o),c=(a=n).push,[4,this.readBlockCore(o,s>>2)]):[3,3];case 2:return c.apply(a,[u.sent()]),o=i,[3,1];case 3:return[2,this.bufferConcat(n).subarray(0,4*e)]}}))}))},e.prototype.writeBlockCore=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,8]),[4,this.cortexM.writeAP(0,2|this.CSW_VALUE)];case 1:return r.sent(),[4,this.cortexM.writeAP(4,t)];case 2:return r.sent(),[4,this.writeRegRepeat(this.apRegr(12,0),e)];case 3:return r.sent(),[3,8];case 4:return(n=r.sent()).dapWait?(this.log("transfer wait, write block"),[4,this.writeBlockCore(t,e)]):[3,6];case 5:return[2,r.sent()];case 6:throw n;case 7:return[3,8];case 8:return[2]}}))}))},e.prototype.readBlockCore=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r,o,i;return __generator(this,(function(s){switch(s.label){case 0:return[4,this.cortexM.writeAP(0,2|this.CSW_VALUE)];case 1:return s.sent(),[4,this.cortexM.writeAP(4,t)];case 2:s.sent(),0===(n=e%15)&&(n=15),r=[],o=0,s.label=3;case 3:return o<Math.ceil(e/15)?[4,this.readRegRepeat(this.apRegr(12,2),o===r.length-1?n:15)]:[3,6];case 4:i=s.sent(),r.push(i),s.label=5;case 5:return o++,[3,3];case 6:return[2,this.bufferConcat(r).subarray(0,4*e)]}}))}))},e.prototype.writeRegRepeat=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r,o;return __generator(this,(function(i){switch(i.label){case 0:return n=this.regRequest(t,!0),r=[0,e.length,0,n],e.forEach((function(t){r.push(255&t,t>>8&255,t>>16&255,t>>24&255)})),[4,this.cmdNums(6,r)];case 1:if(1!==(o=i.sent())[3])throw new Error("(many-wr) Bad transfer status "+o[2]);return[2]}}))}))},e.prototype.readRegRepeat=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r,o,i;return __generator(this,(function(s){switch(s.label){case 0:for(n=this.regRequest(t),r=[0,e],o=0;o<e;++o)r.push(n);return[4,this.cmdNums(5,r)];case 1:if((i=s.sent())[1]!==e)throw new Error("(many) Bad #trans "+i[1]);if(1!==i[2])throw new Error("(many) Bad transfer status "+i[2]);return[2,i.subarray(3,3+4*e)]}}))}))},e.prototype.cmdNums=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n;return __generator(this,(function(r){switch(r.label){case 0:return e.unshift(t),[4,this.send(e)];case 1:if((n=r.sent())[0]!==t)throw new Error("Bad response for ".concat(t," -> ").concat(n[0]));switch(t){case 2:case 0:case 5:case 6:break;default:if(0!==n[1])throw new Error("Bad status for ".concat(t," -> ").concat(n[1]))}return[2,n]}}))}))},e.prototype.send=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n;return __generator(this,(function(r){switch(r.label){case 0:return e=Uint8Array.from(t),[4,this.transport.write(e.buffer)];case 1:return r.sent(),[4,this.transport.read()];case 2:return n=r.sent(),[2,new Uint8Array(n.buffer)]}}))}))},e.prototype.read32FromUInt8Array=function(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0},e.prototype.bufferConcat=function(t){for(var e=0,n=0,r=t;n<r.length;n++){e+=(a=r[n]).length}var o=new Uint8Array(e);e=0;for(var i=0,s=t;i<s.length;i++){var a=s[i];o.set(a,e),e+=a.length}return o},e.prototype.murmur3_core=function(t){for(var e=798746316,n=516138696,r=0;r<t.byteLength;r+=4){var o=this.read32FromUInt8Array(t,r)>>>0;o=(o=Math.imul(o,3432918353))<<15|o>>>17,e=(e^=o=Math.imul(o,461845907))<<13|e>>>19,n=(n^=o)<<13|n>>>19,e=Math.imul(e,5)+3864292196>>>0,n=Math.imul(n,5)+3864292196>>>0}return[e,n]},e.prototype.apRegr=function(t,e){return 4+((12&(t|e|1))>>2)},e.prototype.regRequest=function(t,e){void 0===e&&(e=!1);var n=e?0:2;return n|=t<4?0:1,n|=(3&t)<<2},e.prototype.pageAlignBlocks=function(t,e){for(var n=function(t,e){this.targetAddr=t,this.data=e},r=new Uint8Array(t),o=[],i=0;i<r.byteLength;){for(var s=new Uint8Array(this.pageSize).fill(255),a=e+i-(e+i&this.pageSize-1);i<r.byteLength&&!(e+i>=a+this.pageSize);++i)s[e+i-a]=r[i];var c=new n(a,s);o.push(c)}return o},e.prototype.onlyChanged=function(t,e){var n=this;return t.filter((function(t){var r=t.targetAddr/n.pageSize;if(8*r+8>e.length)return!0;var o=n.read32FromUInt8Array(e,8*r),i=n.read32FromUInt8Array(e,8*r+4),s=n.murmur3_core(t.data);return o!=s[0]||i!=s[1]}))},e.prototype.getFlashChecksumsAsync=function(){var t=this;return this.executeAsync(this.loadAddr,this.computeChecksums2,this.loadAddr+1,4294967295,this.stackAddr,this.dataAddr,0,this.pageSize,this.numPages).then((function(){return t.readBlockAsync(t.dataAddr,2*t.numPages)}))},e.prototype.runFlash=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(r){switch(r.label){case 0:return[4,this.cortexM.halt(!0)];case 1:return r.sent(),[2,Promise.all([this.cortexM.writeCoreRegister(this.CoreRegister.PC,this.loadAddr+4+1),this.cortexM.writeCoreRegister(this.CoreRegister.LR,this.loadAddr+1),this.cortexM.writeCoreRegister(this.CoreRegister.SP,this.stackAddr),this.cortexM.writeCoreRegister(0,t.targetAddr),this.cortexM.writeCoreRegister(1,e),this.cortexM.writeCoreRegister(2,this.pageSize>>2)]).then((function(){return n.cortexM.resume(!1)}))]}}))}))},e.prototype.partialFlashPageAsync=function(t,e,n){var r=this;if(t.targetAddr>=268435456)return Promise.resolve();var o=Promise.resolve(),i=1&n?this.dataAddr:this.dataAddr+this.pageSize,s=1&n?this.dataAddr+this.pageSize:this.dataAddr;if(0==n){for(var a=new Uint32Array(t.data.length/4),c=0;c<t.data.length;c+=4)a[c>>2]=this.read32FromUInt8Array(t.data,c);o=this.writeBlockAsync(i,a)}return o.then((function(){return r.runFlash(t,i)})).then((function(){if(!e)return Promise.resolve();var t=new Uint32Array(e.data.buffer);return r.writeBlockAsync(s,t)})).then((function(){return r.waitForHalt()}))},e.prototype.partialFlashCoreAsync=function(t){return __awaiter(this,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:this.log("Partial flash"),(new Date).getTime(),e=0,n.label=1;case 1:return e<t.length?(this.setTransferProgress(e/t.length),[4,this.partialFlashPageAsync(t[e],t[e+1],e)]):[3,4];case 2:n.sent(),n.label=3;case 3:return++e,[3,1];case 4:return this.setTransferProgress(1),[2]}}))}))},e.prototype.partialFlashAsync=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r=this;return __generator(this,(function(o){return[2,this.getFlashChecksumsAsync().then((function(t){return n=t,r.writeBlockAsync(r.loadAddr,r.flashPageBIN)})).then((function(){return __awaiter(r,void 0,void 0,(function(){var r,o,i,s,a=this;return __generator(this,(function(c){switch(c.label){case 0:if(r=this.pageAlignBlocks(t,0),o=r.length,this.log("Total pages: "+o),r=this.onlyChanged(r,n),this.log("Changed pages: "+r.length),!(r.length>o/2))return[3,6];c.label=1;case 1:return c.trys.push([1,3,,5]),[4,this.fullFlashAsync(e)];case 2:return c.sent(),[3,5];case 3:return i=c.sent(),this.log(i),this.log("Full flash failed, attempting partial flash."),[4,this.partialFlashCoreAsync(r)];case 4:return c.sent(),[3,5];case 5:return[3,10];case 6:return c.trys.push([6,8,,10]),[4,this.partialFlashCoreAsync(r)];case 7:return c.sent(),[3,10];case 8:return s=c.sent(),this.log(s),this.log("Partial flash failed, attempting full flash."),[4,this.fullFlashAsync(e)];case 9:return c.sent(),[3,10];case 10:return[2,Promise.resolve().then((function(){return a.reset()})).catch((function(){})).then((function(){a.log("Flashing Complete")}))]}}))}))}))]}))}))},e.prototype.fullFlashAsync=function(t){var e=this;return this.log("Full flash"),this.target.on(l.DAPLink.EVENT_PROGRESS,(function(t){e.setTransferProgress(t)})),this.transport.open().then((function(){return e.target.flash(t)})).then((function(){document.dispatchEvent(new CustomEvent("webusb",{detail:{"flash-type":"full-flash","event-type":"info",message:"full-flash-successful"}}))}))},e.prototype.flashAsync=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,r,o,i=this;return __generator(this,(function(s){switch(s.label){case 0:return s.trys.push([0,2,,3]),n=Promise.resolve().then((function(){return i.log("Begin reset"),i.reset(!0).catch((function(t){return i.log("Retrying reset"),i.reconnectAsync().then((function(){return i.reset(!0)}))}))})),r=new Promise((function(t,e){setTimeout((function(){t("timeout")}),1e3)})),[4,Promise.race([n,r]).then((function(n){return"timeout"===n?(i.log("Resetting micro:bit timed out"),i.log("Partial flashing failed. Attempting Full Flash"),document.dispatchEvent(new CustomEvent("webusb",{detail:{"flash-type":"partial-flash","event-type":"info",message:"flash-failed/attempting-full-flash"}})),i.fullFlashAsync(e)):(i.log("Begin Flashing"),i.partialFlashAsync(t,e))})).finally((function(){return i.disconnectAsync()}))];case 1:return[2,s.sent()];case 2:return o=s.sent(),[2,Promise.reject(o)];case 3:return[2]}}))}))}}(E),function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(I));e.Bob3Connection=T;var D=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(I);e.BotnrollConnection=D;var U=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.FestobionicflowerConnection=U;var x=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.FestobionicConnection=x;var O=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.MbotConnection=O;var L=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.MegaConnection=L;var B=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.NanoConnection=B;var k=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.Nano33bleConnection=k;var F=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(I);e.Rob3rtaConnection=F;var W=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),r("#robotWlan").removeClass("hidden")},e.prototype.terminate=function(){t.prototype.terminate.call(this),r("#robotWlan").addClass("hidden")},e}(E);e.SenseboxConnection=W;var H=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.UnoConnection=H;var V=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.Unowifirev2Connection=V;var G=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.Mbot2Connection=G;var z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(_);e.EdisonConnection=z;var K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(_);e.Ev3Connection=K;var Y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(E);e.Ev3c4ev3Connection=Y;var j=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.Ev3devConnection=j;var q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.Ev3lejosv0Connection=q;var Z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.Ev3lejosv1Connection=Z;var J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.XNNConnection=J;var $=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(M);e.Calliope2016Connection=$;var X=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(M);e.Calliope2017Connection=X;var Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(M);e.Calliope2017NoBlueConnection=Q;var tt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(E);e.JoycarConnection=tt;var et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(E);e.MicrobitConnection=et;var nt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(E);e.Microbitv2Connection=nt;var rt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.NaoConnection=rt;var ot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.NxtConnection=ot;var it=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),r("#robotWlan").removeClass("hidden"),c.gui.blocklyWorkspace&&c.gui.blocklyWorkspace.robControls.showStopProgram()},e.prototype.terminate=function(){t.prototype.terminate.call(this),r("#robotWlan").addClass("hidden"),c.gui.blocklyWorkspace&&c.gui.blocklyWorkspace.robControls.hideStopProgram()},e}(A);e.RobotinoConnection=it;var st=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),r("#robotWlan").removeClass("hidden")},e.prototype.terminate=function(){t.prototype.terminate.call(this),r("#robotWlan").addClass("hidden")},e}(A);e.RobotinoROSConnection=st;var at=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(S);e.SpikePybricksConnection=at;var ct=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(A);e.SpikeConnection=ct;var ut=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(R);e.ThymioConnection=ut;var lt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(N);e.WedoConnection=lt;var dt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){o.setConnectionState("wait"),r("#runSourceCodeEditor").removeClass("disabled"),r("#menuConnect").parent().addClass("disabled"),o.setPing(!1)},e.prototype.isRobotConnected=function(){return!0},e.prototype.run=function(t){var e=(t.programName||o.getProgramName())+"."+o.getBinaryFileExtension();"bin"!==o.getBinaryFileExtension()&&"uf2"!==o.getBinaryFileExtension()||(t.compiledCode=s.base64decode(t.compiledCode)),s.download(e,t.compiledCode),setTimeout((function(){o.setConnectionState("wait")}),5e3),a.displayInformation(t,t.message,t.message,o.getProgramName(),o.getRobot())},e.prototype.setState=function(){},e}(n.AbstractConnection);e.LocalConnection=dt}));
//# sourceMappingURL=connections.js.map
//# sourceMappingURL=connections.js.map
