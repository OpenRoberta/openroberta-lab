var __extends=this&&this.__extends||function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__awaiter=this&&this.__awaiter||function(t,e,n,o){return new(n||(n=Promise))((function(r,i){function s(t){try{c(o.next(t))}catch(t){i(t)}}function a(t){try{c(o.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((o=o.apply(t,e||[])).next())}))},__generator=this&&this.__generator||function(t,e){var n,o,r,i,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(r=2&a[0]?o.return:a[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,a[1])).done)return r;switch(o=0,r&&(a=[2&a[0],r.value]),a[0]){case 0:case 1:r=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(r=s.trys,(r=r.length>0&&r[r.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){s.label=a[1];break}if(6===a[0]&&s.label<r[1]){s.label=r[1],r=a;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(a);break}r[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],o=0}finally{n=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}};define(["require","exports","abstract.connections","jquery","guiState.controller","program.model","util.roberta","message","guiState.model","robot.controller","dapjs","blockly","thymio","program.controller","webview.controller","comm","log","socket.io","connection.controller"],(function(t,e,n,o,r,i,s,a,c,u,l,d,p,h,_,f,g,b,m){Object.defineProperty(e,"__esModule",{value:!0}),e.RcjConnection=e.LocalConnection=e.WedoConnection=e.ThymioConnection=e.Txt4Connection=e.SpikeConnection=e.SpikePybricksConnection=e.RobotinoROSConnection=e.RobotinoConnection=e.NxtConnection=e.NaoConnection=e.Calliopev3Connection=e.Microbitv2Connection=e.MicrobitConnection=e.JoycarConnection=e.Calliope2017NoBlueConnection=e.Calliope2017Connection=e.Calliope2016Connection=e.XNNConnection=e.Ev3lejosv1Connection=e.Ev3lejosv0Connection=e.Ev3devConnection=e.Ev3c4ev3Connection=e.Edisonv3Connection=e.Edisonv2Connection=e.Mbot2Connection=e.Unowifirev2Connection=e.UnoConnection=e.SenseboxConnection=e.Rob3rtaConnection=e.Nano33bleConnection=e.NanoConnection=e.MegaConnection=e.MbotConnection=e.FestobionicConnection=e.FestobionicflowerConnection=e.BotnrollConnection=e.Bob3Connection=void 0;var E,C,v,R=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.selectedNode=void 0,e.startTime=void 0,e.terminated=!1,e}return __extends(e,t),e.prototype.runOnBrick=function(t,e,n){var o=this;i.showSourceProgram(r.getProgramName(),t,e,n,h.getSSID(),h.getPassword(),r.getLanguage(),(function(t){o.run(t),h.reloadProgram(t)}))},e.prototype.init=function(){r.setPing(!0),r.setPingTime(r.SHORT),r.getBlocklyWorkspace().robControls.showStopProgram(),this.initNode()},e.prototype.initNode=function(){var t=this;this.terminated?this.terminate():this.selectedNode?this.selectedNode.status==p.NodeStatus.ready&&this.publishConnected():(this.client=p.createClient(e.URL),this.client.onClose=function(e){t.selectedNode=void 0,t.publishDisonnected(),setTimeout((function(){t.initNode()}),1e3)},this.client.onNodesChanged=function(e){return __awaiter(t,void 0,void 0,(function(){var t,n,o,i;return __generator(this,(function(s){switch(s.label){case 0:s.trys.push([0,8,,9]),t=0,n=e,s.label=1;case 1:if(!(t<n.length))return[3,7];if(o=n[t],this.selectedNode&&this.selectedNode.id!=o.id)return[3,6];if(this.selectedNode&&(this.selectedNode.status==p.NodeStatus.ready||o.status!=p.NodeStatus.available))return[3,5];s.label=2;case 2:return s.trys.push([2,4,,5]),[4,o.lock()];case 3:return s.sent(),this.selectedNode=o,this.publishConnected(),[3,5];case 4:return s.sent(),console.log("Unable To Lock ".concat(o.id," (").concat(o.name,")")),[3,5];case 5:if(!this.selectedNode)return[3,6];this.selectedNode.status==p.NodeStatus.disconnected&&(this.selectedNode=void 0,r.updateMenuStatus(0),this.initNode()),s.label=6;case 6:return t++,[3,1];case 7:return[3,9];case 8:return i=s.sent(),console.log(i),[3,9];case 9:return[2]}}))}))})},e.prototype.isRobotConnected=function(){return null!=this.selectedNode||!1},e.prototype.run=function(t){o("#menuRunProg").parent().addClass("disabled"),r.setConnectionState("busy"),c.robot.state="busy",r.setState(t),"ok"==t.rc?(this.uploadProgram(t.sourceCode).then((function(e){"done"==e&&a.displayInformation(t,"MESSAGE_EDIT_START",t.message,r.getProgramName(),r.getRobot())}),(function(t){a.displayInformation({rc:"error"},null,t,r.getProgramName(),r.getRobot())})),setTimeout((function(){r.setConnectionState("wait"),c.robot.state="wait"}),1e3)):(r.setConnectionState("wait"),c.robot.state="wait",a.displayInformation(t,t.message,t.message,r.getProgramName(),r.getRobot()))},e.prototype.setState=function(){m.getIsAgent()||(o("#menuConnect").parent().removeClass("disabled"),"wait"===c.robot.state?(o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").addClass("wait"),r.setRunEnabled(!0),o("#runSourceCodeEditor").removeClass("disabled")):"busy"===c.robot.state?(o("#head-navi-icon-robot").removeClass("wait"),o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").addClass("busy"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled")):(o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),o("#head-navi-icon-robot").addClass("error"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled")))},e.prototype.terminate=function(){t.prototype.terminate.call(this),this.terminated=!0,this.selectedNode=void 0,this.publishDisonnected(),c.gui.blocklyWorkspace.robControls.hideStopProgram()},e.prototype.publishConnected=function(){this.startTime=Date.now(),c.robot.fWName=r.getRobotRealName(),c.robot.time=0,c.robot.battery="-",c.robot.name=this.selectedNode.name,c.robot.state="wait",r.updateMenuStatus(1)},e.prototype.publishDisonnected=function(){c.robot.fWName="",c.robot.time=-1,c.robot.battery="-",c.robot.name="",c.robot.state="error",r.updateMenuStatus(0)},e.prototype.uploadProgram=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:if(c.robot.time=this.startTime-Date.now(),!this.selectedNode||this.selectedNode.status!==p.NodeStatus.ready)return[3,8];e.label=1;case 1:return e.trys.push([1,6,,7]),[4,this.selectedNode.lock()];case 2:return e.sent(),[4,this.selectedNode.sendAsebaProgram(t)];case 3:return e.sent(),[4,this.selectedNode.runProgram()];case 4:return e.sent(),[4,this.selectedNode.unlock()];case 5:return e.sent(),[2,"done"];case 6:throw e.sent();case 7:return[3,9];case 8:throw new Error("Exception on upload program");case 9:return[2]}}))}))},e.prototype.stopProgram=function(){this.uploadProgram(e.STOP_PROGRAM).then((function(t){"done"==t&&a.displayInformation({rc:"ok"},"MESSAGE_EDIT_START",null,r.getProgramName(),r.getRobot())}),(function(t){a.displayInformation({rc:"error"},null,t,r.getProgramName(),r.getRobot())}))},e.URL="ws://localhost:8597",e.STOP_PROGRAM="motor.left.target = 0\nmotor.right.target = 0\ncall sound.system(-1)\ncall leds.circle(32,32,32,32,32,32,32,32)\ntimer.period[0] = 100\nonevent timer0\ncall leds.circle(0,0,0,0,0,0,0,0)\n",e}(n.AbstractConnection);!function(t){t[t.DEVICE_INFORMATION_SERVICE_UUID=6154]="DEVICE_INFORMATION_SERVICE_UUID",t.NORDIC_UART_SERVICE_UUID="6e400001-b5a3-f393-e0a9-e50e24dcca9e",t.PYBRICKS_SERVICE_UUID="c5f50001-8280-46da-89f4-6d8051e4aeef",t.PYBRICKS_COMMAND_EVENT_UUID="c5f50002-8280-46da-89f4-6d8051e4aeef",t.PYBRICKS_HUB_CAPABILITIES_CHARACTERISTIC_UUID="c5f50003-8280-46da-89f4-6d8051e4aeef"}(E||(E={})),function(t){t[t.STOP_USER_PROGRAM=0]="STOP_USER_PROGRAM",t[t.START_USER_PROGRAM=1]="START_USER_PROGRAM",t[t.START_REPL=2]="START_REPL",t[t.WRITE_USER_PROGRAM_META=3]="WRITE_USER_PROGRAM_META",t[t.COMMAND_WRITE_USER_RAM=4]="COMMAND_WRITE_USER_RAM",t[t.PBIO_PYBRICKS_COMMAND_REBOOT_TO_UPDATE_MODE=5]="PBIO_PYBRICKS_COMMAND_REBOOT_TO_UPDATE_MODE",t[t.WRITE_STDIN=6]="WRITE_STDIN"}(C||(C={})),function(t){t[t.PASS=0]="PASS",t[t.INFORMATION=1]="INFORMATION",t[t.ALERT=2]="ALERT"}(v||(v={}));var S=function(t){function e(n,o,r){var i=t.call(this," ")||this;return i.blocklyMessage="",i.alertType=v.PASS,void 0!==n&&null!=n&&(i.message=n.message),i.blocklyMessage=o,i.alertType=r,i.name=e.NAME,i}return __extends(e,t),e.NAME="BleError",e}(Error),y=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.gattServer=null,e.bleDevice=null,e.downloadInProgress=!1,e.oldProgram="",e.ping=!1,e}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),r.getBlocklyWorkspace().robControls.showStopProgram(),o("#stopProgram").addClass("disabled")},e.prototype.terminate=function(){t.prototype.terminate.call(this),o("#stopProgram").addClass("disabled"),r.getBlocklyWorkspace().robControls.hideStopProgram(),this.disconnect()},e.prototype.run=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n=this;return __generator(this,(function(i){switch(i.label){case 0:if("ok"!=t.rc)return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.connect().then((function(){return __awaiter(n,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:return this.showProgressBarModal(),this.setResetModalListener(),[4,this.downloadProgram(t.compiledCode,this.setTransferProgress).then((function(){return __awaiter(e,void 0,void 0,(function(){return __generator(this,(function(t){return setTimeout((function(){o("#save-client-compiled-program").modal("hide")}),500),[2]}))}))})).finally((function(){e.downloadInProgress||e.startPingDevice()}))];case 1:return n.sent(),[2]}}))}))}))];case 2:return i.sent(),[3,4];case 3:return e=i.sent(),console.log(e),e.name===S.NAME&&(console.log(e.blocklyMessage),e.alertType===v.ALERT&&("BLE_ERROR_COMMUNICATION"==e.blocklyMessage&&o("#save-client-compiled-program").modal("hide"),a.displayInformation({rc:"error"},null,e.blocklyMessage))),[3,4];case 4:return[3,6];case 5:a.displayInformation(t,t.message,t.message,r.getProgramName(),r.getRobot()),i.label=6;case 6:return o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").addClass("wait"),r.setRunEnabled(!0),o("#stopProgram").addClass("disabled"),[2]}}))}))},e.prototype.stopProgram=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.writeGatt(E.PYBRICKS_COMMAND_EVENT_UUID,new Uint8Array([C.STOP_USER_PROGRAM]))];case 1:return e.sent(),[3,3];case 2:throw t=e.sent(),new S(t,"BLE_ERROR_STOP",v.INFORMATION);case 3:return[2]}}))}))},e.prototype.setState=function(){},e.prototype.showRobotInfo=function(){t.prototype.showRobotInfo.call(this)},e.prototype.stopPingDevice=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.ping=!1,[4,new Promise((function(t){return setTimeout(t,500)}))];case 1:return t.sent(),[2]}}))}))},e.prototype.startPingDevice=function(){this.ping=!0,this.pingDevice()},e.prototype.pingDevice=function(){return __awaiter(this,void 0,void 0,(function(){var t=this;return __generator(this,(function(e){return this.ping&&this.isConnected()?(o("#stopProgram").removeClass("disabled"),setTimeout((function(){o("#stopProgram").removeClass("disabled"),t.pingDevice()}),250)):o("#stopProgram").addClass("disabled"),[2]}))}))},e.prototype.connect=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.stopPingDevice()];case 1:return t.sent(),this.isConnected()?[2]:[4,this.assertWebBleAvailability()];case 2:return t.sent(),[4,this.requestDevice()];case 3:return t.sent(),[4,this.connectToGattServer()];case 4:return t.sent(),[4,this.getHubCapabilities()];case 5:return t.sent(),[2]}}))}))},e.prototype.downloadProgram=function(t,n){return __awaiter(this,void 0,void 0,(function(){var o,r,i;return __generator(this,(function(s){switch(s.label){case 0:if(o=e.encodeProgram(t),r=this.maxWriteSize-e.HEADER_SIZE,this.downloadInProgress)throw new S(null,"BLE_DOWNLOAD_IN_PROGRESS",v.INFORMATION);if(o.size>this.maxProgramSize)throw new S(null,"BLE_ERROR_PROGRAM_SIZE",v.ALERT);return this.downloadInProgress||this.oldProgram!=t?[3,3]:(n(1),[4,this.stopProgram()]);case 1:return s.sent(),[4,this.startProgram()];case 2:return[2,s.sent()];case 3:return s.trys.push([3,9,10,11]),this.downloadInProgress=!0,[4,this.stopProgram()];case 4:return s.sent(),[4,this.invalidateProgram()];case 5:return s.sent(),[4,this.transferProgramAsChunks(o,r,n)];case 6:return s.sent(),[4,this.updateProgramSize(o.size)];case 7:return s.sent(),this.oldProgram=t,[4,this.startProgram()];case 8:return s.sent(),[3,11];case 9:throw i=s.sent(),this.oldProgram="",new S(i,"BLE_ERROR_COMMUNICATION",v.ALERT);case 10:return this.downloadInProgress=!1,[7];case 11:return[2]}}))}))},e.prototype.disconnect=function(){null!=this.gattServer&&this.gattServer.disconnect(),this.gattServer=null,this.bleDevice=null},e.prototype.isConnected=function(){return null!==this.gattServer&&this.gattServer.connected},e.prototype.assertWebBleAvailability=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:if(!s.isWebBleSupported())throw new S(null,"BLE_NOT_SUPPORTED",v.ALERT);if(void 0===navigator.bluetooth)throw new S(null,"BLE_FEATURE_DISABLED",v.ALERT);return[4,navigator.bluetooth.getAvailability()];case 1:if(!t.sent())throw new S(null,"BLE_ADAPTER_DISABLED",v.ALERT);return[2]}}))}))},e.prototype.requestDevice=function(){return __awaiter(this,void 0,void 0,(function(){var t,e;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),t=this,[4,navigator.bluetooth.requestDevice({filters:[{services:[E.PYBRICKS_SERVICE_UUID]}],optionalServices:[E.PYBRICKS_SERVICE_UUID,E.DEVICE_INFORMATION_SERVICE_UUID,E.NORDIC_UART_SERVICE_UUID]})];case 1:return t.bleDevice=n.sent(),[3,3];case 2:throw e=n.sent(),new S(e,"BLE_NO_DEVICE_SELECTED",v.ALERT);case 3:return[2]}}))}))},e.prototype.connectToGattServer=function(){return __awaiter(this,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.bleDevice.gatt.connect().then((function(t){return e.gattServer=t}))];case 1:return n.sent(),[3,3];case 2:throw t=n.sent(),new S(t,"BLE_ERROR_DEVICE_BUSY",v.ALERT);case 3:return[2]}}))}))},e.prototype.getHubCapabilities=function(){return __awaiter(this,void 0,void 0,(function(){var t,e=this;return __generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.gattServer.getPrimaryService(E.PYBRICKS_SERVICE_UUID).then((function(t){return __awaiter(e,void 0,void 0,(function(){var e=this;return __generator(this,(function(n){switch(n.label){case 0:return[4,t.getCharacteristic(E.PYBRICKS_HUB_CAPABILITIES_CHARACTERISTIC_UUID).then((function(t){return __awaiter(e,void 0,void 0,(function(){var e;return __generator(this,(function(n){switch(n.label){case 0:return[4,t.readValue()];case 1:return e=n.sent(),this.maxWriteSize=e.getUint16(0,!0),this.maxProgramSize=e.getUint32(6,!0),[2]}}))}))}))];case 1:return n.sent(),[2]}}))}))}))];case 1:return n.sent(),[3,3];case 2:throw t=n.sent(),new S(t,"BLE_ERROR_CAPABILITIES",v.ALERT);case 3:return[2]}}))}))},e.prototype.transferProgramAsChunks=function(t,e,n){return __awaiter(this,void 0,void 0,(function(){var o,r,i;return __generator(this,(function(s){switch(s.label){case 0:o=t.size>e?e:t.size,r=0,s.label=1;case 1:return r<t.size?[4,t.slice(r,r+o).arrayBuffer()]:[3,5];case 2:return i=s.sent(),[4,this.writeToUserRam(r,i)];case 3:s.sent(),null!==n&&n((r+i.byteLength)/t.size),s.label=4;case 4:return r+=o,[3,1];case 5:return[2]}}))}))},e.prototype.writeGatt=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n=this;return __generator(this,(function(o){switch(o.label){case 0:return[4,this.gattServer.getPrimaryService(E.PYBRICKS_SERVICE_UUID).then((function(o){return __awaiter(n,void 0,void 0,(function(){var n=this;return __generator(this,(function(r){switch(r.label){case 0:return[4,o.getCharacteristic(t).then((function(t){return __awaiter(n,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,t.writeValueWithResponse(e)];case 1:return n.sent(),[2]}}))}))}))];case 1:return r.sent(),[2]}}))}))}))];case 1:return o.sent(),[2]}}))}))},e.prototype.startProgram=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.writeGatt(E.PYBRICKS_COMMAND_EVENT_UUID,new Uint8Array([C.START_USER_PROGRAM]))];case 1:return t.sent(),[2]}}))}))},e.prototype.writeToUserRam=function(t,n){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(o){switch(o.label){case 0:return[4,this.writeGatt(E.PYBRICKS_COMMAND_EVENT_UUID,e.createWriteUserRamCommand(t,n))];case 1:return o.sent(),[2]}}))}))},e.prototype.updateProgramSize=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(n){switch(n.label){case 0:return[4,this.writeGatt(E.PYBRICKS_COMMAND_EVENT_UUID,e.createWriteUserProgramMetaCommand(t))];case 1:return n.sent(),[2]}}))}))},e.prototype.invalidateProgram=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.updateProgramSize(0)];case 1:return t.sent(),[2]}}))}))},e.encodeProgram=function(t){var n=e.encodeMpyBinary(t),o=[];return o.push(e.encodeProgramLength(n.length)),o.push(e.encodeProgramName("__main__")),o.push(n),new Blob(o)},e.encodeMpyBinary=function(t){for(var e=t.split(","),n=new Uint8Array(e.length),o=0;o<e.length;o++)n[o]=Number(e[o]);return n},e.encodeProgramLength=function(t){var e=new ArrayBuffer(4);return new DataView(e).setUint32(0,t,!0),e},e.encodeProgramName=function(t){return(new TextEncoder).encode(t+"\0")},e.createWriteUserRamCommand=function(t,n){var o=new Uint8Array(e.HEADER_SIZE+n.byteLength),r=new DataView(o.buffer);return r.setUint8(0,C.COMMAND_WRITE_USER_RAM),r.setUint32(1,t,!0),o.set(new Uint8Array(n),e.HEADER_SIZE),o},e.createWriteUserProgramMetaCommand=function(t){var n=new Uint8Array(e.HEADER_SIZE),o=new DataView(n.buffer);return o.setUint8(0,C.WRITE_USER_PROGRAM_META),o.setUint32(1,t,!0),n},e.HEADER_SIZE=5,e}(n.AbstractPromptConnection),w=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),this.isSelected=!1,this.shortFormForDownloadPopup=r.getRobotGroup().toUpperCase()},e.prototype.run=function(t){var e=this;if(r.setState(t),"ok"==t.rc){var n=!1;if(s.isWebUsbSupported()&&r.getVendor()&&"na"!==r.getVendor()){n=!0;var i=o("#popupDownloadHeader").text();o("#popupDownloadHeader").text(i.replace("$",o.trim(r.getRobotRealName()))),o("#programHint").addClass("hidden"),o("#changedDownloadFolder").addClass("hidden"),o("#OKButtonModalFooter").addClass("hidden"),this.isWebUsbSelected()?this.runWebUsbConnection(t):(o("#downloadType").removeClass("hidden"),o("#webUsb").oneWrap("click",(function(n){e.setIsWebUsbSelected(!0),e.runWebUsbConnection(t)})),o("#fileDownload").oneWrap("click",(function(n){o("#downloadType").addClass("hidden"),o("#programHint").removeClass("hidden"),o("#changedDownloadFolder").removeClass("hidden"),o("#OKButtonModalFooter").removeClass("hidden"),e.runFileDownload(t,e.shortFormForDownloadPopup,e.skipDownloadPopup)})))}else this.runFileDownload(t,this.shortFormForDownloadPopup,this.skipDownloadPopup);if(n=n||!(this.skipDownloadPopup||null!==navigator.userAgent.toLowerCase().match(/iPad|iPhone|android/i))){i=o("#popupDownloadHeader").text();o("#popupDownloadHeader").text(i.replace("$",o.trim(r.getRobotRealName()))),o("#save-client-compiled-program").oneWrap("hidden.bs.modal",(function(t){var n=o("#popupDownloadHeader").text();o("#popupDownloadHeader").text(n.replace(o.trim(r.getRobotRealName()),"$")),o("#label-checkbox").is(":checked")&&e.setSkipDownloadPopup(!0),o("#programLink").remove(),o("#download-instructions").empty(),o("#programHint").removeClass("hidden"),o("#changedDownloadFolder").removeClass("hidden"),o("#OKButtonModalFooter").removeClass("hidden"),o("#downloadType").addClass("hidden"),o("#status").addClass("hidden"),o("#progressBar").width("0%"),o("#transfer").text("0%"),o("#webUsb").off("click"),o("#fileDownload").off("click"),r.setConnectionState("wait")})),o("#save-client-compiled-program").modal("show")}}else r.setConnectionState("wait"),a.displayInformation(t,t.message,t.message,r.getProgramName(),r.getRobot())},e.prototype.terminate=function(){t.prototype.terminate.call(this),this.clearDownloadModal(),this.isConnected()&&this.removeDevice()},e.prototype.runWebUsbConnection=function(t){var e=this;o("#downloadType").addClass("hidden"),o("#status").removeClass("hidden"),this.connect(r.getVendor(),t.compiledCode).then((function(n){"done"==n?a.displayInformation(t,"MESSAGE_EDIT_START",t.message,r.getProgramName(),r.getRobot()):"disconnected"==n?setTimeout((function(){e.runWebUsbConnection(t)}),100):"flashing"==n||o("#save-client-compiled-program").modal("hide"),r.setConnectionState("wait"),c.robot.state="wait"}))},e.prototype.setState=function(){},e.prototype.connect=function(t,e){return __awaiter(this,void 0,void 0,(function(){var n,o;return __generator(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),void 0!==this.device?[3,2]:(n=this,[4,navigator.usb.requestDevice({filters:this.deviceFilters(t)})]);case 1:n.device=i.sent(),i.label=2;case 2:return[4,this.upload(e)];case 3:return[2,i.sent()];case 4:return(o=i.sent()).message&&-1===o.message.indexOf("selected")&&a.displayInformation({rc:"error"},null,o.message,r.getProgramName(),r.getRobot()),[3,5];case 5:return[2]}}))}))},e.prototype.upload=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,o,i=this;return __generator(this,(function(s){switch(s.label){case 0:return s.trys.push([0,6,,7]),void 0!==this.target&&this.target.connected?[3,4]:(e=new l.WebUSB(this.device),this.target=new l.DAPLink(e),n=this.stringToArrayBuffer(t),this.target.on(l.DAPLink.EVENT_PROGRESS,(function(t){i.setTransferProgress(t)})),[4,this.target.connect()]);case 1:return s.sent(),[4,this.target.flash(n)];case 2:return s.sent(),[4,this.target.disconnect()];case 3:return s.sent(),[3,5];case 4:return[2,"flashing"];case 5:return[3,7];case 6:return o=s.sent(),this.removeDevice(),o.message&&-1!==o.message.indexOf("disconnected")?[2,"disconnected"]:(a.displayInformation({rc:"error"},null,o.message,r.getProgramName(),r.getRobot()),[2,"error"]);case 7:return[2,"done"]}}))}))},e.prototype.deviceFilters=function(t){for(var e=new Array,n=0,o=t.split(",");n<o.length;n++){var r=o[n];e.push({vendorId:+r})}return e},e.prototype.stringToArrayBuffer=function(t){return(new TextEncoder).encode(t)},e.prototype.removeDevice=function(){this.target=void 0,this.device=void 0},e.prototype.isConnected=function(){return void 0!==this.device},e.prototype.isWebUsbSelected=function(){return this.isSelected},e.prototype.setIsWebUsbSelected=function(t){this.isSelected=t},e}(n.AbstractPromptConnection),P=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled"),o("#menuConnect").parent().removeClass("disabled"),r.setPingTime(r.SHORT),r.setPing(!0)},e.prototype.setState=function(){o("#menuConnect").parent().removeClass("disabled"),"wait"===c.robot.state?(o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").addClass("wait"),r.setRunEnabled(!0),o("#runSourceCodeEditor").removeClass("disabled")):"busy"===c.robot.state?(o("#head-navi-icon-robot").removeClass("wait"),o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").addClass("busy"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled")):(o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),o("#head-navi-icon-robot").addClass("error"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled"))},e.prototype.isRobotConnected=function(){return c.robot.time>0},e.prototype.run=function(t){r.setState(t),a.displayInformation(t,t.message,t.message,t.programName||r.getProgramName(),r.getRobot()),"ok"==t.rc?d.Msg["MENU_ROBOT_STOP_HINT_"+r.getRobotGroup().toUpperCase()]&&a.displayMessage("MENU_ROBOT_STOP_HINT_"+r.getRobotGroup().toUpperCase(),"TOAST"):r.setConnectionState("error")},e.prototype.showConnectionModal=function(){o("#buttonCancelFirmwareUpdate").css("display","inline"),o("#buttonCancelFirmwareUpdateAndRun").css("display","none"),u.showSetTokenModal(8,8)},e.prototype.stopProgram=function(){i.stopProgram((function(){}))},e}(n.AbstractConnection);function A(t){t=t.toLowerCase();for(var e=0,n=r.getVendor().split(",");e<n.length;e++){if(n[e]===t)return!0}return!1}var I=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.portList=[],e.vendorList=[],e.productList=[],e.robotList=[],e.agentPortList='[{"Name":"none","IdVendor":"none","IdProduct":"none"}]',e}return __extends(e,t),e.prototype.init=function(){var e=this;t.prototype.init.call(this);var n=m.getSocket();null!=n&&0!=m.getIsAgent()||(n=b("ws://127.0.0.1:8991/"),m.setSocket(n),m.setIsAgent(!0),o("#menuConnect").parent().addClass("disabled"),n.on("connect_error",(function(t){m.setIsAgent(!1)})),n.on("connect",(function(){n.emit("command","log on"),m.setIsAgent(!0),window.setInterval((function(){e.portList=[],e.vendorList=[],e.productList=[],e.robotList=[],n.emit("command","list")}),3e3)})),n.on("message",(function(t){if(t.includes('"Network": false'))(i=JSON.parse(t)).Ports.forEach((function(t){A(t.VendorID)&&(e.portList.push(t.Name),e.vendorList.push(t.VendorID),e.productList.push(t.ProductID),e.robotList.push(r.getRobotRealName()))})),m.setIsAgent(!0),n.on("connect_error",(function(t){m.setIsAgent(!1),o("#menuConnect").parent().removeClass("disabled")})),e.portList.indexOf(r.getRobotPort())<0&&(r.getRobotPort(),r.setRobotPort("")),1==e.portList.length&&u.setPort(e.portList[0]),r.updateMenuStatus(e.getPortList().length);else if(t.includes("OS")){var i=JSON.parse(t);e.system=i.OS}})),n.on("disconnect",(function(){})),n.on("error",(function(t){}))),this.listRobotStart()},e.prototype.isRobotConnected=function(){return!0},e.prototype.terminate=function(){this.listRobotStop(),this.closeConnection(),t.prototype.terminate.call(this)},e.prototype.showConnectionModal=function(){if(1==m.getIsAgent()){var e=this.getPortList(),n=this.getRobotList();o("#singleModalListInput").empty();var r=0;e.forEach((function(t){o("#singleModalListInput").append('<option value="'+t+'" selected>'+n[r]+" "+t+"</option>"),r++})),u.showListModal()}else t.prototype.showConnectionModal.call(this)},e.prototype.run=function(t){o("#menuRunProg").parent().addClass("disabled"),o("#head-navi-icon-robot").addClass("busy"),r.setState(t),"ok"==t.rc?(this.uploadProgram(t.compiledCode,r.getRobotPort()),setTimeout((function(){r.setConnectionState("error")}),5e3)):r.setConnectionState("error"),a.displayInformation(t,t.message,t.message,r.getProgramName())},e.prototype.setState=function(){!0!==m.getIsAgent()&&(o("#menuConnect").parent().removeClass("disabled"),"wait"===c.robot.state?(o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").addClass("wait"),r.setRunEnabled(!0),o("#runSourceCodeEditor").removeClass("disabled")):"busy"===c.robot.state?(o("#head-navi-icon-robot").removeClass("wait"),o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").addClass("busy"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled")):(o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),o("#head-navi-icon-robot").addClass("error"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled")))},e.prototype.updateMenuStatus=function(t){switch(t){case 0:m.setIsAgent(!1);break;case 1:m.setIsAgent(!0),o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").addClass("wait"),r.setRunEnabled(!0),o("#runSourceCodeEditor").removeClass("disabled"),o("#menuConnect").parent().addClass("disabled");break;default:m.setIsAgent(!0),o("#menuConnect").parent().removeClass("disabled"),""==r.getRobotPort()?(o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),r.setRunEnabled(!1)):(o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").addClass("wait"),r.setRunEnabled(!0),o("#runSourceCodeEditor").removeClass("disabled"))}},e.prototype.makeRequest=function(){var t=this;this.portList=[],this.vendorList=[],this.productList=[],this.robotList=[],f.listRobotsFromAgent((function(t){}),(function(e){t.agentPortList=e.responseText}),(function(){}));try{JSON.parse(this.agentPortList).forEach((function(e){A(e.IdVendor)&&(t.portList.push(e.Name),t.vendorList.push(e.IdVendor),t.productList.push(e.IdProduct),t.robotList.push(r.getRobotRealName()))}))}catch(t){r.setRobotPort("")}this.portList.indexOf(r.getRobotPort())<0&&r.setRobotPort(""),1==this.portList.length&&u.setPort(this.portList[0]),r.updateMenuStatus(this.getPortList().length)},e.prototype.listRobotStart=function(){var t=this;o("#menuConnect").parent().addClass("disabled"),this.makeRequest(),this.timerId=window.setInterval((function(){t.makeRequest()}),3e3)},e.prototype.listRobotStop=function(){o("#menuConnect").parent().addClass("disabled"),window.clearInterval(this.timerId)},e.prototype.closeConnection=function(){var t=m.getSocket();null!=t&&(t.disconnect(),m.setSocket(null))},e.prototype.getPortList=function(){return this.portList},e.prototype.getRobotList=function(){return this.robotList},e.prototype.uploadProgram=function(t,e){f.sendProgramHexToAgent(t,e,r.getProgramName(),r.getSignature(),r.getCommandLine(),(function(){g.text("Create agent upload success"),o("#menuRunProg").parent().removeClass("disabled"),o("#runOnBrick").parent().removeClass("disabled")}))},e}(P),U=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){this.reset=!1,o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),r.setRunEnabled(!1),o("#menuConnect").parent().removeClass("disabled"),r.inWebview()?o("#robotConnect").removeClass("disabled"):o("#robotConnect").addClass("disabled"),o("#runSourceCodeEditor").addClass("disabled"),r.setPingTime(r.LONG)},e.prototype.isRobotConnected=function(){return _.isRobotConnected()},e.prototype.run=function(t){if(a.displayInformation(t,t.message,t.message,r.getProgramName()),"ok"===t.rc){var e=t.compiledCode,n=JSON.parse(e);if(this.interpreter=_.getInterpreter(n),null!==this.interpreter){r.setConnectionState("busy"),r.getBlocklyWorkspace().robControls.switchToStop();try{this.runStepInterpreter()}catch(t){this.interpreter.terminate(),this.interpreter=null,alert(t)}}}},e.prototype.runStepInterpreter=function(){if(!this.interpreter.isTerminated()&&!this.reset){var t=(new Date).getTime()+100,e=Math.max(100,this.interpreter.run(t));this.timeout(this.runStepInterpreter,e)}},e.prototype.timeout=function(t,e){e>100?(e-=100,setTimeout(this.timeout,100,(function(){t()}),e)):setTimeout((function(){t()}),e)},e.prototype.setState=function(){},e.prototype.stopProgram=function(){null!==this.interpreter&&this.interpreter.terminate()},e.prototype.showConnectionModal=function(){u.showScanModal()},e}(n.AbstractConnection),T=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),this.shortFormForDownloadPopup="MINI"},e}(w),O=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(I);e.Bob3Connection=O;var B=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(I);e.BotnrollConnection=B;var D=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.FestobionicflowerConnection=D;var N=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.FestobionicConnection=N;var M=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.MbotConnection=M;var L=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.MegaConnection=L;var W=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.NanoConnection=W;var x=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.Nano33bleConnection=x;var V=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(I);e.Rob3rtaConnection=V;var k=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),o("#robotWlan").removeClass("hidden")},e.prototype.terminate=function(){t.prototype.terminate.call(this),o("#robotWlan").addClass("hidden")},e}(w);e.SenseboxConnection=k;var G=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.UnoConnection=G;var H=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.Unowifirev2Connection=H;var F=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.Mbot2Connection=F;var K=function(t){function e(){var n=null!==t&&t.apply(this,arguments)||this;return n.switchedOnce=!1,n.shortLong="long",n.urlAPI=e.API_URL+e.API_LONG,n}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),(s.isChromeOS()||s.isWindowsOS())&&(this.urlAPI=e.API_URL+e.API_SHORT,this.shortLong="short")},e.prototype.run=function(t){if("ok"!==t.rc)r.setConnectionState("wait"),a.displayInformation(t,t.message,t.message,r.getProgramName(),r.getRobot());else{o("#changedDownloadFolder").addClass("hidden"),o("#OKButtonModalFooter").addClass("hidden");var n,s=o("#popupDownloadHeader").text();o("#popupDownloadHeader").text(s.replace("$",r.getRobotRealName().trim()));for(var c=1;d.Msg["POPUP_DOWNLOAD_STEP_"+c];c++){var u=o('<li class="typcn typcn-roberta">'),l=d.Msg["POPUP_DOWNLOAD_STEP_"+c+"_"+r.getRobotGroup().toUpperCase()]||d.Msg["POPUP_DOWNLOAD_STEP_"+c]||"POPUP_DOWNLOAD_STEP_"+c;u.html('<span class="download-message">'+l+"</span>"),o("#download-instructions").append(u)}o("#save-client-compiled-program").oneWrap("hidden.bs.modal",(function(t){r.setConnectionState("wait"),n&&!window.msCrypto&&(n.pause(),n.load()),p.clearDownloadModal()})),o("body>.pace").fadeIn();var p=this,h=function(t){r.setConnectionState("wait"),p.clearDownloadModal(),o("body>.pace").fadeOut(400,(function(){a.displayPopupMessage("ORA_COMPILERWORKFLOW_ERROR_EXTERN_FAILED",t,"OK")}))},_=function(r){try{if("true"==r.compile){var s=r.wav;n=new Audio(s),p.createPlayButton(n),o("body>.pace").fadeOut(400,(function(){o("#save-client-compiled-program").modal("show")}))}else{r.message.toLowerCase().indexOf("permission denied")>=0&&!p.switchedOnce?(p.switchedOnce=!0,"long"===p.shortLong?p.urlAPI=e.API_URL+e.API_SHORT:p.urlAPI=e.API_URL+e.API_LONG,i.externAPIRequest(p.urlAPI,t.compiledCode,_,f)):h("Compiler Error:<br>"+r.message)}}catch(t){h("API "+p.urlAPI+" usage error")}},f=function(t){h("Compiler "+p.urlAPI+" not available, please try it again later!")};i.externAPIRequest(this.urlAPI,t.compiledCode,_,f)}},e.prototype.createPlayButton=function(t){var e;if("Blob"in window){(e=document.createElement("button")).setAttribute("type","button"),e.setAttribute("class","btn btn-primary");var n=!1;e.onclick=function(){0==n?(t.play(),r.setAttribute("class","typcn typcn-media-stop"),n=!0,t.addEventListener("ended",(function(){o("#save-client-compiled-program").modal("hide")}))):(r.setAttribute("class","typcn typcn-media-play"),t.pause(),t.load(),n=!1)};var r=document.createElement("span");r.setAttribute("class","typcn typcn-media-play"),r.setAttribute("style","color : #333333"),e.appendChild(r)}if(e){var i=document.createElement("div");i.setAttribute("id","programLink"),i.setAttribute("style","text-align: center;"),i.appendChild(document.createElement("br")),i.appendChild(e),e.setAttribute("style","font-size:36px"),o(i).appendTo("#downloadLink")}},e.prototype.setState=function(){},e.prototype.terminate=function(){t.prototype.terminate.call(this),this.clearDownloadModal()},e.API_URL="https://api.edisonrobotics.net/",e.API_LONG="ep/wav/long",e.API_SHORT="ep/wav/short",e}(n.AbstractPromptConnection);e.Edisonv2Connection=K;var q=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.EV3_WEBUSB_HEADER=88,e.EV3_WEBUSB_CMD_GET_FIRMWARE_VERSION=16,e.EV3_WEBUSB_CMD_GET_SERIAL_NUMBER=17,e.EV3_WEBUSB_CMD_PUT_USER_PROGRAM=20,e.EV3_WEBUSB_CMD_STOP_USER_PROGRAM=22,e.EV3_WEBUSB_CMD_USER_DATA_IN=24,e.EV3_WEBUSB_CMD_CHANGED_STATE=25,e.EV3_WEBUSB_CMD_GET_PERSISTENT_DATA=28,e.EV3_VARIANT_CODE_BOOTLOADER=0,e.EV3_STATE_CHANGE_DRIVE_CALIBRATION_COMPLETE=1,e.EV3_STATE_CHANGE_OBSTACLE_CALIBRATION_COMPLETE=2,e.EV3_STATE_CHANGE_USER_PROGRAM_COMPLETE=3,e.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_SUCCESS=0,e.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_NO_FILE=1,e.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_USER_ABORT=2,e.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_EXCEPTION=3,e.urlAPI="https://api.edisonrobotics.net/open_roberta/compile",e}return __extends(e,t),e.prototype.run=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n=this;return __generator(this,(function(c){return"ok"!==t.rc?(r.setConnectionState("wait"),a.displayInformation(t,t.message,t.message,r.getProgramName(),r.getRobot())):s.isWebUsbSupported()&&r.getVendor()&&"na"!==r.getVendor()?(e=this).connect(r.getVendor()).then((function(r){n.webUSBPendingInData=null,n.webUSBPendingInResolve=null,r?(o("body>.pace").fadeIn(),i.externAPIRequest(n.url,t.compiledCode,(function(t){if(t&&!t.hex)return"No path found."===t?e.finishRunAction({rc:"error",message:"ORA_COMPILERWORKFLOW_ERROR_EXTERN_FAILED"}):!1===t.compile?e.finishRunAction({rc:"error",message:"ORA_COMPILERWORKFLOW_ERROR_PROGRAM_COMPILE_FAILED",parameters:{MESSAGE:JSON.parse(t.message).messages}}):e.finishRunAction({rc:"ok"});var o=n.processAPIHexString(t.hex);"ok"===o.rc?n.upload(o.data).then((function(t){return e.finishRunAction(t)})):n.finishRunAction(o)}),(function(t){n.finishRunAction({rc:"error",message:"ORA_COMPILERWORKFLOW_ERROR_EXTERN_FAILED",parameters:{MESSAGE:t.statusText}})}))):n.finishRunAction({rc:"ok"})}),(function(t){return n.finishRunAction({rc:"ok"})})):this.finishRunAction({rc:"error",message:"WEBUSB_NOT_SUPPORTED"}),[2]}))}))},e.prototype.finishRunAction=function(t){r.setConnectionState("wait"),c.robot.state="wait",o("body>.pace").fadeOut(),"ok"!==t.rc&&a.displayInformation(t,t.message,t.message,r.getProgramName(),null)},e.prototype.webUSBOpenConnection=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,n,o,i;return __generator(this,(function(s){switch(s.label){case 0:return s.trys.push([0,10,,11]),t=this,[4,navigator.usb.requestDevice({filters:[{vendorId:r.getVendor()}]})];case 1:return t.device=s.sent(),[4,this.device.open()];case 2:return s.sent(),[4,this.device.selectConfiguration(1)];case 3:return s.sent(),[4,this.device.claimInterface(0)];case 4:return s.sent(),this.webUSBPendingInData=null,this.webUSBPendingInResolve=null,this.device.transferIn(1,64).then(this.webUSBTransferInReady.bind(this)),e=this.urlAPI,[4,this.getEV3FirmwareVersion()];case 5:return(n=s.sent())[0]!=this.EV3_VARIANT_CODE_BOOTLOADER&&(n[2].startsWith("v0.1.0")||n[2].startsWith("v0.2.0")||n[1].startsWith("v0.3.0"))?[4,this.webUSBCommandStopUserProgram()]:[3,7];case 6:s.sent(),s.label=7;case 7:return[4,this.getEdisonV3UID()];case 8:return o=s.sent(),[4,this.webUSBCommandGetPersistentData()];case 9:return i=s.sent(),e=e+"?versionFirmware="+n[2],e+="&strUniqueID=",e=(e+=o)+"&versionBootloader="+n[1],this.url=e+"&strUsage=["+i+"]",[2,!0];case 10:return s.sent(),[2,!1];case 11:return[2]}}))}))},e.prototype.connect=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return[4,this.webUSBEnsureConnected()];case 1:return[2,t.sent()]}}))}))},e.prototype.webUSBTransferInReady=function(t){if("ok"==t.status)if(6==t.data.byteLength&&t.data.getUint8(0)==this.EV3_WEBUSB_HEADER&&t.data.getUint8(1)==this.EV3_WEBUSB_CMD_USER_DATA_IN)t.data.getUint8(2),t.data.getUint8(3),t.data.getUint8(4),t.data.getUint8(5);else if(4==t.data.byteLength&&t.data.getUint8(0)==this.EV3_WEBUSB_HEADER&&t.data.getUint8(1)==this.EV3_WEBUSB_CMD_CHANGED_STATE){var e=t.data.getUint8(2),n=t.data.getUint8(3);e==this.EV3_STATE_CHANGE_DRIVE_CALIBRATION_COMPLETE?3==n?"state change: drive calibration completed successfully":("state change: drive calibration failed: speed="+(n>>4),4&n&&", left failed to achieve target speed",8&n&&", right failed to achieve target speed"):e==this.EV3_STATE_CHANGE_OBSTACLE_CALIBRATION_COMPLETE?"state change: obstacle calibration complete":e==this.EV3_STATE_CHANGE_USER_PROGRAM_COMPLETE&&(n==this.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_SUCCESS?"state change: user program finished successfully":n==this.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_NO_FILE?"state change: user program doesn't exist":n==this.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_USER_ABORT?"state change: user program stopped by square button":n==this.EV3_STATE_CHANGE_ARG_USER_PROGRAM_COMPLETE_EXCEPTION&&"state change: user program had an exception")}else null!==this.webUSBPendingInResolve?(this.webUSBPendingInResolve(t),this.webUSBPendingInResolve=null):this.webUSBPendingInData=t;this.device.transferIn(1,64).then(this.webUSBTransferInReady.bind(this))},e.prototype.webUSBCommandStopUserProgram=function(){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return t=new Uint8Array([this.EV3_WEBUSB_HEADER,this.EV3_WEBUSB_CMD_STOP_USER_PROGRAM,0,0,0,0,0,0]),[4,this.webUSBTransferOut(t)];case 1:return e.sent(),[4,this.webUSBTransferIn(8)];case 2:return[2,e.sent()]}}))}))},e.prototype.getEV3FirmwareVersion=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,n,o,r,i,s,a;return __generator(this,(function(c){switch(c.label){case 0:return t=new Uint8Array([this.EV3_WEBUSB_HEADER,this.EV3_WEBUSB_CMD_GET_FIRMWARE_VERSION,0,0,0,0,0,0]),[4,this.device.transferOut(1,t)];case 1:return c.sent(),[4,this.webUSBTransferIn(64)];case 2:if((e=c.sent())&&"ok"==e.status){if(e.data.getUint8(0)!=this.EV3_WEBUSB_HEADER||e.data.getUint8(1)!=this.EV3_WEBUSB_CMD_GET_FIRMWARE_VERSION)return[2,[-1,"invalid"]];for(n=e.data.getUint8(2),o=e.data.getUint8(3),r="",s=0;s<o&&0!=(a=e.data.getUint8(4+s));s++)r+=String.fromCodePoint(a);for(i="",s=0;s<o&&0!=(a=e.data.getUint8(4+o+s));s++)i+=String.fromCodePoint(a);return[2,[n,r,i]]}return[2,[-1,"invalid"]]}}))}))},e.prototype.webUSBTransferIn=function(t){return __awaiter(this,void 0,void 0,(function(){var t;return __generator(this,(function(e){switch(e.label){case 0:return t=this,[4,null!==this.webUSBPendingInData?new Promise((function(e,n){var o=this.webUSBPendingInData;t.webUSBPendingInData=null,e(o)})):new Promise((function(e,n){t.webUSBPendingInResolve=e}))];case 1:return[2,e.sent()]}}))}))},e.prototype.webUSBEnsureConnected=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this.webUSBIsConnected()?[3,2]:[4,this.webUSBOpenConnection()];case 1:t.sent(),t.label=2;case 2:return[4,this.webUSBCommandStopUserProgram()];case 3:return[2,t.sent()]}}))}))},e.prototype.getEdisonV3UID=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,n,o,r;return __generator(this,(function(i){switch(i.label){case 0:return t=new Uint8Array([this.EV3_WEBUSB_HEADER,this.EV3_WEBUSB_CMD_GET_SERIAL_NUMBER,0,0,0,0,0,0]),[4,this.device.transferOut(1,t)];case 1:return i.sent(),[4,this.webUSBTransferIn(32)];case 2:if("ok"==(e=i.sent()).status){for(n=e.data.getUint8(3),o="",r=0;r<n;r++)o+=String.fromCodePoint(e.data.getUint8(4+r));return[2,o]}return[2,!1]}}))}))},e.prototype.webUSBCommandGetPersistentData=function(){return __awaiter(this,void 0,void 0,(function(){var t,e,n,o,r,i,s;return __generator(this,(function(a){switch(a.label){case 0:t=1024,e=null,n=this,o=0,a.label=1;case 1:return o<t?(r=new Uint8Array([n.EV3_WEBUSB_HEADER,n.EV3_WEBUSB_CMD_GET_PERSISTENT_DATA,255&o,o>>8,0,0,0,0]),[4,n.device.transferOut(1,r)]):[3,5];case 2:return a.sent(),[4,n.webUSBTransferIn(64)];case 3:if((i=a.sent()).data.getUint8(0)!=n.EV3_WEBUSB_HEADER||i.data.getUint8(1)!=n.EV3_WEBUSB_CMD_GET_PERSISTENT_DATA)return[2,null];for(t=i.data.getUint8(2)|i.data.getUint8(3)<<8,null===e&&(e=new Uint8Array(t)),s=0;s<60&&o+s<t;++s)e[o+s]=i.data.getUint8(4+s);o+=60,a.label=4;case 4:return[3,1];case 5:return[2,e]}}))}))},e.prototype.webUSBIsConnected=function(){return void 0!==this.device&&!!this.device.opened},e.prototype.upload=function(t){return __awaiter(this,void 0,void 0,(function(){var e,n,o,r,i,s;return __generator(this,(function(a){switch(a.label){case 0:for(e=t.length,(n=new Uint8Array([this.EV3_WEBUSB_HEADER,this.EV3_WEBUSB_CMD_PUT_USER_PROGRAM,0,0,0,0,0,0]))[2]=e,n[3]=e>>8,o=!0,r=0,i=0;i<t.length;i++)o?(r^=t[i],o=!1):(r^=t[i]<<8,o=!0);return n[5]=r,n[6]=r>>8,[4,this.webUSBTransferOut(n)];case 1:case 3:return a.sent(),[4,this.webUSBTransferIn(8)];case 2:return"ok"!=(s=a.sent()).status||s.data.getUint8(0)!=this.EV3_WEBUSB_HEADER||s.data.getUint8(1)!=this.EV3_WEBUSB_CMD_PUT_USER_PROGRAM?[2,{rc:"error",message:"WEBUSB_DOWLOAD_PROBLEM"}]:[4,this.webUSBTransferOut(t)];case 4:return s=a.sent(),this.webUSBIsConnected(),"ok"==s.status&&s.data.getUint8(0)==this.EV3_WEBUSB_HEADER&&s.data.getUint8(1)==this.EV3_WEBUSB_CMD_PUT_USER_PROGRAM&&1==s.data.getUint8(2)?[2,{rc:"ok"}]:[2,{rc:"error",message:"WEBUSB_DOWLOAD_PROBLEM"}]}}))}))},e.prototype.webUSBTransferOut=function(t){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,this.device.transferOut(1,t)];case 1:return e.sent(),[2]}}))}))},e.prototype.processAPIHexString=function(t){var e,n,o=t.length/2,r=new Uint8Array(o);for(n=0,e=0;e<t.length;e+=2){var i="0x"+t.substring(e,e+2),s=parseInt(i);r[n]=s,n++}return o>2048?{rc:"error",message:"ORA_COMPILERWORKFLOW_ERROR_PROGRAM_COMPILE_FAILED",parameters:{MESSAGE:"Program size > 2048 bytes"}}:{rc:"ok",data:r}},e}(w);e.Edisonv3Connection=q;var z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(w);e.Ev3c4ev3Connection=z;var Y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.Ev3devConnection=Y;var j=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.Ev3lejosv0Connection=j;var J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.Ev3lejosv1Connection=J;var X=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.XNNConnection=X;var Z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(T);e.Calliope2016Connection=Z;var $=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(T);e.Calliope2017Connection=$;var Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(T);e.Calliope2017NoBlueConnection=Q;var tt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(w);e.JoycarConnection=tt;var et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(w);e.MicrobitConnection=et;var nt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(w);e.Microbitv2Connection=nt;var ot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(w);e.Calliopev3Connection=ot;var rt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.NaoConnection=rt;var it=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.NxtConnection=it;var st=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),o("#robotWlan").removeClass("hidden"),c.gui.blocklyWorkspace&&c.gui.blocklyWorkspace.robControls.showStopProgram()},e.prototype.terminate=function(){t.prototype.terminate.call(this),o("#robotWlan").addClass("hidden"),c.gui.blocklyWorkspace&&c.gui.blocklyWorkspace.robControls.hideStopProgram()},e}(P);e.RobotinoConnection=st;var at=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){t.prototype.init.call(this),o("#robotWlan").removeClass("hidden")},e.prototype.terminate=function(){t.prototype.terminate.call(this),o("#robotWlan").addClass("hidden")},e}(P);e.RobotinoROSConnection=at;var ct=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(y);e.SpikePybricksConnection=ct;var ut=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(P);e.SpikeConnection=ut;var lt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.showConnectionModal=function(){o("#buttonCancelFirmwareUpdate").css("display","inline"),o("#buttonCancelFirmwareUpdateAndRun").css("display","none"),u.showSetTokenModal(6,8)},e.prototype.init=function(){t.prototype.init.call(this),r.getBlocklyWorkspace().robControls.showStopProgram(),o("#stopProgram").addClass("disabled")},e.prototype.terminate=function(){t.prototype.terminate.call(this),o("#stopProgram").addClass("disabled"),r.getBlocklyWorkspace().robControls.hideStopProgram(),r.setRobotToken("")},e}(P);e.Txt4Connection=lt;var dt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(R);e.ThymioConnection=dt;var pt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(U);e.WedoConnection=pt;var ht=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){r.setConnectionState("wait"),o("#runSourceCodeEditor").removeClass("disabled"),o("#menuConnect").parent().addClass("disabled"),r.setPing(!1)},e.prototype.isRobotConnected=function(){return!0},e.prototype.run=function(t){var e=(t.programName||r.getProgramName())+"."+r.getBinaryFileExtension();"bin"!==r.getBinaryFileExtension()&&"uf2"!==r.getBinaryFileExtension()||(t.compiledCode=s.base64decode(t.compiledCode)),s.download(e,t.compiledCode),setTimeout((function(){r.setConnectionState("wait")}),5e3),a.displayInformation(t,t.message,t.message,r.getProgramName(),r.getRobot())},e.prototype.setState=function(){},e}(n.AbstractConnection);e.LocalConnection=ht;var _t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.init=function(){o("#head-navi-icon-robot").removeClass("error"),o("#head-navi-icon-robot").removeClass("busy"),o("#head-navi-icon-robot").removeClass("wait"),r.setRunEnabled(!1),o("#runSourceCodeEditor").addClass("disabled"),o("#menuConnect").parent().addClass("disabled"),r.setPingTime(r.LONG),r.setPing(!0)},e.prototype.isRobotConnected=function(){return!1},e.prototype.run=function(t){},e.prototype.setState=function(){},e}(n.AbstractConnection);e.RcjConnection=_t}));
//# sourceMappingURL=connections.js.map
//# sourceMappingURL=connections.js.map
