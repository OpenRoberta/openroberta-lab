var __extends=this&&this.__extends||function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),__awaiter=this&&this.__awaiter||function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function s(e){try{c(o.next(e))}catch(e){r(e)}}function a(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var n,o,i,r,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,a[0]&&(s=0)),s;)try{if(n=1,o&&(i=2&a[0]?o.return:a[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,a[1])).done)return i;switch(o=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,o=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],o=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}};define(["require","exports","jquery","guiState.controller"],(function(e,t,n,o){Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){function t(t,n){var o=e.call(this,t,n)||this;return o.connected=!1,o.volume=.5,o}return __extends(t,e),t.prototype.uploadController=function(t){var n={name:"supervisor",message:"upload:"+t};e.prototype.sendMessage.call(this,"robot:"+JSON.stringify(n))},t.prototype.start=function(t,o){var i=this;if(this.sourceCode=o,!this.connected){e.prototype.connect.call(this,t,!1,(function(){i.connected=!0}),(function(){i.connected=!1})),e.prototype.hideToolbar.call(this),this.initSpeechSynthesis(),this.initSpeechRecognition(),n("#webotsProgress").height("120px");var r=this;this.view.onstdout=function(e){if(0===e.indexOf("finish"))r.pause(),r.callback();else if(0===e.indexOf("say")){var t=e.split(":");r.sayText(t)}else if(0===e.indexOf("setLanguage")){t=e.split(":");r.lang=t[1]}else if(0===e.indexOf("setVolume")){t=e.split(":");r.volume=parseInt(t[1])/100}else if(0===e.indexOf("getVolume")){var n={name:"NAO",message:"volume:"+100*r.volume};r.sendMessage("robot:"+JSON.stringify(n))}else e.indexOf("recognizeSpeech")&&r.recognizeSpeech()}}},t.prototype.reset=function(){e.prototype.sendMessage.call(this,"reset")},t.prototype.pause=function(){this.view.runOnLoad=!1,e.prototype.sendMessage.call(this,"pause")},t.prototype.run=function(t,n){this.sourceCode=t,this.callback=n,this.view.runOnLoad=!0,e.prototype.sendMessage.call(this,"pause"),this.uploadController(t),e.prototype.sendMessage.call(this,"real-time:-1")},t.prototype.initSpeechSynthesis=function(){this.SpeechSynthesis=window.speechSynthesis,this.SpeechSynthesis.cancel(),this.SpeechSynthesis||(this.context=null,console.log("Sorry, but the Speech Synthesis API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox"))},t.prototype.sayText=function(e){var t=e[1],n=e[2],i=e[3],r=this.lang||o.getLanguage();""===t&&(t=" "),n=void 0===n?30:n,i=void 0===i?50:i,n=.015*(n=Math.max(0,Math.min(100,n)))+.5,i=.02*(i=Math.max(0,Math.min(100,i)))+.001;var s=new SpeechSynthesisUtterance(t);if(window.utterances=[],window.utterances.push(s),""===r)console.log("Language is not supported!");else{for(var a=this.SpeechSynthesis.getVoices(),c=0;c<a.length;c++)if(-1!==a[c].lang.indexOf(this.lang)||-1!==a[c].lang.indexOf(r.substr(0,2))){s.voice=a[c];break}null===s.voice&&console.log('Language "'+r+'" could not be found. Try a different browser or for chromium add the command line flag "--enable-speech-dispatcher".')}s.pitch=i,s.rate=n,s.volume=this.volume;var u=this,l={name:"NAO",message:"finish"};s.onend=function(e){u.sendMessage("robot:"+JSON.stringify(l))},0!=this.volume?this.SpeechSynthesis.speak(s):this.sendMessage("robot:"+JSON.stringify(l))},t.prototype.initSpeechRecognition=function(){var e=e||window.webkitSpeechRecognition,t=this;e&&(this.recognition=new e,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.onresult=function(e){for(var n=e.resultIndex;n<e.results.length;++n)e.results[n].isFinal&&(t.final_transcript+=e.results[n][0].transcript)},this.recognition.onend=function(){var e={name:"NAO",message:"transcript:"+t.final_transcript};t.sendMessage("robot:"+JSON.stringify(e)),this.stop()})},t.prototype.recognizeSpeech=function(){if(this.recognition)this.final_transcript="",this.recognition.lang=this.lang||o.getLanguage(),this.recognition.start();else{alert("Sorry, your browser does not support speech recognition. Please use the latest version of Chrome, Edge, Safari or Opera");this.sendMessage("robot:"+JSON.stringify({name:"NAO",message:"transcript:"}))}},t}(function(){function e(e,t){this.element=e,this.webots=t}return e.prototype.connect=function(e,t,n,o){var i=this;this.view||(this.view=new this.webots.View(this.element,t)),this.view.broadcast=false,this.view.setTimeout(-1),this.disconnectCallback=o,this.readyCallback=n,this.view.open(e,"x3d"),this.view.onquit=function(){return i.disconnect()},this.view.onready=function(){window.onresize=i.view.onresize,i.readyCallback()}},e.prototype.disconnect=function(){window.onresize=void 0,this.view.close(),this.element.innerHTML=null,"mjpeg"===this.view.mode&&(this.view.multimediaClient=void 0),this.disconnectCallback()},e.prototype.hideToolbar=function(){var e=this.getToolbar();e&&"none"!==e.style.display&&(e.style.display="none",n("#view3d").height("100%"),window.dispatchEvent(new Event("resize")))},e.prototype.showToolbar=function(){var e=this.getToolbar();e&&("block"!==e.style.display&&(e.style.display="block"),n("#view3d").height("calc(100% - 48px)"),window.dispatchEvent(new Event("resize")))},e.prototype.showQuit=function(e){this.webots.showQuit=e},e.prototype.showRevert=function(e){this.webots.showRevert=e},e.prototype.showRun=function(e){this.webots.showRun=e},e.prototype.sendMessage=function(e){void 0!==this.view&&1===this.view.stream.socket.readyState&&this.view.stream.socket.send(e)},e.prototype.getToolbar=function(){return this.element.querySelector("#toolBar")},e}());function r(e,t,n){return __awaiter(this,void 0,void 0,(function(){var o;return __generator(this,(function(i){return o=Date.now(),[2,new Promise((function(i,r){!function s(){return setTimeout((function(){e()?i():Date.now()-o>n?r():s()}),t)}()}))]}))}))}var s=function(){function t(){this.prepared=!1,this._interpreterRunning=!1}return t.prototype.isInterpreterRunning=function(){return this._interpreterRunning},Object.defineProperty(t.prototype,"interpreterRunning",{set:function(e){this._interpreterRunning=e},enumerable:!1,configurable:!0}),t.prototype.init=function(r,s,a,c){return __awaiter(this,void 0,void 0,(function(){var s,c;return __generator(this,(function(u){switch(u.label){case 0:return n("#webotsDiv, .simMobile").show(),n(".simNotWebots").hide(),this.webotsSimulation?[3,6]:(this.prepareWebots(),[4,new Promise((function(t,n){e(["webots"],t,n)}))]);case 1:s=u.sent().webots,u.label=2;case 2:return u.trys.push([2,4,,5]),[4,this.wasmLoaded()];case 3:return u.sent(),[3,5];case 4:return c=u.sent(),console.error("Could not load webots simulation",c),[2];case 5:this.webotsSimulation=new i(t.createWebotsDiv(),s),u.label=6;case 6:return"function"==typeof a&&a(),this.webotsSimulation.start(o.getWebotsUrl(),r[0].javaScriptProgram),[2]}}))}))},t.prototype.run=function(e,t){this.interpreterRunning=!0;var n=this;this.webotsSimulation.run(e[0].javaScriptProgram,(function(){n.interpreterRunning=!1,t()}))},t.prototype.resetPose=function(){this.webotsSimulation.reset()},t.prototype.stopProgram=function(){this.webotsSimulation.pause(),this.interpreterRunning=!1},t.prototype.disconnect=function(){this.webotsSimulation.disconnect()},t.prototype.isPrepared=function(){return this.prepared},t.prototype.importImage=function(){},t.prototype.stop=function(){this.webotsSimulation&&this.webotsSimulation.disconnect(),n("#webotsDiv").hide(),n(".simNotWebots").show()},t.prototype.wasmLoaded=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,r((function(){return window.Module.asm}),10,1e3)];case 1:return e.sent(),[2]}}))}))},t.prototype.prepareWebots=function(){this.isPrepared()||(t.loadCss(),t.prepareModuleForWebots(),this.prepared=!0)},t.createWebotsDiv=function(){var e=document.querySelector("#webotsDiv");if(!e)return(e=document.createElement("webots-streaming")).id="webotsDiv",document.getElementById("simDiv").prepend(e),e},t.loadCss=function(){var e=document.createElement("link");e.href="https://cyberbotics.com/wwi/R2021c/css/wwi.css",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)},t.prepareModuleForWebots=function(){window.hasOwnProperty("Module")||(window.Module=[]),window.Module.locateFile=function(e,t){return e.endsWith(".data")?window.location.origin+"/libs/webots/"+e:t+e}},t}();t.default=new s}));
//# sourceMappingURL=simulation.webots.js.map
//# sourceMappingURL=simulation.webots.js.map
