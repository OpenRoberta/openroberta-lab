define(["require","exports","interpreter.constants","util.roberta","interpreter.interpreter","interpreter.robotSimBehaviour","message","jquery","huebee","blockly","nn.controller","simulation.scene","robot.base","./simulation.objects"],(function(e,t,n,o,r,i,s,a,c,l,u,p,h,d){Object.defineProperty(t,"__esModule",{value:!0}),t.SimulationRoberta=void 0;var f=function(){function e(){this.canceled=!0,this._breakpoints=[],this._debugMode=!1,this._dt=0,this._interpreterRunning=!1,this._interpreters=[],this._renderTime=5,this._renderUntil=[],this._scale=1,this._time=(new Date).getTime(),this._importPoses=[],this.dist=0,this.globalID=0,this.numRobots=0,this.observers=[]}return Object.defineProperty(e,"Instance",{get:function(){return this._instance||(this._instance=new e,this._instance._selectionListener=new h.SelectionListener,this._instance.scene=new p.SimulationScene(this._instance),this._instance.initEvents()),this._instance},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"debugMode",{get:function(){return this._debugMode},set:function(e){this._debugMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"lastMousePosition",{get:function(){return this._lastMousePosition},set:function(e){this._lastMousePosition=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"oldMousePosition",{get:function(){return this._oldMousePosition},set:function(e){this._oldMousePosition=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"selectionListener",{get:function(){return this._selectionListener},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderUntil",{get:function(){return this._renderUntil},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"breakpoints",{get:function(){return this._breakpoints},set:function(e){this._breakpoints=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"interpreters",{get:function(){return this._interpreters},set:function(e){this._interpreters=e,this.numRobots=this._interpreters.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"time",{get:function(){return this._time},set:function(e){this._time=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"importPoses",{get:function(){return this._importPoses},set:function(e){this._importPoses=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderTime",{get:function(){return this._renderTime},set:function(e){this._renderTime=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"dt",{get:function(){return this._dt},set:function(e){this._dt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this._scale},set:function(e){this._scale=e},enumerable:!1,configurable:!0}),e.prototype.isInterpreterRunning=function(){return this._interpreterRunning},Object.defineProperty(e.prototype,"interpreterRunning",{set:function(e){this._interpreterRunning=e},enumerable:!1,configurable:!0}),e.prototype.addMarker=function(e){this.scene.addMarker(e)},e.prototype.addColorArea=function(e){this.scene.addColorArea(e),this.enableChangeObjectButtons()},e.prototype.addObstacle=function(e){this.scene.addObstacle(e),this.enableChangeObjectButtons()},e.prototype.allInterpretersTerminated=function(){for(var e=0;e<this.interpreters.length;e++)if(!this.interpreters[e].isTerminated())return!1;return!0},e.prototype.callbackOnTermination=function(){this.allInterpretersTerminated()&&("function"==typeof this.callbackOnEnd&&this.callbackOnEnd(),console.log("END of Sim")),this.scene.robots.forEach((function(e){e.interpreter.isTerminated()&&e.mobile&&e.reset(),e.interpreter.updateNNView&&u.saveNN2Blockly(e.interpreter.neuralNetwork)}))},e.prototype.deleteAllColorArea=function(){this.scene.colorAreaList=[]},e.prototype.deleteAllObstacle=function(){this.scene.obstacleList=[]},e.prototype.deleteAllMarker=function(){this.scene.markerList=[]},e.prototype.deleteSelectedObject=function(){this.scene.deleteSelectedObject()},e.prototype.disableChangeObjectButtons=function(){a(".simChangeObject").removeClass("disabled").addClass("disabled")},e.prototype.enableChangeObjectButtons=function(){a(".simChangeObject").removeClass("disabled")},e.prototype.endDebugging=function(){null!==this.interpreters&&this.interpreters.forEach((function(e){e.setDebugMode(!1),e.breakpoints=[]})),l.getMainWorkspace().getAllBlocks().forEach((function(e){a(e.svgPath_).stop(!0,!0).removeAttr("style")})),this.breakpoints=[],this.debugMode=!1,this.updateBreakpointEvent()},e.prototype.exportConfigData=function(){return this.getConfigData()},e.prototype.getConfigData=function(){var e=this.scene.uCanvas.height,t=this.scene.uCanvas.width,n={};function o(n){if(n instanceof d.RectangleSimulationObject){if(n instanceof d.MarkerSimulationObject){var o=n.markerId;return{x:n.x/t,y:n.y/e,w:n.w/t,h:n.h/e,theta:n.theta,color:n.color,form:d.SimObjectShape.Rectangle,type:n.type,markerId:o}}return{x:n.x/t,y:n.y/e,w:n.w/t,h:n.h/e,theta:n.theta,color:n.color,form:d.SimObjectShape.Rectangle,type:n.type}}return n instanceof d.TriangleSimulationObject?{ax:n.ax/t,ay:n.ay/e,bx:n.bx/t,by:n.by/e,cx:n.cx/t,cy:n.cy/e,color:n.color,form:d.SimObjectShape.Triangle,type:n.type}:n instanceof d.CircleSimulationObject?{x:n.x/t,y:n.y/e,r:n.r/e/t,color:n.color,form:d.SimObjectShape.Circle,type:n.type}:void 0}var r=this.scene.getRobotPoses();return n.robotPoses=r.map((function(n){return[{x:n[0].x/t,y:n[0].y/e,theta:n[0].theta},{x:n[1].x/t,y:n[1].y/e,theta:n[1].theta}]})),n.obstacles=this.scene.obstacleList.map((function(e){return o(e)})),n.colorAreas=this.scene.colorAreaList.map((function(e){return o(e)})),n.marker=this.scene.markerList.map((function(e){return o(e)})),n},e.prototype.getNumRobots=function(){return this.interpreters.length},e.prototype.handleMouse=function(t){switch("mouseup"!==t.type&&"touchend"!==t.type&&t.stopPropagation(),t.preventDefault(),a("#robotLayer").data().hovered?a("#robotLayer").data("hovered",!1):a("#robotLayer").css("cursor","auto"),t&&"mouseout"!==t.type&&"touchcancel"!==t.type&&"touchend"!==t.type&&!t.startX&&(o.extendMouseEvent(t,this.scale,a("#robotLayer")),this.lastMousePosition={x:t.startX,y:t.startY}),t.type){case"mousedown":case"touchstart":this.oldMousePosition=this.lastMousePosition,this.selectionListener.fire(null);break;case"mousemove":case"touchmove":if(!this.oldMousePosition)return;t&&!t.startX&&o.extendMouseEvent(t,e.Instance.scale,a("#robotLayer"));var n=t,r=(n.startX-this.oldMousePosition.x)*this.scale,i=(n.startY-this.oldMousePosition.y)*this.scale,s=a("#canvasDiv").position();s.top+=i,s.left+=r,a("#canvasDiv").css({top:s.top}),a("#canvasDiv").css({left:s.left});break;default:this.oldMousePosition=null}},e.prototype.handleMouseWheel=function(e){var t=this.scale,n=0;if(void 0!==e.originalEvent.wheelDelta)n=e.originalEvent.wheelDelta;else if(e.originalEvent.touches){if(!e.originalEvent.touches[0]||!e.originalEvent.touches[1])return void(this.dist=0);var o=e.originalEvent.touches[0].pageX-e.originalEvent.touches[1].pageX,r=e.originalEvent.touches[0].pageY-e.originalEvent.touches[1].pageY,i=o*o+r*r;if(0==this.dist)return void(this.dist=i);n=i-this.dist,this.dist=i}else n=-e.originalEvent.deltaY;var s=!1;if(n>0?(this.scale*=1.025,this.scale>15&&(this.scale=15),s=!0):n<0&&(this.scale*=.925,this.scale<.25&&(this.scale=.25),s=!0),s){var c=this.scale-t,l=a("#canvasDiv").position(),u=this.scene.uCanvas.width*c,p=this.scene.uCanvas.height*c;l.top=l.top-p/2,l.left=l.left-u/2,a("#canvasDiv").css({top:l.top}),a("#canvasDiv").css({left:l.left}),this.scene.resetAllCanvas(!1)}return!1},e.prototype.importConfigData=function(){a("#backgroundFileSelector").val(null),a("#backgroundFileSelector").attr("accept",".json"),a("#backgroundFileSelector").off();var e=this;a("#backgroundFileSelector").onWrap("change",(function(t){var n=t.target.files[0],o=new FileReader;return o.onload=function(t){try{var n=JSON.parse(t.target.result);e.setNewConfig(n)}catch(e){console.error(e)}},o.readAsText(n),!1})),a("#backgroundFileSelector").clickWrap()},e.prototype.importImage=function(){var e=a("#backgroundFileSelector");e.val(null),e.attr("accept",".png, .jpg, .jpeg, .svg"),e.clickWrap();var t=this;e.on("change",(function(e){var n=e.target.files[0],r=new FileReader;return r.onload=function(){var e=new Image;e.onload=function(){var n=document.createElement("canvas");n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0);var r=n.toDataURL("image/png"),i=new Image(n.width,n.height);i.src=r,i.onload=function(){t.scene.customBackgroundLoaded?t.scene.imgBackgroundList[t.scene.imgBackgroundList.length-1]=i:t.scene.imgBackgroundList.push(i),t.setBackground(t.scene.imgBackgroundList.length-1)},o.isLocalStorageAvailable()&&(a("#show-message-confirm").oneWrap("shown.bs.modal",(function(){a("#confirm").off(),a("#confirm").on("click",(function(e){e.preventDefault(),localStorage.setItem("customBackground",JSON.stringify({image:r.replace(/^data:image\/(png|jpg);base64,/,""),timestamp:(new Date).getTime()}))})),a("#confirmCancel").off(),a("#confirmCancel").on("click",(function(e){e.preventDefault()}))})),s.displayPopupMessage("Blockly.Msg.POPUP_BACKGROUND_STORAGE",l.Msg.POPUP_BACKGROUND_STORAGE,l.Msg.YES,l.Msg.NO))},"string"==typeof r.result&&(e.src=r.result)},r.readAsDataURL(n),!1}))},e.prototype.init=function(e,t,n,o){var s=this;this.robotType=o||this.robotType,this.storedPrograms=e,this.resetRenderUntil(e.length);var a=[];this.interpreters=e.map((function(e){var t=JSON.parse(e.javaScriptProgram);return a.push(e.configuration),new r.Interpreter(t,new i.RobotSimBehaviour,s.callbackOnTermination.bind(s),s.breakpoints,e.programName,e.updateNNView)})),this.updateDebugMode(this.debugMode);var c=e.map((function(e){return e.programName}));this.scene.init(this.robotType,t,this.interpreters,a,c,this.importPoses,n)},e.prototype.initColorPicker=function(e){var t=this;e&&e.length>0?this.colorpicker=new c("#colorpicker",{shades:1,hues:8,customColors:e,setText:!1}):this.colorpicker=new c("#colorpicker",{shades:1,hues:8,setText:!1}),this.colorpicker.on("change",(function(e){t.scene.changeColorWithColorPicker(e)}));var n=c.prototype.close;c.prototype.close=function(){a(".huebee__container").off("mouseup touchend",(function(e){e.stopPropagation(),t.resetColorpickerCursor()})),n.call(this)};var o=c.prototype.open;c.prototype.open=function(){o.call(this),a(".huebee__container").on("mouseup touchend",(function(e){t.resetColorpickerCursor()})),a(".huebee").draggable({})}},e.prototype.initEvents=function(){var e=this,t=this;a(window).on("focus",(function(){return t.start(),!1})),a(window).on("blur",(function(){return t.stop(),!1})),a("#simDiv").on("wheel mousewheel touchmove",(function(t){e.handleMouseWheel(t)})),a("#canvasDiv").on("mousedown touchstart mousemove touchmove mouseup touchend mouseout touchcancel",(function(t){e.handleMouse(t)})),a("#robotLayer").on("click touchstart",(function(e){a("#robotLayer").attr("tabindex",0),a("#robotLayer").trigger("focus"),e.preventDefault()})),a("#blocklyDiv").on("click touchstart",(function(e){a("#blocklyDiv").trigger("focus"),e.preventDefault()}))},e.prototype.interpreterAddEvent=function(e){this.updateBreakpointEvent(),this.interpreters&&this.interpreters.forEach((function(t){return t.addEvent(e)}))},e.prototype.removeBreakPoint=function(e){for(var t=0;t<this._breakpoints.length;t++)this._breakpoints[t]===e.id&&this._breakpoints.splice(t,1);if(!this._breakpoints&&this._breakpoints.length>0&&null!==this.interpreters)for(t=0;t<this.interpreters.length;t++)this.interpreters[t].removeEvent(n.DEBUG_BREAKPOINT)},e.prototype.render=function(){var e=this;if(this.canceled)return cancelAnimationFrame(this.globalID),this.renderTime=5,void(this.globalID=0);this.globalID=requestAnimationFrame(this.render.bind(this));var t=(new Date).getTime(),n=t-this.time,o=Math.min(15,Math.abs(n-this.renderTime)/this.getNumRobots());this.dt=n/1e3,this.stepCounter+=1,this.isInterpreterRunning()&&this.interpreters.forEach((function(n,r){if(n.isTerminated())e.allInterpretersTerminated()&&(e.interpreterRunning=!1);else if(e.renderUntil[r]<=t){var i=n.run(t+o),s=(new Date).getTime();e.renderUntil[r]=s+i}}),this),this.updateBreakpointEvent();var r=(new Date).getTime();this.scene.update(this.dt,this.isInterpreterRunning()),this.renderTime=(new Date).getTime()-r,this.time=t},e.prototype.resetColorpickerCursor=function(){this.colorpicker.color=null,this.colorpicker.setTexts(),this.colorpicker.setBackgrounds(),this.colorpicker.cursor.classList.add("is-hidden")},e.prototype.resetPose=function(){this.scene.resetPoseAndDrawings()},e.prototype.resetRenderUntil=function(e){this._renderUntil=[];for(var t=0;t<e;t++)this._renderUntil[t]=0},e.prototype.run=function(e,t){this.callbackOnEnd=t;var n=this;this.init(e,!1,(function(){setTimeout((function(){n.interpreterRunning=!0}),250)}))},e.prototype.setBackground=function(e){this.scale=1,this.scene.stepBackground(e)},e.prototype.setNewConfig=function(e){var t=this,n=this.scene.uCanvas.height,o=this.scene.uCanvas.width,r=this;function i(e){var t={};switch(t.id=r.scene.uniqueObjectId,"MARKER"===e.type?(t.shape="MARKER",t.markerId=e.markerId):t.shape=e.form.toUpperCase(),t.color=e.color,t.newObjecttype=e.type,e.form.toLowerCase()){case"rectangle":t.p={x:e.x*o,y:e.y*n},t.params=[e.w*o,e.h*n];break;case"triangle":t.p={x:0,y:0},t.params=[e.ax*o,e.ay*n,e.bx*o,e.by*n,e.cx*o,e.cy*n];break;case"circle":t.p={x:e.x*o,y:e.y*n},t.params=[e.r*n*o]}return t}this.importPoses=[],e.robotPoses.forEach((function(e){if(Array.isArray(e)){(i={}).x=e[0].x*o,i.y=e[0].y*n,i.theta=e[0].theta;var r={};r.x=e[1].x*o,r.y=e[1].y*n,r.theta=e[1].theta,t.importPoses.push([i,r])}else{var i;(i={}).x=e.x*o,i.y=e.y*n,i.theta=e.theta,t.importPoses.push([i,i])}})),this.scene.setRobotPoses(this.importPoses);var s=[];e.obstacles.forEach((function(e){s.push(i(e))})),this.scene.addImportObstacle(s);var a=[];e.colorAreas.forEach((function(e){a.push(i(e))})),this.scene.addImportColorAreaList(a);var c=[];e.marker&&e.marker.forEach((function(e){c.push(i(e))})),this.scene.addImportMarkerList(c)},e.prototype.setPause=function(e){this.interpreterRunning=!e},e.prototype.start=function(){this.time=(new Date).getTime(),this.canceled=!1,0===this.globalID&&this.render()},e.prototype.stop=function(){this.interpreters.forEach((function(e){e.updateNNView&&u.saveNN2Blockly(e.neuralNetwork)})),this.canceled=!0},e.prototype.stopProgram=function(){this.interpreters.forEach((function(e){e.removeHighlights(),e.terminate(),e.updateNNView&&u.saveNN2Blockly(e.neuralNetwork)})),this.interpreterRunning=!1},e.prototype.toggleColorPicker=function(){a(".huebee").length?this.colorpicker.close():this.colorpicker.open()},e.prototype.toggleTrail=function(){this.scene.toggleTrail()},e.prototype.updateBreakpointEvent=function(){var e=this;this.debugMode?l.getMainWorkspace().getAllBlocks().forEach((function(t){if(!a(t.svgGroup_).hasClass("blocklyDisabled")){e.observers.hasOwnProperty(t.id)&&e.observers[t.id].disconnect();var n=new MutationObserver((function(n){n.forEach((function(n){a(t.svgGroup_).hasClass("blocklyDisabled")||a(t.svgGroup_).hasClass("blocklyDragging")?(e.removeBreakPoint(t),a(t.svgGroup_).removeClass("blocklySelected"),a(t.svgPath_).removeClass("breakpoint").removeClass("selectedBreakpoint")):a(t.svgGroup_).hasClass("blocklySelected")&&(a(t.svgPath_).hasClass("breakpoint")?(e.removeBreakPoint(t),a(t.svgPath_).removeClass("breakpoint")):a(t.svgPath_).hasClass("selectedBreakpoint")?(e.removeBreakPoint(t),a(t.svgPath_).removeClass("selectedBreakpoint").stop(!0,!0).animate({"fill-opacity":"1"},0)):(e._breakpoints.push(t.id),a(t.svgPath_).addClass("breakpoint")),a(t.svgGroup_).removeClass("blocklySelected"))}))}));e.observers[t.id]=n,n.observe(t.svgGroup_,{attributes:!0})}}),e):l.getMainWorkspace().getAllBlocks().forEach((function(t){e.observers.hasOwnProperty(t.id)&&e.observers[t.id].disconnect(),a(t.svgPath_).removeClass("breakpoint").animate({"fill-opacity":"1"},0),e.removeBreakPoint(t)}),e)},e.prototype.updateDebugMode=function(e){if(this.debugMode=e,null!==this.interpreters)for(var t=0;t<this.interpreters.length;t++)this.interpreters[t].setDebugMode(e);this.updateBreakpointEvent()},e}();t.SimulationRoberta=f,function(){for(var e=["webkit","moz","ms","o"],t=null,n=0;n<e.length&&!window.requestAnimationFrame&&!window.cancelAnimationFrame;n++)t=e[n],window.requestAnimationFrame=window.requestAnimationFrame||window[t+"RequestAnimationFrame"],window.cancelAnimationFrame=window.cancelAnimationFrame||window[t+"CancelAnimationFrame"]||window[t+"CancelRequestAnimationFrame"];if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var o=0;window.requestAnimationFrame=function(e,t){var n=window.performance.now(),r=Math.max(o+16,n);return setTimeout((function(){e(o=r)}),r-n)},window.cancelAnimationFrame=clearTimeout}}(),t.default=f.Instance}));
//# sourceMappingURL=simulation.roberta.js.map
//# sourceMappingURL=simulation.roberta.js.map
