var __extends=this&&this.__extends||function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();define(["require","exports","robot.base.mobile","interpreter.constants","simulation.math","util.roberta","robot.actuators","simulation.objects","blockly","volume-meter","jquery","simulation.roberta"],(function(t,e,i,s,r,a,o,n,h,l,u,p){Object.defineProperty(e,"__esModule",{value:!0}),e.CameraSensor=e.OdometrySensor=e.SoundSensorBoolean=e.SoundSensor=e.VolumeMeterSensor=e.TemperatureSensor=e.Rob3rtaInfraredSensor=e.CalliopeLightSensor=e.CompassSensor=e.GestureSensor=e.MbotButton=e.MicrobitPins=e.Pins=e.TouchKeys=e.EV3Keys=e.Keys=e.GyroSensorExt=e.GyroSensor=e.OpticalSensor=e.LightSensor=e.NXTColorSensor=e.ColorSensor=e.RobotinoTouchSensor=e.TapSensor=e.TouchSensor=e.EdisonInfraredSensors=e.RobotinoInfraredSensors=e.ThymioInfraredSensors=e.InfraredSensors=e.MbotInfraredSensor=e.ThymioLineSensors=e.LineSensor=e.EdisonInfraredSensor=e.ThymioInfraredSensor=e.InfraredSensor=e.UltrasonicSensor=e.DistanceSensor=e.Timer=void 0;var d=function(){function t(t){this.time=[],this.labelPriority=14;for(var e=0;e<t;e++)this.time[e]=0}return t.prototype.getLabel=function(){for(var t="",e=0;e<this.time.length;e++){t+="<div><label>"+(e+1)+"</label><span>"+(a.round(this.time[e],1)+" s")+"</span></div>"}return t},t.prototype.reset=function(){for(var t in this.time)this.time[t]=0},t.prototype.updateAction=function(t,e,i){if(i){for(var s in this.time)this.time[s]+=e;var r=t.interpreter.getRobotBehaviour().getActionState("timer",!0);if(r)for(var a=1;a<=this.time.length;a++)r[a]&&"reset"==r[a]&&(this.time[a-1]=0)}},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.timer=s.timer||[];for(var n=0;n<this.time.length;n++)s.timer[n+1]=1e3*this.time[n]},t}();e.Timer=d;var c=function(){function t(t,e,i,s,r){this.color="#FF69B4",this.sensorLabel=!0,this.cx=0,this.cy=0,this.distance=0,this.rx=0,this.ry=0,this.u=[],this.wave=0,this.drawPriority=5,this.port=t,this.labelPriority=Number(this.port.replace("ORT_","")),this.x=e,this.y=i,this.theta=s,this.maxDistance=r,this.maxLength=3*r}return t.prototype.draw=function(t,e){t.restore(),t.save(),t.lineDashOffset=60-this.wave,t.setLineDash([20,40]);for(var i=0;i<this.u.length;i++)t.beginPath(),t.lineWidth=.5,t.strokeStyle="#555555",t.moveTo(this.rx,this.ry),t.lineTo(this.u[i].x,this.u[i].y),t.stroke();this.cx&&this.cy&&(t.beginPath(),t.lineWidth=1,t.strokeStyle="black",t.moveTo(this.rx,this.ry),t.lineTo(this.cx,this.cy),t.stroke()),this.sensorLabel&&(t.translate(this.rx,this.ry),t.rotate(e.pose.theta),t.rotate(this.theta),t.translate(10,0),t.rotate(-this.theta),t.translate(-5,0),t.beginPath(),t.fillStyle="#555555",t.fillText(String(this.port.replace("ORT_","")),0,4)),t.restore(),t.save(),t.translate(e.pose.x,e.pose.y),t.rotate(e.pose.theta)},t.prototype.updateSensor=function(t,e,s,a,h,l,u){if(s instanceof i.RobotBaseMobile){var p=s;r.transform(p.pose,this),a.ultrasonic=a.ultrasonic||{},a.infrared=a.infrared||{},a.ultrasonic[this.port]={},a.infrared[this.port]={},this.cx=null,this.cy=null,this.wave+=60*e,this.wave%=60;var d={x1:this.rx,y1:this.ry,x2:this.rx+this.maxLength*Math.cos(p.pose.theta+this.theta),y2:this.ry+this.maxLength*Math.sin(p.pose.theta+this.theta)},c={x1:this.rx,y1:this.ry,x2:this.rx+this.maxLength*Math.cos(p.pose.theta-Math.PI/8+this.theta),y2:this.ry+this.maxLength*Math.sin(p.pose.theta-Math.PI/8+this.theta)},y={x1:this.rx,y1:this.ry,x2:this.rx+this.maxLength*Math.cos(p.pose.theta-Math.PI/16+this.theta),y2:this.ry+this.maxLength*Math.sin(p.pose.theta-Math.PI/16+this.theta)},f={x1:this.rx,y1:this.ry,x2:this.rx+this.maxLength*Math.cos(p.pose.theta+Math.PI/8+this.theta),y2:this.ry+this.maxLength*Math.sin(p.pose.theta+Math.PI/8+this.theta)},b=[c,y,d,{x1:this.rx,y1:this.ry,x2:this.rx+this.maxLength*Math.cos(p.pose.theta+Math.PI/16+this.theta),y2:this.ry+this.maxLength*Math.sin(p.pose.theta+Math.PI/16+this.theta)},f];this.distance=this.maxLength;for(var g=[this.maxLength,this.maxLength,this.maxLength,this.maxLength,this.maxLength],x=0;x<u.length;x++){var v=u[x];if(!(v instanceof o.ChassisMobile&&v.id==p.id))if(v instanceof n.CircleSimulationObject)for(m=0;m<b.length;m++){I=r.getClosestIntersectionPointCircle(b[m],u[x]);this.checkShortestDistance(I,g,m,b[m])}else for(var S=v.getLines(),M=0;M<S.length;M++)for(var m=0;m<b.length;m++){var I=r.getIntersectionPoint(b[m],S[M]);this.checkShortestDistance(I,g,m,b[m])}}for(x=0;x<b.length;x++)this.u[x]={x:b[x].x2,y:b[x].y2}}else this.distance=0},t.prototype.checkShortestDistance=function(t,e,i,s){if(t){var r=Math.sqrt((t.x-this.rx)*(t.x-this.rx)+(t.y-this.ry)*(t.y-this.ry));r<this.distance&&(this.distance=r,this.cx=t.x,this.cy=t.y),r<e[i]&&(e[i]=r,s.x2=t.x,s.y2=t.y)}},t}();e.DistanceSensor=c;var y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_ULTRASONIC+"</label><span>"+a.roundUltraSound(this.distance/3,0)+" cm</span></div>"},e.prototype.updateSensor=function(e,i,s,r,a,o,n){t.prototype.updateSensor.call(this,e,i,s,r,a,o,n);var h=this.distance/3;r.ultrasonic=r.ultrasonic||{},r.ultrasonic[this.port]={},h<this.maxDistance?r.ultrasonic[this.port].distance=h:r.ultrasonic[this.port].distance=this.maxDistance,r.ultrasonic[this.port].presence=!1},e}(c);e.UltrasonicSensor=y;var f=function(t){function e(e,i,s,r,a,o,n){var h=t.call(this,e,i,s,r,a)||this;return h.relative=!0,h.name=n,h.relative=void 0!==o?o:h.relative,h}return __extends(e,t),e.prototype.getLabel=function(){return this.name?"<div><label>"+this.name+" "+h.Msg.SENSOR_INFRARED+"</label><span>"+a.roundUltraSound(this.distance/3,0)+" cm</span></div>":"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_INFRARED+"</label><span>"+a.roundUltraSound(this.distance/3,0)+" cm</span></div>"},e.prototype.updateSensor=function(e,i,s,r,a,o,n){t.prototype.updateSensor.call(this,e,i,s,r,a,o,n);var h=this.distance/3;r.infrared=r.infrared||{},r.infrared[this.port]={},this.relative?h<this.maxDistance?r.infrared[this.port].distance=100/this.maxDistance*h:r.infrared[this.port].distance=100:h<this.maxDistance?r.infrared[this.port].distance=h:r.infrared[this.port].distance=this.maxDistance,r.infrared[this.port].presence=!1},e}(c);e.InfraredSensor=f;var b=function(t){function e(e,i,s,r,a,o){var n=t.call(this,e,i,s,r,a,!0,o)||this;return n.sensorLabel=!1,n}return __extends(e,t),e.prototype.getLabel=function(){var t=this.distance/3;return t<this.maxDistance?t*=100/this.maxDistance:t=100,t=a.round(t,0),"<div><label>&nbsp;-&nbsp;"+this.name+"</label><span>"+a.roundUltraSound(t,0)+" %</span></div>"},e.prototype.updateSensor=function(e,i,s,r,o,n,h){t.prototype.updateSensor.call(this,e,i,s,r,o,n,h);var l=this.distance/3;r.infrared=r.infrared||{},r.infrared.distance=r.infrared.distance?r.infrared.distance:{},l<this.maxDistance?r.infrared.distance[this.port]=a.round(100/this.maxDistance*l,0):r.infrared.distance[this.port]=100},e}(f);e.ThymioInfraredSensor=b;var g=function(t){function e(e,i,s,r,a,o){var n=t.call(this,e,i,s,r,a,!1,o)||this;return n.sensorLabel=!1,n}return __extends(e,t),e.prototype.getLabel=function(){return"<div><label>&nbsp;-&nbsp;"+this.name+"</label><span>"+(this.distance/3<this.maxDistance)+"</span></div>"},e.prototype.updateSensor=function(e,i,s,r,a,o,n){t.prototype.updateSensor.call(this,e,i,s,r,a,o,n);var h=this.distance/3;r.infrared=r.infrared||{},r.infrared[this.port]=r.infrared[this.port]?r.infrared[this.port]:{},h<this.maxDistance?r.infrared[this.port].obstacle=!0:r.infrared[this.port].obstacle=!1},e}(f);e.EdisonInfraredSensor=g;var x=function(){function t(t,e){this.line=!1,this.light=0,this.drawPriority=4,this.labelPriority=4,this.rx=0,this.ry=0,this.radius=0,this.diameter=0,this.in=[],this.x=t.x,this.y=t.y,this.diameter=e,this.radius=this.diameter/2;for(var i=0;i<this.diameter;i++)for(var s=0;s<this.diameter;s++){var r=i-Math.floor(this.radius),a=s-Math.floor(this.radius);r*r+a*a<=1&&this.in.push(4*(i+s*this.diameter))}}return t.prototype.draw=function(t,e){t.save(),t.beginPath(),t.lineWidth=.1,t.arc(this.x,this.y,this.radius,0,2*Math.PI);var i=this.light/100*255;t.fillStyle="rgb("+i+", "+i+", "+i+")",t.fill(),t.strokeStyle="#000000",t.stroke(),t.restore()},t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_INFRARED+"</label></div><div><label>&nbsp;-&nbsp;"+h.Msg.BOTTOM_LEFT+"</label></div><div><label>&nbsp;--&nbsp;"+h.Msg.MODE_LINE+"</label><span>"+this.line+"</span></div><div><label>&nbsp;--&nbsp;"+h.Msg.MODE_LIGHT+"</label><span>"+this.light+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,o,n,h){var l=i,u={rx:0,ry:0,x:this.x,y:this.y};r.transform(l.pose,u),s.infrared=s.infrared||{};var p=this;!function(t,e){for(var i=0,r=0,h=0,l=o.getImageData(Math.round(e.x-p.radius),Math.round(e.y-p.radius),p.diameter,p.diameter),u=n.getImageData(Math.round(e.x-p.radius),Math.round(e.y-p.radius),p.diameter,p.diameter),d=0;d<=l.data.length;d+=4)if(255===u.data[d+3])for(var c=d;c<d+3;c++)l.data[c]=u.data[c];for(c=0;c<l.data.length;c+=12)for(d=c;d<c+12;d+=4)p.in.indexOf(d)>=0&&(i+=l.data[d+0],r+=l.data[d+1],h+=l.data[d+2]);var y=l.data.length/4-4,f=((i/=y)+(r/=y)+(h/=y))/3/2.55;p.line=f<50,p.light=a.round(f,0),s.infrared.light=s.infrared.light?s.infrared.light:{},s.infrared.light=p.light,s.infrared.line=s.infrared.line?s.infrared.line:{},s.infrared.line=p.line}(0,{x:u.rx,y:u.ry})},t}();e.LineSensor=x;var v=function(){function t(t){this.drawPriority=4,this.left=new x({x:t.x,y:t.y-3},3),this.right=new x({x:t.x,y:t.y+3},3)}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_INFRARED+"</label></div><div><label>&nbsp;-&nbsp;"+h.Msg.BOTTOM_LEFT+"</label></div><div><label>&nbsp;--&nbsp;"+h.Msg.MODE_LINE+"</label><span>"+this.left.line+"</span></div><div><label>&nbsp;--&nbsp;"+h.Msg.MODE_LIGHT+"</label><span>"+this.left.light+"</span></div><div><label>&nbsp;-&nbsp;"+h.Msg.BOTTOM_RIGHT+"</label></div><div><label>&nbsp;--&nbsp;"+h.Msg.MODE_LINE+"</label><span>"+this.right.line+"</span></div><div><label>&nbsp;--&nbsp;"+h.Msg.MODE_LIGHT+"</label><span>"+this.right.light+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o,n){this.left.updateSensor(t,e,i,s,r,a,o),this.right.updateSensor(t,e,i,s,r,a,o),this.left.line=this.left.line?1:0,this.right.line=this.right.line?1:0,s.infrared.light={},s.infrared.light.left=this.left.light,s.infrared.light.right=this.right.light,s.infrared.line={},s.infrared.line.left=this.left.line,s.infrared.line.right=this.right.line},t.prototype.draw=function(t,e){this.left.draw(t,e),this.right.draw(t,e)},t}();e.ThymioLineSensors=v;var S=function(){function t(t,e){this.right={value:0},this.left={value:0},this.drawPriority=4,this.rx=0,this.ry=0,this.dx=5,this.dy=8,this.r=1.5,this.x=e.x,this.y=e.y,this.port=t,this.labelPriority=Number(this.port.replace("ORT_",""))}return t.prototype.draw=function(t,e){t.save(),t.fillStyle="#333",t.rect(this.x,this.y-this.dy/2,this.dx,this.dy),t.fill(),t.beginPath(),t.lineWidth=.1,t.arc(this.x+this.dx/2,this.y-this.dy/4,this.r,0,2*Math.PI),t.fillStyle=this.left.value?"black":"white",t.fill(),t.strokeStyle="black",t.stroke(),t.lineWidth=.5,t.beginPath(),t.lineWidth=.1,t.arc(this.x+this.dx/2,this.y+this.dy/4,this.r,0,2*Math.PI),t.fillStyle=this.right.value?"black":"white",t.fill(),t.strokeStyle="black",t.stroke(),t.beginPath(),t.fillStyle="#555555",t.fillText(String(this.port.replace("ORT_","")),this.x+2,this.y+12),t.restore()},t.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_INFRARED+"</label></div><div><label>&nbsp;-&nbsp;"+h.Msg.LEFT+"</label><span>"+this.left.value+"</span></div><div><label>&nbsp;-&nbsp;"+h.Msg.RIGHT+"</label><span>"+this.right.value+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,a,o,n){var h=i,l={rx:0,ry:0,x:this.x+this.dx/2,y:this.y-this.dy/4},u={rx:0,ry:0,x:this.x+this.dx/2,y:this.y+this.dy/4};r.transform(h.pose,l),r.transform(h.pose,u),s.infrared=s.infrared||{},s.infrared[this.port]={};var p=this;function d(t,e){for(var i=0,r=0,n=0,h=a.getImageData(Math.round(e.x-3),Math.round(e.y-3),6,6),l=o.getImageData(Math.round(e.x-3),Math.round(e.y-3),6,6),u=0;u<=h.data.length;u+=4)if(255===l.data[u+3])for(var d=u;d<u+3;d++)h.data[d]=l.data[d];var c=[0,4,16,20,24,44,92,116,120,124,136,140];for(d=0;d<h.data.length;d+=24)for(u=d;u<d+24;u+=4)c.indexOf(u)<0&&(i+=h.data[u+0],r+=h.data[u+1],n+=h.data[u+2]);var y=h.data.length/4-12,f=((i/=y)+(r/=y)+(n/=y))/3/2.55;p[t].value=f<50,s.infrared[p.port][t]=p[t].value}d("left",{x:l.rx,y:l.ry}),d("right",{x:u.rx,y:u.ry})},t}();e.MbotInfraredSensor=S;var M=function(){function t(){this.infraredSensorArray=[],this.configure()}return t.prototype.draw=function(t,e){this.infraredSensorArray.forEach((function(i){return i.draw(t,e)}))},t.prototype.getLabel=function(){var t="<div><label>"+h.Msg.SENSOR_INFRARED+"</label></div>";return this.infraredSensorArray.forEach((function(e){return t+=e.getLabel()})),t},t.prototype.updateSensor=function(t,e,i,s,r,a,o){this.infraredSensorArray.forEach((function(n){return n.updateSensor(t,e,i,s,r,a,o)}))},t}();e.InfraredSensors=M;var m=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.configure=function(){this.infraredSensorArray[0]=new b("0",24*Math.cos(-Math.PI/4),24*Math.sin(-Math.PI/4),-Math.PI/4,14,h.Msg.FRONT_LEFT),this.infraredSensorArray[1]=new b("1",26*Math.cos(-Math.PI/8),26*Math.sin(-Math.PI/8),-Math.PI/8,14,h.Msg.FRONT_LEFT_MIDDLE),this.infraredSensorArray[2]=new b("2",26,0,0,14,h.Msg.FRONT_MIDDLE),this.infraredSensorArray[3]=new b("3",26*Math.cos(Math.PI/8),26*Math.sin(Math.PI/8),Math.PI/8,14,h.Msg.FRONT_RIGHT_MIDDLE),this.infraredSensorArray[4]=new b("4",24*Math.cos(Math.PI/4),24*Math.sin(Math.PI/4),Math.PI/4,14,h.Msg.FRONT_RIGHT),this.infraredSensorArray[5]=new b("5",-9,-13,Math.PI,14,h.Msg.BACK_LEFT),this.infraredSensorArray[6]=new b("6",-9,13,Math.PI,14,h.Msg.BACK_RIGHT)},e}(M);e.ThymioInfraredSensors=m;var I=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.configure=function(){this.infraredSensorArray[0]=new f("1",68*Math.cos(0),68*Math.sin(0),0,30,!1),this.infraredSensorArray[1]=new f("2",68*Math.cos(2*-Math.PI/9),68*Math.sin(2*-Math.PI/9),2*-Math.PI/9,30,!1),this.infraredSensorArray[2]=new f("3",68*Math.cos(4*-Math.PI/9),68*Math.sin(4*-Math.PI/9),4*-Math.PI/9,30,!1),this.infraredSensorArray[3]=new f("4",68*Math.cos(6*-Math.PI/9),68*Math.sin(6*-Math.PI/9),6*-Math.PI/9,30,!1),this.infraredSensorArray[4]=new f("5",68*Math.cos(8*-Math.PI/9),68*Math.sin(8*-Math.PI/9),8*-Math.PI/9,30,!1),this.infraredSensorArray[9]=new f("9",68*Math.cos(2*Math.PI/9),68*Math.sin(2*Math.PI/9),2*Math.PI/9,30,!1),this.infraredSensorArray[8]=new f("8",68*Math.cos(4*Math.PI/9),68*Math.sin(4*Math.PI/9),4*Math.PI/9,30,!1),this.infraredSensorArray[7]=new f("7",68*Math.cos(6*Math.PI/9),68*Math.sin(6*Math.PI/9),6*Math.PI/9,30,!1),this.infraredSensorArray[6]=new f("6",68*Math.cos(8*Math.PI/9),68*Math.sin(8*Math.PI/9),8*Math.PI/9,30,!1)},e}(M);e.RobotinoInfraredSensors=I;var P=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.configure=function(){this.infraredSensorArray[1]=new g("LEFT",17,-8,0,3,h.Msg.LEFT),this.infraredSensorArray[0]=new g("FRONT",18,0,0,3,h.Msg.SLOT_FRONT),this.infraredSensorArray[2]=new g("RIGHT",17,8,0,3,h.Msg.RIGHT)},e}(M);e.EdisonInfraredSensors=P;var _=function(){function t(t,e,i,s){this.color="#FF69B4",this.rx=0,this.ry=0,this.value=!1,this.drawPriority=4,this.port=t,this.labelPriority=Number(this.port.replace("ORT_","")),this.x=e,this.y=i,this.color=s||this.color}return t.prototype.draw=function(t,e){t.save(),t.shadowBlur=5,t.shadowColor="black",t.fillStyle=e.chassis.geom.color,this.value?t.fillStyle="red":t.fillStyle=e.chassis.geom.color,t.fillRect(e.chassis.frontLeft.x-3.5,e.chassis.frontLeft.y,3.5,-e.chassis.frontLeft.y+e.chassis.frontRight.y),t.restore()},t.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_TOUCH+"</label><span>"+this.value+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.touch=s.touch||{},s.touch[this.port]=this.value=i.chassis.frontLeft.bumped||i.chassis.frontRight.bumped},t}();e.TouchSensor=_;var R=function(){function t(){}return t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.touch=s.touch||{};var n=i.chassis.frontLeft.bumped||i.chassis.frontRight.bumped||i.chassis.backLeft.bumped||i.chassis.backRight.bumped;s.touch=n?1:0},t}();e.TapSensor=R;var E=function(){function t(){this.bumped=!1,this.drawPriority=4}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_TOUCH+"</label><span>"+this.bumped+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.touch=s.touch||{},s.touch=this.bumped=i.chassis.bumpedAngle.length>0},t}();e.RobotinoTouchSensor=E;var L=function(){function t(t,e,i,s,r,a){this.color="grey",this.colorValue="NONE",this.lightValue=0,this.rgb=[0,0,0],this.rx=0,this.ry=0,this.drawPriority=6,this.port=t,this.labelPriority=Number(this.port.replace("ORT_","")),this.x=e,this.y=i,this.theta=s,this.r=r,this.color=a||this.color}return t.prototype.draw=function(t,e){t.save(),t.beginPath(),t.arc(this.x,this.y,this.r,0,2*Math.PI),t.fillStyle=this.color,t.fill(),t.strokeStyle="black",t.stroke(),t.translate(this.x,this.y),t.beginPath(),t.fillStyle="#555555",t.fillText(this.port,-12,4),t.restore()},t.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_COLOUR+"</label></div><div><label>&nbsp;-&nbsp;"+h.Msg.MODE_COLOUR+'</label><span style="margin-left:6px; width: 20px; border-style:solid; border-width:thin; background-color:'+this.color+'">&nbsp;</span></div><div><label>&nbsp;-&nbsp;'+h.Msg.MODE_LIGHT+"</label><span>"+a.round(this.lightValue,0)+" %</span></div>"},t.prototype.updateSensor=function(t,e,i,s,o,n){s.color=s.color||{},s.light=s.light||{},s.color[this.port]={},s.light[this.port]={},r.transform(i.pose,this);var h=0,l=0,u=0,p=Math.round(this.rx-3),d=Math.round(this.ry-3);try{for(var c=o.getImageData(p,d,6,6),y=n.getImageData(p,d,6,6),f=0;f<=c.data.length;f+=4)if(255===y.data[f+3])for(var b=f;b<f+3;b++)c.data[b]=y.data[b];var g=[0,4,16,20,24,44,92,116,120,124,136,140];for(b=0;b<c.data.length;b+=24)for(f=b;f<b+24;f+=4)g.indexOf(f)<0&&(h+=c.data[f],l+=c.data[f+1],u+=c.data[f+2]);var x=c.data.length/4-12;h/=x,l/=x,u/=x,this.colorValue=r.getColor(r.rgbToHsv(h,l,u)),this.rgb=[a.round(h,0),a.round(l,0),a.round(u,0)],"NONE"===this.colorValue?this.color="grey":this.color=this.colorValue.toString().toLowerCase(),this.lightValue=(h+l+u)/3/2.55}catch(t){}s.color[this.port].colorValue=this.colorValue,s.color[this.port].colour=this.colorValue,s.color[this.port].light=this.lightValue,s.color[this.port].rgb=this.rgb,s.color[this.port].ambientlight=0},t}();e.ColorSensor=L;var B=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.ledColor="",e}return __extends(e,t),e.prototype.updateAction=function(t,e,i){var s=t.interpreter.getRobotBehaviour().getActionState("leds",!0);if(s&&s[this.port]){var r=s[this.port];switch(r.mode){case"off":this.ledColor="";break;case"on":this.ledColor=r.color.toUpperCase()}}},e.prototype.draw=function(t,e){t.save(),t.beginPath(),t.arc(this.x,this.y,this.r,0,2*Math.PI),t.fillStyle=this.color,t.fill(),t.strokeStyle="black",t.stroke(),t.translate(this.x,this.y),t.beginPath(),t.fillStyle="#555555",t.fillText(this.port,-12,4),t.restore(),this.ledColor&&(t.fillStyle=this.ledColor,t.beginPath(),t.arc(this.x,this.y,this.r/2,0,2*Math.PI),t.fill())},e.prototype.reset=function(){this.ledColor=""},e}(L);e.NXTColorSensor=B;var O=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.draw=function(t,e){t.save(),t.beginPath(),t.arc(this.x,this.y,this.r,0,2*Math.PI);var i=parseInt(String(2.55*this.lightValue),10).toString(16);t.fillStyle="#"+i+i+i,t.fill(),t.strokeStyle="black",t.stroke(),t.translate(this.x,this.y),t.beginPath(),t.fillStyle="#555555",t.fillText(this.port,-12,4),t.restore()},e.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_LIGHT+"</label></div><div><label>&nbsp;-&nbsp;"+h.Msg.MODE_LIGHT+"</label><span>"+a.round(this.lightValue,0)+" %</span></div>"},e}(L);e.LightSensor=O;var T=function(t){function e(e,i,s,r,a,o,n){var h=t.call(this,i.replace("DI","").toString(),s,r,a,o)||this;return h.name=e,h}return __extends(e,t),e.prototype.getLabel=function(){return"<div><label>"+this.name+" "+h.Msg.SENSOR_OPTICAL+"</label></div><div><label>&nbsp;-&nbsp;"+h.Msg.MODE_OPENING+"</label><span>"+this.light+"</span></div><div><label>&nbsp;-&nbsp;"+h.Msg.MODE_CLOSING+"</label><span>"+!this.light+"</span></div>"},e.prototype.draw=function(t,e){t.save(),t.beginPath(),t.arc(this.x,this.y,this.r,0,2*Math.PI),t.fillStyle=this.color,t.fill(),t.strokeStyle="black",t.stroke(),t.translate(this.x,this.y),t.beginPath(),t.fillStyle="#555555",t.fillText(this.name,8,4),t.restore()},e.prototype.updateSensor=function(e,i,r,a,o,n){t.prototype.updateSensor.call(this,e,i,r,a,o,n),this.lightValue=this.lightValue>50?100:0,this.light=0!=this.lightValue,this.color=0==this.lightValue?"black":"white",a.optical=a.optical||{},a.optical[this.name]={},a.optical[this.name][s.OPENING]=this.light,a.optical[this.name][s.CLOSING]=!this.light},e}(O);e.OpticalSensor=T;var D=function(){function t(){this.angleValue=0,this.rateValue=0}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_GYRO+"</label><span>"+a.round(this.angleValue,0)+" °</span></div>"},t.prototype.reset=function(){this.angleValue=0,this.rateValue=0},t.prototype.updateAction=function(t,e,i){},t.prototype.updateSensor=function(t,e,i,s,r,a,o){},t}();e.GyroSensor=D;var w=function(t){function e(e,i,s,r){var a=t.call(this)||this;return a.color="#000000",a.port=e,a.x=i,a.y=s,a.theta=r,a}return __extends(e,t),e.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_GYRO+"</label><span>"+a.round(this.angleValue,0)+" °</span></div>"},e.prototype.updateAction=function(t,e,i){var s=t.interpreter.getRobotBehaviour().getActionState("gyroReset",!1);s&&s[this.port]&&(t.interpreter.getRobotBehaviour().getActionState("gyroReset",!0),this.reset())},e.prototype.updateSensor=function(t,e,i,s,a,o,n){s.gyro=s.gyro||{},s.gyro[this.port]={},this.angleValue+=r.toDegree(i.thetaDiff),s.gyro[this.port].angle=this.angleValue,this.rateValue=e*r.toDegree(i.thetaDiff),s.gyro[this.port].rate=this.rateValue},e}(D);e.GyroSensorExt=w;var A=function(){function t(){this.keys={}}return t.prototype.getLabel=function(){return""},t}();e.Keys=A;var N=function(t){function e(e,i){var s=t.call(this)||this;for(var r in e)s.keys[e[r].name]=e[r];return s}return __extends(e,t),e.prototype.updateSensor=function(t,e,i,s,r,a,o){for(var n in s.buttons={},s.buttons.any=!1,s.buttons.Reset=!1,this.keys)s.buttons[n]=!0===this.keys[n].value,s.buttons.any=s.buttons.any||this.keys[n].value},e}(A);e.EV3Keys=N;var k=function(t){function e(e,i,s){var r=t.call(this)||this;for(var a in r.color2Keys={},r.$touchLayer=u("#robotLayer"),r.isDown=!1,r.id=i,r.$touchLayer=s||r.$touchLayer,e)r.keys[e[a].port]=e[a];return e.forEach((function(t){t.touchColors.forEach((function(e){r.color2Keys[e]=[t.port]}))})),r.addMouseEvents(i),r}return __extends(e,t),e.prototype.handleMouseDown=function(t){var e=this;t&&!t.startX&&a.extendMouseEvent(t,p.SimulationRoberta.Instance.scale,this.$touchLayer);var i=t;if(this.lastMousePosition={x:i.startX,y:i.startY},void 0!==this.uCtx){var s=this.uCtx.getImageData(this.lastMousePosition.x,this.lastMousePosition.y,1,1).data;this.lastMouseColor=a.RGBAToHexA([s[0],s[1],s[2],s[3]])}this.isDown=!0;var r=this.color2Keys[this.lastMouseColor];r&&r.length>0&&(this.$touchLayer.data("hovered",!0),this.$touchLayer.css("cursor","pointer"),t.stopImmediatePropagation(),r.forEach((function(t){e.keys[t].value=!0})))},e.prototype.handleMouseMove=function(t){t&&!t.startX&&a.extendMouseEvent(t,p.SimulationRoberta.Instance.scale,this.$touchLayer);var e=t;if(this.lastMousePosition={x:e.startX,y:e.startY},void 0!==this.uCtx){var i=this.uCtx.getImageData(this.lastMousePosition.x,this.lastMousePosition.y,1,1).data;this.lastMouseColor=a.RGBAToHexA([i[0],i[1],i[2],i[3]])}var s=this.color2Keys[this.lastMouseColor];s&&s.length>0&&(this.$touchLayer.data("hovered",!0),this.$touchLayer.css("cursor","pointer"),t.stopImmediatePropagation())},e.prototype.handleMouseOutUp=function(t){for(var e in this.keys)this.keys[e].value=!1;this.isDown=!1},e.prototype.updateSensor=function(t,e,i,s,r,a,o){for(var n in void 0===this.uCtx&&(this.uCtx=r),s.buttons={},this.keys)s.buttons[n]=!0===this.keys[n].value},e.prototype.addMouseEvents=function(t){this.$touchLayer.on("mousedown.R"+t+" touchstart.R"+t,this.handleMouseDown.bind(this)),this.$touchLayer.on("mousemove.R"+t+" touchmove.R"+t,this.handleMouseMove.bind(this)),this.$touchLayer.on("mouseup.R"+t+" touchend.R"+t+" mouseout.R"+t+" touchcancel.R"+t,this.handleMouseOutUp.bind(this))},e}(A);e.TouchKeys=k;var C=function(t){function e(e,i,s,r){var a=t.call(this,e,i)||this,o=u("#mbedButtons");return a.transP=s,a.groundP=r,e.forEach((function(t){if("TOUCH"!==t.type){var e=1023;o.append('<label for="rangePin'+t.port+'" style="margin: 12px 8px 8px 0" lkey="Blockly.Msg.SENSOR_PIN">'+h.Msg.SENSOR_PIN+" "+t.name+"</label>"),"DIGITAL_PIN"===t.type&&(e=1),o.append('<input type="text" value="0" style="margin-bottom: 8px;margin-top: 12px; min-width: 45px; width: 45px; display: inline-block; border: 1px solid #333; border-radius: 2px; text-align: right; float: right; padding: 0" id="rangePin'+t.port+'" name="rangePin'+t.port+'" class="range" />'),o.append('<div style="margin:8px 0;"><input id="sliderPin'+t.port+'" type="range" min="0" max="'+e+'" value="0" step="1" /></div>'),j(u("#sliderPin"+t.port),u("#rangePin"+t.port),a.keys[t.port],"typeValue",{min:0,max:e})}})),a}return __extends(e,t),e.prototype.draw=function(t,e){for(var i in this.keys){var s=this.keys[i];switch(s.type){case"TOUCH":s.value&&(t.fillStyle=s.color,t.beginPath(),t.arc(s.x,s.y,s.r,0,2*Math.PI),t.fill(),this.groundP&&(t.fillStyle="red",t.beginPath(),t.arc(this.groundP.x,this.groundP.y,25,0,2*Math.PI),t.fill()));break;case"DIGITAL_PIN":t.fillStyle=s.color,t.beginPath(),t.save();var r=s.x+this.transP.x,a=s.y+this.transP.y;t.translate(r,a),t.save(),t.rotate(Math.PI/2),t.font="bold 100px Roboto",t.fillText("< ",0,0),t.restore(),t.font="20px Courier",t.fillText("⊓",-16,16),t.fillText(s.typeValue,50,16),t.restore();break;case"ANALOG_PIN":t.fillStyle=s.color,t.beginPath(),t.save();r=s.x+this.transP.x,a=s.y+this.transP.y;t.translate(r,a),t.save(),t.rotate(Math.PI/2),t.font="bold 100px Roboto",t.fillText("< ",0,0),t.restore(),t.font="20px Courier",t.fillText("∿",-16,16),t.fillText(s.typeValue,50,16),t.restore()}}},e.prototype.updateSensor=function(t,e,i,s,r,a,o){for(var n in void 0===this.uCtx&&(this.uCtx=r),this.keys)s["pin"+n]={},s["pin"+n].pressed=!0===this.keys[n].value,s["pin"+n].analog=s["pin"+n].digital=this.keys[n].typeValue},e}(k);e.Pins=C;var U=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.draw=function(t,e){for(var i in this.keys){var s=this.keys[i];switch(s.type){case"TOUCH":s.value&&(t.fillStyle=s.color,t.beginPath(),t.fillStyle="green",t.beginPath(),t.fillRect(s.x,s.y,s.r,s.r),t.fill(),t.fillStyle="red",t.beginPath(),t.arc(this.groundP.x,this.groundP.y,36,0,2*Math.PI),t.fill());break;case"DIGITAL_PIN":t.fillStyle=s.color,t.beginPath(),t.save();var r=s.x+this.transP.x,a=s.y+this.transP.y;t.translate(r,a),t.save(),t.rotate(Math.PI/2),t.font="bold 100px Roboto",t.fillText("< ",0,0),t.restore(),t.font="20px Courier",t.fillText("⊓",-16,16),t.fillText(s.typeValue,50,16),t.restore();break;case"ANALOG_PIN":t.fillStyle=s.color,t.beginPath(),t.save();r=s.x+this.transP.x,a=s.y+this.transP.y;t.translate(r,a),t.save(),t.rotate(Math.PI/2),t.font="bold 100px Roboto",t.fillText("< ",0,0),t.restore(),t.font="20px Courier",t.fillText("∿",-16,16),t.fillText(s.typeValue,50,16),t.restore()}}},e}(C);e.MicrobitPins=U;var G=function(t){function e(e,i){return t.call(this,e,i,u("#brick"+i))||this}return __extends(e,t),e.prototype.handleMouseDown=function(t){var e=this;t&&!t.startX&&a.extendMouseEvent(t,1,this.$touchLayer);var i=t;this.lastMousePosition={x:i.startX,y:i.startY};var s=this.$touchLayer.get(0).getContext("2d").getImageData(this.lastMousePosition.x,this.lastMousePosition.y,1,1).data;this.lastMouseColor=a.RGBAToHexA([s[0],s[1],s[2],s[3]]),this.isDown=!0;var r=this.color2Keys[this.lastMouseColor];r&&r.length>0&&(this.$touchLayer.data("hovered",!0),this.$touchLayer.css("cursor","pointer"),t.stopImmediatePropagation(),r.forEach((function(t){e.keys[t].value=!0})))},e.prototype.handleMouseMove=function(t){t&&!t.startX&&a.extendMouseEvent(t,1,this.$touchLayer);var e=t;this.lastMousePosition={x:e.startX,y:e.startY};var i=this.color2Keys[this.lastMouseColor],s=this.$touchLayer.get(0).getContext("2d").getImageData(this.lastMousePosition.x,this.lastMousePosition.y,1,1).data;this.lastMouseColor=a.RGBAToHexA([s[0],s[1],s[2],s[3]]),i&&i.length>0?(this.$touchLayer.data("hovered",!0),this.$touchLayer.css("cursor","pointer"),t.stopImmediatePropagation()):this.$touchLayer.data().hovered?this.$touchLayer.data("hovered",!1):this.$touchLayer.css("cursor","move")},e.prototype.updateSensor=function(t,e,i,s,r,a,o){for(var n in s.buttons={},this.keys)s.buttons[n]=!0===this.keys[n].value},e}(k);e.MbotButton=G;var V=function(){function t(){this.gesture={up:!0},this.labelPriority=10,u("#mbedButtons").append('<label style="margin: 12px 8px 8px 0" lkey="Blockly.Msg.SENSOR_GESTURE">'+h.Msg.SENSOR_GESTURE+'</label><label class="btn simbtn active" lkey="Blockly.Msg.SENSOR_GESTURE_UP"><input type="radio" id="up" name="options" autocomplete="off">'+h.Msg.SENSOR_GESTURE_UP+'</label><label class="btn simbtn" lkey="Blockly.Msg.SENSOR_GESTURE_DOWN"><input type="radio" id="down" name="options" autocomplete="off" >'+h.Msg.SENSOR_GESTURE_DOWN+'</label><label class="btn simbtn" lkey="Blockly.Msg.SENSOR_GESTURE_FACE_DOWN"><input type="radio" id="face_down" name="options" autocomplete="off" >'+h.Msg.SENSOR_GESTURE_FACE_DOWN+'</label><label class="btn simbtn" lkey="Blockly.Msg.SENSOR_GESTURE_FACE_UP"><input type="radio" id="face_up" name="options" autocomplete="off" >'+h.Msg.SENSOR_GESTURE_FACE_UP+'</label><label class="btn simbtn" lkey="Blockly.Msg.SENSOR_GESTURE_SHAKE"><input type="radio" id="shake" name="options" autocomplete="off" >'+h.Msg.SENSOR_GESTURE_SHAKE+'</label><label class="btn simbtn" lkey="Blockly.Msg.SENSOR_GESTURE_FREEFALL"><input type="radio" id="freefall" name="options" autocomplete="off" >'+h.Msg.SENSOR_GESTURE_FREEFALL+"</label>");var t=this;u('input[name="options"]').on("change",(function(e){t.gesture={},t.gesture[e.currentTarget.id]=!0}))}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_GESTURE+"</label><span>"+h.Msg["SENSOR_GESTURE_"+Object.getOwnPropertyNames(this.gesture)[0].toUpperCase()]+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.gesture={};var n=Object.getOwnPropertyNames(this.gesture)[0];s.gesture[n]=this.gesture[n]},t}();e.GestureSensor=V;var F=function(){function t(){this.degree=0,this.labelPriority=11,u("#mbedButtons").append('<div><label for="rangeCompass" lkey="Blockly.Msg.SENSOR_COMPASS" style="margin: 12px 8px 8px 0">'+h.Msg.SENSOR_COMPASS+'</label><input class="range" id="rangeCompass" name="rangeCompass" style="margin-bottom: 8px;margin-top: 12px; min-width: 45px; width: 45px; display: inline-block; border: 1px solid #333; border-radius: 2px; text-align: right; float: right; padding: 0" type="text" value="0" /></div><div style="margin:8px 0; "><input id="sliderCompass" max="360" min="0" step="5" type="range" value="0" /></div>'),j(u("#sliderCompass"),u("#rangeCompass"),this,"degree",{min:0,max:360})}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_COMPASS+"</label><span>"+this.degree+" °</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.compass={},s.compass.angle=this.degree},t}();e.CompassSensor=F;var H=function(){function t(){this.dx=60,this.dy=60,this.lightLevel=0,this.x=342,this.y=546,this.labelPriority=12,u("#mbedButtons").append('<div><label for="rangeLight" style="margin: 12px 8px 8px 0" lkey="Blockly.Msg.SENSOR_LIGHT">'+h.Msg.SENSOR_LIGHT+'</label><input type="text" value="0" style="margin-bottom: 8px;margin-top: 12px; min-width: 45px; width: 45px; display: inline-block; border: 1px solid #333; border-radius: 2px; text-align: right; float: right; padding: 0;" id="rangeLight" name="rangeLight" class="range" /></div><div style="margin:8px 0; "><input id="sliderLight" type="range" min="0" max="100" value="0" /></div>'),j(u("#sliderLight"),u("#rangeLight"),this,"lightLevel",{min:0,max:100})}return t.prototype.draw=function(t,e){t.save(),t.beginPath(),t.fillStyle="#ffffff",t.globalAlpha=this.lightLevel/500,t.rect(this.x-this.dx/2,this.y+this.dy/2,5*this.dx,-5*this.dy),t.fill(),t.globalAlpha=1,t.restore()},t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_LIGHT+"</label><span>"+this.lightLevel+" %</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.light={},s.light.ambientlight=this.lightLevel},t}();e.CalliopeLightSensor=H;var $=function(){function t(){this.dx=60,this.dy=60,this.lightLevel=0,this.x=342,this.y=546,this.labelPriority=12,u("#mbedButtons").append('<div><label for="rangeLight" style="margin: 12px 8px 8px 0" lkey="Blockly.Msg.SENSOR_INFRARED">'+h.Msg.SENSOR_INFRARED+'</label><input type="text" value="0" style="margin-bottom: 8px;margin-top: 12px; min-width: 45px; width: 45px; display: inline-block; border: 1px solid #333; border-radius: 2px; text-align: right; float: right; padding: 0;" id="rangeLight" name="rangeLight" class="range" /></div><div style="margin:8px 0; "><input id="sliderLight" type="range" min="0" max="1023" value="0" /></div>'),j(u("#sliderLight"),u("#rangeLight"),this,"lightLevel",{min:0,max:1023})}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_INFRARED+"</label><span>"+this.lightLevel+"</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.light={},s.light.ambientlight=this.lightLevel,s.light.reflected=this.lightLevel},t}();e.Rob3rtaInfraredSensor=$;var X=function(){function t(){this.degree=20,this.labelPriority=13,u("#mbedButtons").append('<div><label for="rangeTemperature" style="margin: 12px 8px 8px 0" lkey="Blockly.Msg.SENSOR_TEMPERATURE">'+h.Msg.SENSOR_TEMPERATURE+'</label><input type="text" value="0" style="margin-bottom: 8px;margin-top: 12px; min-width: 45px; width: 45px; display: inline-block; border: 1px solid #333; border-radius: 2px; text-align: right; float: right; padding: 0;" id="rangeTemperature" name="rangeTemperature" class="range" /></div><div style="margin:8px 0; "><input id="sliderTemperature" type="range" min="-25" max="75" value="0" step="1" /></div>'),j(u("#sliderTemperature"),u("#rangeTemperature"),this,"degree",{min:-15,max:75})}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_TEMPERATURE+"</label><span>"+this.degree+" °</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,a,o){s.temperature={},s.temperature.value=this.degree},t}();e.TemperatureSensor=X;var K=function(){function t(t){this.labelPriority=16,this.volume=0,void 0===window.navigator.mediaDevices&&(window.navigator.mediaDevices={}),this.webAudio=t.webAudio,window.navigator.mediaDevices.getUserMedia=navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var e=this;try{navigator.mediaDevices.getUserMedia({audio:{mandatory:{googEchoCancellation:"false",googAutoGainControl:"false",googNoiseSuppression:"false",googHighpassFilter:"false"},optional:[]}}).then((function(t){var i=e.webAudio.context.createMediaStreamSource(t);e.sound=l.createAudioMeter(e.webAudio.context),i.connect(e.sound)}),(function(){console.log("Sorry, but there is no microphone available on your system")}))}catch(t){console.log("Sorry, but there is no microphone available on your system")}}return t.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_SOUND+"</label><span>"+a.round(this.volume,0)+" %</span></div>"},t.prototype.updateSensor=function(t,e,i,s,r,o,n){this.volume=this.sound?a.round(100*this.sound.volume,0):0,s.sound={},s.sound.volume=this.volume},t}();e.VolumeMeterSensor=K;var q=function(t){function e(e,i){var s=t.call(this,e)||this;return s.theta=0,s.x=0,s.y=0,s.port=i,s.labelPriority=Number(s.port.replace("ORT_","")),s}return __extends(e,t),e.prototype.getLabel=function(){return"<div><label>"+this.port.replace("ORT_","")+" "+h.Msg.SENSOR_SOUND+"</label><span>"+a.round(this.volume,0)+" %</span></div>"},e.prototype.updateSensor=function(t,e,i,s,r,o,n){this.volume=this.sound?a.round(100*this.sound.volume,0):0,s.sound={},s.sound[this.port]={},s.sound[this.port].volume=this.volume},e}(K);e.SoundSensor=q;var Y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.getLabel=function(){return"<div><label>"+h.Msg.SENSOR_SOUND+"</label><span>"+(this.volume>25?"true":"false")+"</span></div>"},e.prototype.updateSensor=function(e,i,s,r,a,o,n){t.prototype.updateSensor.call(this,e,i,s,r,a,o,n),r.sound.volume=this.volume>25},e}(K);function j(t,e,i,s,r){t.on("mousedown touchstart",(function(t){t.stopPropagation()})),t.on("input change",(function(r){r.preventDefault(),e.val(t.val()),i[s]=Number(t.val()),r.stopPropagation()})),e.on("change",(function(a){a.preventDefault();var o=Number(e.val());e.valid()?(o<r.min?o=r.min:o>r.max&&(o=r.max),e.val(o),t.val(o),i[s]=o):e.val(t.val()),a.stopPropagation()})),e.val(i[s]),t.val(i[s]),u("#mbed-form").validate(),e.rules("add",{messages:{required:!1,number:!1}})}e.SoundSensorBoolean=Y;var W=function(){function t(){this.x=0,this.y=0,this.theta=0,this.labelPriority=7}return t.prototype.getLabel=function(){var t="<div><label>"+h.Msg.SENSOR_ODOMETRY+"</label></div>";return t+="<div><label>&nbsp;-&nbsp;x</label><span>"+a.round(this.x,1)+" cm</span></div>",t+="<div><label>&nbsp;-&nbsp;y</label><span>"+a.round(this.y,1)+" cm</span></div>",t+="<div><label>&nbsp;-&nbsp;θ</label><span>"+a.round(this.theta,0)+" °</span></div>"},t.prototype.reset=function(){this.x=0,this.y=0,this.theta=0},t.prototype.updateSensor=function(t,e,i,a,o,n,h){a.odometry=a.odometry||{},this.theta+=r.toDegree(i.thetaDiff),a.odometry[s.THETA]=this.theta,this.x+=i.chassis.xDiff/3,a.odometry[s.X]=this.x,this.y+=i.chassis.yDiff/3,a.odometry[s.Y]=this.y},t.prototype.updateAction=function(t,e,i){if(i){var r=t.interpreter.getRobotBehaviour().getActionState("odometry",!0);if(r&&r.reset)switch(r.reset){case s.X:this.x=0;break;case s.Y:this.y=0;break;case s.THETA:this.theta=0;break;case"all":this.reset()}}},t}();e.OdometrySensor=W;var Q=function(){function t(t,e){this.MAX_MARKER_DIST_SQR=202500,this.MAX_CAM_Y=Math.sqrt(this.MAX_MARKER_DIST_SQR),this.MAX_BLOB_DIST_SQR=this.MAX_MARKER_DIST_SQR,this.LINE_RADIUS=60,this.AOV=2*Math.PI/5,this.listOfMarkersFound=[],this.bB={x:0,y:0,w:0,h:0},this.labelPriority=8,this.THRESHOLD=126,this.drawPriority=1,this.x=t.x,this.y=t.y,this.theta=t.theta,this.AOV=e}return t.prototype.updateAction=function(t,e,i){if(i){var s=t.interpreter.getRobotBehaviour().getActionState("colourBlob",!0);s&&(this.colourBlob=s)}this.colourBlob={minHue:0,maxHue:240,minSat:90,maxSat:110,minVal:90,maxVal:110}},t.prototype.draw=function(t,e){t.save(),t.beginPath(),t.strokeStyle="#0000ff",t.beginPath(),t.arc(this.x,this.y,1e3,Math.PI/5,-Math.PI/5,!0),t.arc(this.x,this.y,this.LINE_RADIUS,-Math.PI/5,+Math.PI/5,!1),t.closePath(),t.stroke(),t.restore()},t.prototype.getLabel=function(){var t="<div><label>Line Sensor</label><span>"+a.round(this.line,2)+"</span></div>";t+="<div><label>Marker Sensor</label></div>";for(var e=0;e<this.listOfMarkersFound.length;e++){var i=this.listOfMarkersFound[e];t+="<div><label>&nbsp;-&nbsp;id ",t+=i.markerId,t+="</label><span>[",t+=a.round(i.xDist,0),t+=", ",t+=a.round(i.yDist,0),t+=", ",t+=a.round(i.zDist,0),t+="] cm</span></div>"}return t},t.prototype.reset=function(){},t.prototype.updateSensor=function(t,e,a,o,n,h,l,u){var p=this;this.listOfMarkersFound=[];var d=a;r.transform(d.pose,this);var c=new i.Pose(this.rx,this.ry,this.theta),y=(a.pose.theta-this.AOV/2+2*Math.PI)%(2*Math.PI),f=(a.pose.theta+this.AOV/2+2*Math.PI)%(2*Math.PI);u.filter((function(t){if(t.sqrDist=r.getDistance(c,t),t.sqrDist<=p.MAX_MARKER_DIST_SQR){for(var e=[{x:t.x-c.x,y:t.y-c.y},{x:t.x+t.w-c.x,y:t.y-c.y},{x:t.x+t.w-c.x,y:t.y+t.h-c.y},{x:t.x-c.x,y:t.y+t.h-c.y}],i=!0,s=0;s<e.length;s++){var a=(Math.atan2(e[s].y,e[s].x)+2*Math.PI)%(2*Math.PI);if(y<f&&a>y&&a<f||y>f&&(a>y||a<f))p.checkVisibility(d.id,t,l)&&(i=!1);else i=!1}return i}})).forEach((function(t){var e=(Math.atan2(t.y+t.h/2-c.y,t.x+t.w/2-c.x)+2*Math.PI)%(2*Math.PI),i=f;y>i&&(i+=2*Math.PI,e<y&&(e+=2*Math.PI));var s=Math.sqrt(t.sqrDist);t.xDist=((e-y)/(i-y)-.5)*p.AOV*s/3,t.yDist=(s/p.MAX_CAM_Y-.5)*p.MAX_CAM_Y/3,t.zDist=s/3,p.listOfMarkersFound.push(t)})),this.line=-1;var b={x:this.LINE_RADIUS*Math.cos(y),y:this.LINE_RADIUS*Math.sin(y)},g={x:this.LINE_RADIUS*Math.cos(f),y:this.LINE_RADIUS*Math.sin(f)},x=Math.atan2(b.y,b.x),v=Math.atan2(g.y,g.x),S=Math.abs(g.y-b.y),M=Math.abs(g.x-b.x),m=void 0;if(this.bB={h:0,w:0,x:0,y:0},S>M)if(b.x>0){this.bB.x=Math.min(b.x,g.x)+this.rx,this.bB.y=Math.min(b.y,g.y)+this.ry,this.bB.w=Math.max(Math.max(b.x,g.x),this.LINE_RADIUS)+this.rx-this.bB.x+1,this.bB.h=-this.bB.y+Math.max(Math.max(b.y,g.y))+this.ry+1,this.constrainBB(n);var I=this.bB&&n.getImageData(this.bB.x,this.bB.y,this.bB.w,this.bB.h),P=this.bB&&h.getImageData(this.bB.x,this.bB.y,this.bB.w,this.bB.h);if(I)for(var _=0;_<I.height;_++){var R=this.LINE_RADIUS*this.LINE_RADIUS-(_+this.bB.y-this.ry)*(_+this.bB.y-this.ry),E=4*((B=Math.round(Math.sqrt(R)-(this.bB.x-this.rx)))+_*I.width);if((D=(T=this.getPixelData(P,E,I,m)).redPix)!==(m=T.redPixOld)){var L=Math.atan2(_+this.bB.y-this.ry,B+this.bB.x-this.rx);this.line=(L-x)/(v-x)-.5;break}m=D}}else{this.bB.y=Math.min(b.y,g.y)+this.ry-1,this.bB.x=Math.min(Math.min(b.x,g.x),-this.LINE_RADIUS)+this.rx-1,this.bB.w=Math.max(b.x,g.x)+this.rx-this.bB.x,this.bB.h=-this.bB.y+Math.max(Math.max(b.y,g.y))+this.ry,this.constrainBB(n);I=this.bB&&n.getImageData(this.bB.x,this.bB.y,this.bB.w,this.bB.h),P=this.bB&&h.getImageData(this.bB.x,this.bB.y,this.bB.w,this.bB.h);if(I)for(_=I.height-1;_>0;_--){var B;R=this.LINE_RADIUS*this.LINE_RADIUS-(_+this.bB.y-this.ry)*(_+this.bB.y-this.ry),E=4*((B=Math.round(-Math.sqrt(R)-(this.bB.x-this.rx)))+_*I.width)-4;if((D=(T=this.getPixelData(P,E,I,m)).redPix)!==(m=T.redPixOld)){(L=Math.atan2(_+this.bB.y-this.ry,B+this.bB.x-this.rx))<=0&&(L+=2*Math.PI),x<=0&&(x+=2*Math.PI),v<=0&&(v+=2*Math.PI),this.line=(L-x)/(v-x)-.5;break}m=D}}else if(b.y<0){this.bB.x=Math.min(Math.min(b.x,g.x),this.LINE_RADIUS)+this.rx,this.bB.w=Math.max(b.x,g.x)+this.rx-this.bB.x+1,this.bB.y=Math.min(Math.min(b.y,g.y),-this.LINE_RADIUS)+this.ry,this.bB.h=Math.max(b.y,g.y)+this.ry-this.bB.y+1,this.constrainBB(n);I=this.bB&&n.getImageData(this.bB.x,this.bB.y,this.bB.w+1,this.bB.h+1),P=this.bB&&h.getImageData(this.bB.x,this.bB.y,this.bB.w+1,this.bB.h+1);if(I)for(_=0;_<I.width-1;_++){R=this.LINE_RADIUS*this.LINE_RADIUS-(_+this.bB.x-this.rx)*(_+this.bB.x-this.rx),E=4*(_+(O=Math.round(-Math.sqrt(R)-this.bB.y+this.ry))*I.width);if((D=(T=this.getPixelData(P,E,I,m)).redPix)!==(m=T.redPixOld)){L=Math.atan2(O+this.bB.y-this.ry,_+this.bB.x-this.rx);this.line=-1*((L-v)/(x-v)-.5);break}m=D}}else{this.bB.x=Math.min(Math.min(b.x,g.x),this.LINE_RADIUS)+this.rx,this.bB.w=Math.max(b.x,g.x)+this.rx-this.bB.x+1,this.bB.y=Math.min(b.y,g.y)+this.ry,this.bB.h=Math.max(Math.max(b.y,g.y),this.LINE_RADIUS)+this.ry-this.bB.y+1,this.constrainBB(n);I=this.bB&&n.getImageData(this.bB.x,this.bB.y,this.bB.w,this.bB.h),P=this.bB&&h.getImageData(this.bB.x,this.bB.y,this.bB.w,this.bB.h);if(I)for(_=I.width-1;_>=0;_--){var O,T,D;R=this.LINE_RADIUS*this.LINE_RADIUS-(_+this.bB.x-this.rx)*(_+this.bB.x-this.rx),E=4*(_+(O=Math.round(Math.sqrt(R)-this.bB.y+this.ry)-1)*I.width)-4;if((D=(T=this.getPixelData(P,E,I,m)).redPix)!==(m=T.redPixOld)){L=Math.atan2(O+this.bB.y-this.ry,_+this.bB.x-this.rx);this.line=(L-x)/(v-x)-.5;break}m=D}}o.marker={},o.marker[s.INFO]={};for(_=0;_<16;_++)o.marker[s.INFO][_]=[-1,-1,0];0==this.listOfMarkersFound.length?o.marker[s.ID]=[-1]:(o.marker[s.ID]=this.listOfMarkersFound.map((function(t){return t.markerId})),this.listOfMarkersFound.forEach((function(t){o.marker[s.INFO][t.markerId]=[t.xDist,t.yDist,t.zDist]}))),o.camera={},o.camera[s.LINE]=this.line,l.filter((function(t){if(p.checkHSVRange(t.hsv)&&(t.sqrDist=r.getDistance(c,t),t.sqrDist<=p.MAX_BLOB_DIST_SQR)){for(var e=[{x:t.x-c.x,y:t.y-c.y}],i=!0,s=0;s<e.length;s++){var a=(Math.atan2(e[s].y,e[s].x)+2*Math.PI)%(2*Math.PI);if(y<f&&a>y&&a<f||y>f&&(a>y||a<f))p.checkVisibility(d.id,t,l)&&(i=!1);else i=!1}return i}}))},t.prototype.getPixelData=function(t,e,i,s){if(255===t.data[e+3])for(var r=e;r<e+3;r++)i.data[r]=t.data[r];var a=this.calculatePix(i.data.slice(e,e+3));return null==s&&(s=a),{redPix:a,redPixOld:s}},t.prototype.calculatePix=function(t){return.299*t[0]+.587*t[1]+.114*t[2]>this.THRESHOLD?255:0},t.prototype.checkVisibility=function(t,e,i){for(var s,a={x1:this.rx,y1:this.ry,x2:e.x,y2:e.y},h=0;h<i.length-1;h++){var l=i[h];if(!(l instanceof o.ChassisMobile&&l.id==t)&&l!==e)if(l instanceof n.CircleSimulationObject){var u=l;if(s=r.getClosestIntersectionPointCircle(a,u))return s}else for(var p=l.getLines(),d=0;d<p.length;d++)if(s=r.getIntersectionPoint(a,p[d]))return s}return null},t.prototype.checkHSVRange=function(t){return!!(this.colourBlob&&t&&t[0]>=this.colourBlob.minHue&&t[0]<=this.colourBlob.maxHue&&t[1]>=this.colourBlob.minSat&&t[1]<=this.colourBlob.maxSat&&t[2]>=this.colourBlob.minVal&&t[2]<=this.colourBlob.maxVal)},t.prototype.constrainBB=function(t){this.bB.x=this.bB.x<0?0:this.bB.x,this.bB.y=this.bB.y<0?0:this.bB.y,(this.bB.x+this.bB.w>t.canvas.width&&(this.bB.w=t.canvas.width-this.bB.x,this.bB.w<1)||this.bB.y+this.bB.h>t.canvas.height&&(this.bB.h=t.canvas.width-this.bB.y,this.bB.h<1))&&(this.bB=null)},t}();e.CameraSensor=Q}));
//# sourceMappingURL=robot.sensors.js.map
//# sourceMappingURL=robot.sensors.js.map
