var __awaiter=this&&this.__awaiter||function(e,n,t,a){return new(t||(t=Promise))((function(r,i){function o(e){try{s(a.next(e))}catch(e){i(e)}}function l(e){try{s(a.throw(e))}catch(e){i(e)}}function s(e){var n;e.done?r(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,l)}s((a=a.apply(e,n||[])).next())}))},__generator=this&&this.__generator||function(e,n){var t,a,r,i,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(s){return function(l){if(t)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(o=0)),o;)try{if(t=1,a&&(r=2&l[0]?a.return:l[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,l[1])).done)return r;switch(a=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return o.label++,{value:l[1],done:!1};case 5:o.label++,a=l[1],l=[0];continue;case 7:l=o.ops.pop(),o.trys.pop();continue;default:if(!(r=o.trys,(r=r.length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){o=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){o.label=l[1];break}if(6===l[0]&&o.label<r[1]){o.label=r[1],r=l;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(l);break}r[2]&&o.ops.pop(),o.trys.pop();continue}l=n.call(e,o)}catch(e){l=[6,e],a=0}finally{t=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},__spreadArray=this&&this.__spreadArray||function(e,n,t){if(t||2===arguments.length)for(var a,r=0,i=n.length;r<i;r++)!a&&r in n||(a||(a=Array.prototype.slice.call(n,0,r)),a[r]=n[r]);return e.concat(a||Array.prototype.slice.call(n))};define(["require","exports","./neuralnetwork.helper","./neuralnetwork.nn","./neuralnetwork.uistate","log","./neuralnetwork.msg","util.roberta","neuralnetwork.linechart","message","jquery"],(function(e,n,t,a,r,i,o,l,s,c,u){var p,d,h,g,f,v;Object.defineProperty(n,"__esModule",{value:!0}),n.getNetwork=n.saveNN2Blockly=n.programWasReplaced=n.resetUserInputs=n.resetSelections=n.drawNetworkUIForTabDefine=n.drawNetworkUIForTabLearn=n.reconstructNNIncludingUI=n.resetUiOnTerminate=n.runNNEditorForTabLearn=n.runNNEditor=n.setupNN=void 0,function(e){e[e.INPUT=0]="INPUT",e[e.HIDDEN=1]="HIDDEN",e[e.OUTPUT=2]="OUTPUT"}(p||(p={})),function(e){e[e.CLICK_WEIGHT_BIAS=0]="CLICK_WEIGHT_BIAS",e[e.CLICK_NODE=1]="CLICK_NODE",e[e.SHOW_ALL=2]="SHOW_ALL"}(d||(d={})),function(e){e[e.RUN=0]="RUN",e[e.LAYER=1]="LAYER",e[e.NEURON=2]="NEURON",e[e.STOP=3]="STOP"}(h||(h={})),function(e){e[e.RUN=0]="RUN",e[e.EPOCH=1]="EPOCH",e[e.DEBUG=2]="DEBUG",e[e.STOP=3]="STOP"}(g||(g={})),function(e){e[e.DEFINE=0]="DEFINE",e[e.LEARN=1]="LEARN"}(f||(f={}));var N=d.SHOW_ALL,y=null,m=null,w=null,b=!1,_=0,E=0,L=!1,A=!1,k=!1,x=null,T=null,I=0,O=[null,0],S=O[0],C=O[1],P=null,D=[],H=[],R=!1,U=[],W=!1,B=!1,M=3,F=3,K=[],V=[],G=0,z=0,j=1e4,Y=[],X=[],Z=!1,q=null,J=null,$=null,Q=0;n.setupNN=function(e){if(b=!1,0!=(m=new r.State(e)).networkShape.length&&0==m.hiddenNeurons.length)for(var n=0;n<m.numHiddenLayers;n++){m.hiddenNeurons.push([]);for(var t=0;t<m.networkShape[n];t++){var a=de(!0,n+1);m.hiddenNeurons[n].push(a)}}ge(),Y=w.getWeightArray(),X=w.getBiasArray()},n.runNNEditor=function(n){return __awaiter(this,void 0,void 0,(function(){function a(){var e=u("#nn-get-shape").val().toString().trim().split(",").filter((function(e){return!Number.isNaN(e)&&0!==Number(e)})).map((function(e){return Number(e)>=10?9:Number(e)})),n=[m.inputs,m.inputs.length],t=n[0],a=n[1];m.inputs=[],e[0]=e[0]>=9?9:e[0];for(var r=0;r<e[0];r++)if(r<a)m.inputs.push(t.shift());else{var i=de();m.inputs.push(i)}m.hiddenNeurons=[],m.networkShape=e.slice(1,-1).map((function(e){return e>=9?9:e})),m.numHiddenLayers=m.networkShape.length;for(r=0;r<m.numHiddenLayers;r++){m.hiddenNeurons.push([]);for(var o=0;o<m.networkShape[r];o++){i=de(!0,r+1);m.hiddenNeurons[r].push(i)}}var l=[m.outputs,m.outputs.length],s=l[0],c=l[1];m.outputs=[],e[e.length-1]=e[e.length-1]>=9?9:e[e.length-1];for(r=0;r<e[e.length-1];r++)if(r<c)m.outputs.push(s.shift());else{i=de();m.outputs.push(i)}se(),ae()}var r,i,o,s,c,p;return __generator(this,(function(g){switch(g.label){case 0:return[4,new Promise((function(n,t){e(["d3"],n,t)}))];case 1:return v=g.sent(),r=0,i=u("#nn-explore-popup-modal"),o=u("#nn-explore-table-user-input"),i.draggable({handle:".modal-header"}),n?(v.select("#goto-sim").style("visibility","visible"),v.select("#goto-sim").on("click",(function(){u.when(u("#tabProgram").trigger("click")).done((function(){u("#simButton").trigger("click")}))}))):v.select("#goto-sim").style("visibility","hidden"),v.select("#nn-focus").on("change",(function(){null==(N=d[this.value])&&(N=d.SHOW_ALL),N!==d.CLICK_NODE&&(y=null),se(),ie(),u("#nn-explore-focus").val(N==d.CLICK_WEIGHT_BIAS?"SHOW_ALL":this.value).change(),u("#nn-learn-focus").val(N==d.CLICK_WEIGHT_BIAS?"SHOW_ALL":this.value).change()})),v.select("#nn-add-layers").on("click",(function(){if(!(m.numHiddenLayers>=6)){m.networkShape[m.numHiddenLayers]=2,m.hiddenNeurons.push([]);for(var e=0;e<2;e++){var n=de(!0,m.numHiddenLayers+1);m.hiddenNeurons[m.numHiddenLayers].push(n)}m.numHiddenLayers++,se(),ae()}})),v.select("#nn-remove-layers").on("click",(function(){m.numHiddenLayers<=0||(m.numHiddenLayers--,m.networkShape.splice(m.numHiddenLayers),se(),ae())})),v.select("#nn-activations").on("change",(function(){m.activationKey=this.value,m.activation=t.activations[this.value],ae()})).property("value",function(e,n){for(var t in e)if(e[t]===n)return t}(t.activations,m.activation)),v.select("#nn-show-precision").on("change",(function(){m.precision=this.value,ie()})),v.select("#nn-get-shape").on("change",a),v.select("#nn-shape-finished-button").on("click",a),s=function(e,n){return String(Math.random()*(n-e)+e)},v.select("#nn-random-values-finished-button").on("click",(function(){var e=u("#nn-random-values-from").val().toString().replace(",","."),n=u("#nn-random-values-to").val().toString().replace(",",".");if(""!==e&&""!==n){var t=Number(e),a=Number(n),r=w.getWeightArray().slice(),i=w.getBiasArray().slice();r=r.map((function(e){return e.map((function(e){return e.map((function(e){return s(t,a)}))}))})),i=i.map((function(e){return e.map((function(e){return s(t,a)}))})),Y=r,X=i,w.setWeightsFromArray(r),w.setBiasFromArray(i),ie()}})),v.select("#nn-explore-run-full").on("click",(function(){x=h.RUN,0!==V.length&&(u("#nn-show-iteration-all").show(),u("#nn-show-next-neuron-all").hide(),z>=V.length&&(z=0),w.setInputValuesFromArray(V[z++]),w.forwardProp(),I=0,C=0,H=[],D=[],se(),ie())})),v.select("#nn-explore-run-layer").on("click",(function(){if(x=h.LAYER,R=!1,0!==V.length){u("#nn-show-iteration-all").show(),u("#nn-show-next-neuron-all").hide();var e=w.getLayerAndNodeArray();I<e.length?(H.push.apply(H,e[I++]),w.setInputValuesFromArray(V[z])):(I=0,H.splice.apply(H,__spreadArray([0,H.length],e[I++],!1)),++z>=V.length&&(z=0),w.setInputValuesFromArray(V[z])),w.forwardProp(),C=0,D=[],se(),ie()}})),v.select("#nn-explore-run-neuron").on("click",(function(){if(x=h.NEURON,0!==V.length){if(u("#nn-show-iteration-all").show(),u("#nn-show-next-neuron-all").show(),R=!1,y=null,null==P){var e=w.getLayerAndNodeArray();P=[].concat.apply([],e)}C<P.length?(S=P[C++],D.push(S),w.setInputValuesFromArray(V[z])):(D=[],z++,S=P[C=0]),z>=V.length&&(z=0),!m.inputs.includes(S.id)&&S.updateOutput(),I=0,H=[],se(),ie()}})),v.select("#nn-explore-stop").on("click",(function(){x=h.STOP,u("#nn-show-next-neuron-all").hide(),u("#nn-show-iteration-all").hide(),ce(),v.select("#nn-show-next-neuron").html(""),se(),ie()})),v.select("#nn-explore-upload").on("click",(function(){i.hide();var e=u("#nn-test-data-upload");ee(e,i,o,!1)})),v.select("#nn-explore-table-plus").on("click",(function(){F++,r++;var e=ne(o);te(!1,i,o,e,F),o.bootstrapTable("scrollTo","bottom")})),v.select("#nn-explore-table-minus").on("click",(function(){F>1?(F--,r--):F=1;var e=ne(o);te(!1,i,o,e,F),o.bootstrapTable("scrollTo","bottom")})),v.select("#nn-explore-table-download").on("click",(function(){var e=l.arrayToCsv(ne(o));l.download("test-data.csv",e)})),c=function(){B=!1,G=0,i.hide(),u("#nn-explore-upload-popup").trigger("blur"),r=0,V=ne(o)},p=function(){B=!1,0!==r&&(F-=r),r=0,i.hide(),u("#nn-explore-upload-popup").trigger("blur")},v.select("#nn-explore-modal-ok").on("click",c),v.select("#nn-explore-modal-close").on("click",p),v.select("#nn-explore-upload-popup").on("click",(function(){B||(B=!0,0==V.length?te(!1,i,o,null,F=3):te(!1,i,o,V,F),i.on("shown.bs.modal",(function(){o.bootstrapTable("resetView")})))})),v.select("#nn-show-next-neuron").html(""),i.hide(),u("#nn-show-next-neuron-all").hide(),u("#nn-show-iteration-all").hide(),window.addEventListener("resize",(function(){l.isMobile()||se(),ie()})),ce(),se(),ae(),[2]}}))}))},n.runNNEditorForTabLearn=function(n){return __awaiter(this,void 0,void 0,(function(){var t,a,r,i,o,c,p,h,f,b=this;return __generator(this,(function(_){switch(_.label){case 0:return[4,new Promise((function(n,t){e(["d3"],n,t)}))];case 1:return v=_.sent(),t=0,a=u("#nn-learn-popup-modal"),r=u("#nn-learn-table-user-input"),a.draggable({handle:".modal-header"}),null===q&&(q=new s.AppendingLineChart(v.select("#nn-learn-training-loss-linechart"),"#AAA",!0)),null===J&&(J=new s.AppendingLineChart(v.select("#nn-learn-training-bias-linechart"),"#AAA",!1)),null===$&&($=new s.AppendingLineChart(v.select("#nn-learn-training-weight-linechart"),"#AAA",!1)),n?(v.select("#learn-goto-sim").style("visibility","visible"),v.select("#learn-goto-sim").on("click",(function(){u.when(u("#tabProgram").trigger("click")).done((function(){u("#simButton").trigger("click")}))}))):v.select("#learn-goto-sim").style("visibility","hidden"),v.select("#nn-learn-focus").on("change",(function(){null==(N=d[this.value])&&(N=d.SHOW_ALL),N!==d.CLICK_NODE&&(y=null),se(),re(),u("#nn-focus").val(this.value).change()})),i=function(){K.forEach((function(e){var n=e.slice(0,m.inputs.length),t=e.slice(m.inputs.length);w.setInputValuesFromArray(n),w.forwardProp(),w.backProp(t)})),w.updateWeights(m.learningRate,m.regularizationRate)},v.select("#nn-learn-run").on("click",(function(){return __awaiter(b,void 0,void 0,(function(){var e,n;return __generator(this,(function(t){return T=g.RUN,u("#nn-learn-show-iteration-all").hide(),0===K.length||(Z=!Z,(e=u("#nn-learn-run span")).toggleClass("typcn-media-fast-forward-outline"),e.toggleClass("typcn-media-pause-outline"),n=v.select("#nn-learn-svg").select("g.core"),v.timer((function(){var t=w.getLoss(K);return Z&&Q<j?(n.attr("opacity","0.3"),u(".pace").show(),i(),f(t),!1):(w.forwardProp(),G=0,e.toggleClass("typcn-media-pause-outline"),e.toggleClass("typcn-media-fast-forward-outline"),Z=!1,se(),u(".pace").fadeOut(300),re(),!0)}),0,0)),[2]}))}))})),v.select("#nn-learn-run-epoch").on("click",(function(){if(T=g.EPOCH,u("#nn-learn-show-iteration-all").hide(),0!==K.length){var e=w.getLoss(K);i(),f(e),w.forwardProp(),G=0,se(),re()}})),v.select("#nn-learn-run-one-line").on("click",(function(){if(T=g.DEBUG,u("#nn-learn-show-iteration-all").show(),0!=K.length){G>=K.length&&(G=0,f(w.getLoss(K)));var e=K[G].slice(0,m.inputs.length),n=K[G].slice(m.inputs.length);w.setInputValuesFromArray(e),w.forwardProp(),w.backProp(n),w.updateWeights(m.learningRate,m.regularizationRate),G++,v.select("#nn-learn-show-iteration").html("".concat(G,"/").concat(K.length)),w.forwardProp(),se(),re()}})),v.select("#nn-learn-reset").on("click",(function(){T=g.STOP,R=!1,Z=!1,Q=0,G=0,w.setWeightsFromArray(Y),w.setBiasFromArray(X),w.forEachNode(!0,(function(e){return e.biasHistory=[]})),w.forEachLink((function(e){return e.weightHistory=[]})),q.reset(),J.reset(),$.reset(),v.select("#nn-loss-train").text((0).toFixed(3)),v.select("#nn-epochs").text(0),u("#nn-learn-show-iteration-all").hide(),se(),re()})),v.select("#nn-learn-upload").on("click",(function(){a.hide();var e=u("#nn-training-data-upload");ee(e,a,r,!0)})),v.select("#nn-learn-table-plus").on("click",(function(){M++,t++;var e=ne(r);te(!0,a,r,e,M),r.bootstrapTable("scrollTo","bottom")})),v.select("#nn-learn-table-minus").on("click",(function(){M>1?(M--,t--):M=1;var e=ne(r);te(!0,a,r,e,M),r.bootstrapTable("scrollTo","bottom")})),v.select("#nn-learn-table-download").on("click",(function(){var e=l.arrayToCsv(ne(r));l.download("training-data.csv",e)})),o=function(){W=!1,G=0,a.hide(),u("#nn-learn-upload-popup").trigger("blur"),t=0,K=ne(r)},c=function(){W=!1,0!==t&&(M-=t),t=0,a.hide(),u("#nn-learn-upload-popup").trigger("blur")},v.select("#nn-learn-modal-ok").on("click",o),v.select("#nn-learn-modal-close").on("click",c),v.select("#nn-learn-upload-popup").on("click",(function(){W||(W=!0,0==K.length?te(!0,a,r,null,M=3):te(!0,a,r,K,M),a.on("shown.bs.modal",(function(){r.bootstrapTable("resetView")})))})),p=function(){m.learningRate=Number(u("#nn-get-learning-rate").val().toString().replace(",","."))},h=function(){j=Number(u("#nn-get-epoch").val().toString())},f=function(e){q.addDataPoint(e),v.select("#nn-loss-train").text(e>1e5?e.toExponential(3):e.toFixed(3)),Q++,v.select("#nn-epochs").text(Q)},v.select("#nn-get-learning-rate").on("change",p),v.select("#nn-learning-rate-finished-button").on("click",p),v.select("#nn-get-epoch").on("change",h),v.select("#nn-epoch-finished-button").on("click",h),v.select("#nn-learn-show-activation").html(l.activationDisplayName[m.activationKey]),a.hide(),q.reset(),w.forEachNode(!0,(function(e){return e.biasHistory=[]})),w.forEachLink((function(e){return e.weightHistory=[]})),window.addEventListener("resize",(function(){l.isMobile()||se(),re(),q.drawLineChart(!0)})),u("#nn-get-learning-rate").val("".concat(m.learningRate)),u("#nn-get-regularization-rate").val("".concat(m.regularizationRate)),u("#nn-get-epoch").val(j),v.select("#nn-loss-train").text((0).toFixed(3)),v.select("#nn-epochs").text(0),Q=0,u("#nn-learn-show-iteration-all").hide(),u("#nn-learn").mouseup((function(e){var n=u("#nn-learn-training-weight-linechart"),t=u("#nn-learn-training-bias-linechart");n.is(e.target)||0!==n.has(e.target).length||n.hide(),t.is(e.target)||0!==t.has(e.target).length||t.hide()})),ce(),T=g.STOP,se(),re(),[2]}}))}))};var ee=function(e,n,t,a){e.trigger("click"),e.on("change",(function(r){r&&r.preventDefault();var i=e.prop("files")[0];if(e.val(""),i){var o=new FileReader;o.onload=function(){var e=o.result,r=l.csvToArray(e);if(a){var u=m.inputs.length+m.outputs.length;if(!s(u,r))return c.displayMessage("NN_INVALID_TEST_TRAIN_DATA","POPUP","","",""),void(r=i=null);c.displayMessage("NN_TEST_TRAIN_DATA_UPLOAD_SUCCESS","TOAST",r.length.toString(),"",""),K=r,M=r.length,te(!0,n,t,K,M)}else{u=m.inputs.length;if(!s(u,r))return c.displayMessage("NN_INVALID_TEST_TRAIN_DATA","POPUP","","",""),void(r=i=null);c.displayMessage("NN_TEST_TRAIN_DATA_UPLOAD_SUCCESS","TOAST",r.length.toString(),"",""),V=r,F=r.length,te(!1,n,t,V,F)}n.modal("show")},o.readAsText(i);var s=function(e,n){return!(n.length<=0)&&n.every((function(n,t,a){return n.length===e}))}}}))},ne=function(e){return e.bootstrapTable("getData").map((function(e){return Object.values(e).map((function(e){return e.toString().replace(",",".")}))}))},te=function(e,n,t,a,r){void 0===a&&(a=null),n.show();var i=e?__spreadArray(__spreadArray([],m.inputs,!0),m.outputs,!0):__spreadArray([],m.inputs,!0),o=[],l=[];function s(e){return"<input type='text' class='nn-table-input' value='".concat(e,"' data-neuron='").concat(this.field,"'>")}var c={"change input":function(e,n,a,r){var i=e.currentTarget.dataset.neuron;t.bootstrapTable("updateCell",{index:r,field:i,value:u(e.target).val(),reinit:!1})}};i.forEach((function(e){var n={field:e,title:"<span class='nn-user-input-table-header "+(m.inputs.includes(e)?"nn-input-background-color":"nn-output-background-color")+"'>".concat(e,"</span>"),align:"center",formatter:s,events:c};l.push(n)}));var p=function(e){var n={};i.forEach((function(t,a){n[t]="object"==typeof e?e[a]:e})),o.push(n)};if(null===a)for(var d=0;d<r;d++)p(0);else{for(d=0;d<a.length&&d<r;d++)p(a[d]);var h=r-a.length;for(d=0;d<h&&d>=0;d++)p(0)}t.bootstrapTable("destroy").bootstrapTable({height:235,columns:l,data:o})};function ae(){L=A=k=!1,ge(),ie()}function re(e){void 0===e&&(e=!0),u("#nn-learn-focus-label").text(o.get("NN_EXPLORE_FOCUS_OPTION")),u('#nn-learn-focus [value="CLICK_NODE"]').text(o.get("NN_EXPLORE_CLICK_NODE")),u('#nn-learn-focus [value="SHOW_ALL"]').text(o.get("NN_EXPLORE_SHOW_ALL")),u("#nn-get-learning-rate-label").text(o.get("NN_LEARNING_RATE")),u("#nn-learn-show-activation-label").text(o.get("NN_ACTIVATION")),u("#nn-get-epoch-label").text(o.get("NN_LEARN_EPOCHS_TO_TRAIN")),u("#nn-learn-show-iteration-label").text(o.get("NN_LEARN_ITERATION_NUMBER")),u("#nn-epoch-num").text(o.get("NN_LEARN_EPOCH_NUMBER")),u("#nn-training-loss").text(o.get("NN_LEARN_TRAINING_LOSS")),e&&oe(f.LEARN,"-learn",{adjustMainPartHeight:!0,moveSvgDown:!0,showAllWeightLinks:!0,weightsBiasesLinechartDisplay:!0,weightsBiasesEditable:!1,neuronNamesEditable:!1})}function ie(e){void 0===e&&(e=!0),u("#nn-activation-label").text(o.get("NN_ACTIVATION")),u("#nn-regularization-label").text(o.get("NN_REGULARIZATION")),u("#nn-focus-label").text(o.get("NN_FOCUS_OPTION")),u('#nn-focus [value="CLICK_WEIGHT_BIAS"]').text(o.get("NN_CLICK_WEIGHT_BIAS")),u('#nn-focus [value="CLICK_NODE"]').text(o.get("NN_CLICK_NODE")),u('#nn-focus [value="SHOW_ALL"]').text(o.get("NN_SHOW_ALL")),u("#nn-get-shape-label").text(o.get("NN_SHAPE")),u("#nn-show-precision-label").text(o.get("NN_SHOW_PRECISION")),u("#nn-show-math-label").text(o.get("NN_SHOW_MATH")),u("#nn-show-next-neuron-label").text(o.get("NN_EXPLORE_SHOW_NEXT_NEURON")),u("#nn-show-iteration-label").text(o.get("NN_LEARN_ITERATION_NUMBER")),u("#nn-random-values-generator-label").text(o.get("NN_RANDOM_WEIGHTS_BIASES")),u("#nn-random-values-from-span").text(o.get("NN_GENERATE_VALUES_FROM")),u("#nn-random-values-to-span").text(o.get("NN_GENERATE_VALUES_TO")),m&&m.hasOwnProperty("numHiddenLayers")?(u("#layers-label").text(o.get(1===m.numHiddenLayers?"NN_HIDDEN_LAYER":"NN_HIDDEN_LAYERS")),u("#num-layers").text(m.numHiddenLayers)):(u("#layers-label").text(o.get("NN_HIDDEN_LAYER")),u("#num-layers").text(0)),e&&oe(f.DEFINE,"",{adjustMainPartHeight:!1,moveSvgDown:!0,showAllWeightLinks:!0,weightsBiasesEditable:!0,neuronNamesEditable:!0,tabCallback:ue})}function oe(e,n,t){var a=w.getLayerAndNodeArray(),r=v.select("#nn".concat(n,"-svg"));r.select("g.core").remove(),v.select("#nn".concat(n,"-main-part")).selectAll("div.canvas").remove(),v.select("#nn".concat(n,"-main-part")).selectAll("div.nn-plus-minus-neurons").remove();var i=v.select("#nn".concat(n))[0][0],o=v.select("#nn".concat(n,"-top-controls"))[0][0],l=i.clientHeight-o.clientHeight+(t.adjustMainPartHeight?-50:-75),s=l<=0?30:l,c=v.select("#nn".concat(n,"-main-part"))[0][0];c.setAttribute("style","height:"+s+"px"),E=c.clientWidth,_=s,r.attr("width",E),r.attr("height",_);var b=a.length,I=a.map((function(e){return e.length})).reduce((function(e,n){return Math.max(e,n)}),0),O=_/(I=I<1?1:I),W=(O<100&&O>0?O:100)/2,B=(_-2*W)/I,M=10,F=(E-b*W)/(b-1),K=F>500?500:F,G=(E-K*(b-1))/2;function j(e){return e*B+W/2}function Y(e){var n=G+e*K-W/2;return n<0?0:n}var X=u("#nn-learn-training-weight-linechart"),Z=u("#nn-learn-training-bias-linechart");X.draggable({}),Z.draggable({});var q={},Q=r.append("g").classed("core",!0).attr("transform",t.moveSvgDown?"translate(3,20)":"translate(3,5)"),ee=a[0].length,ne=Y(0);ke(ne-W/2-M,0);for(var te=0;te<ee;te++){var re=a[0][te],ie=j(te)+10;q[re.id]={cx:ne,cy:ie},_e(re,p.INPUT,ne,ie,Q)}for(var ce=1;ce<b-1;ce++){var ue=a[ce].length,ge=Y(ce);ke(ge-W/2-M,ce);for(te=0;te<ue;te++){re=a[ce][te],ie=j(te)+10;q[re.id]={cx:ge,cy:ie},_e(re,p.HIDDEN,ge,ie,Q);for(var fe=0;fe<re.inputLinks.length;fe++){var ve=re.inputLinks[fe];t.showAllWeightLinks&&Ee(ve,q,a,Q,0===fe,fe,re.inputLinks.length)}}}var Ne=a[b-1],ye=Ne.length,me=Y(b-1);ke(me-W/2-M,b-1);for(fe=0;fe<ye;fe++){re=Ne[fe],ie=j(fe)+10;q[re.id]={cx:me,cy:ie},_e(re,p.OUTPUT,me,ie,Q);for(te=0;te<re.inputLinks.length;te++){ve=re.inputLinks[te];t.showAllWeightLinks&&Ee(ve,q,a,Q,0===fe,fe,re.inputLinks.length)}}var we,be=function(e){var n=e.node();return n.offsetHeight+n.offsetTop}(v.select("#nn".concat(n,"-network")));return v.select(".nn".concat(n,"-features")).style("height",be+"px"),void pe(n);function _e(a,r,i,o,l){a.id;var s=a.id,c=i-W/2,u=o-W/2,w=r===p.INPUT?"node_input":r===p.HIDDEN?"node_hidden":"node_output",b=l.append("g").attr({class:w,id:"".concat(s),transform:"translate(".concat(c,",").concat(u,")")}),_=b.append("rect").attr({x:0,y:0,width:W,height:W,"marker-start":"url(#markerArrow)"});void 0!==y&&null!=y&&y.id===a.id&&_.attr("style","outline: medium solid #fbdc00;");var I=v.select("#nn".concat(n,"-svg")).node();switch(b.on("dblclick",(function(){t.tabCallback&&t.tabCallback(a,v.mouse(I))})).on("click",(function(){v.event.shiftKey||t.neuronNamesEditable&&L&&r==p.INPUT||t.neuronNamesEditable&&A&&r==p.HIDDEN||t.neuronNamesEditable&&k&&r==p.OUTPUT?t.tabCallback&&t.tabCallback(a,v.mouse(I)):(y=y==a?null:a,oe(e,n,t))})),b.append("text").attr({class:"main-label",x:10,y:.66*W,"text-anchor":"start",cursor:"default"}).append("tspan").text(s),r!==p.INPUT&&function(e,a,r){var i=r.id,o=function(e,n){X.css("display","none");var t=n[0]+20,a=n[1]+10;t>E-360&&(t=E-370),Z.css({left:"".concat(t,"px"),top:"".concat(a,"px"),display:"block"}),J.drawLineChart(),J.reset(),e.biasHistory.forEach((function(e,n){return setTimeout((function(){return J.addDataPoint(e)}),n)}))};if(N===d.SHOW_ALL||N===d.CLICK_NODE&&y===r){(l=Ae(a,i+"".concat(n),-M-2,W+2*M,r.bias.get(),r.bias.getWithPrecision(m.precision,m.weightSuppressMultOp))).attr("class","nn-bias-click"),N===d.CLICK_NODE&&y!==r||l.on("click",(function(){v.event.stopPropagation(),t.weightsBiasesEditable&&le(r,v.mouse(e.node())),t.weightsBiasesLinechartDisplay&&r.biasHistory.length>0&&o(r,v.mouse(e.node()))}))}else{var l;(l=a.append("rect").attr({id:"bias-".concat(i),x:-M-2,y:W-M+3,width:M,height:M})).attr("class","nn-bias-click"),N===d.CLICK_NODE&&y!==r||l.on("click",(function(){v.event.stopPropagation(),t.weightsBiasesEditable&&le(r,v.mouse(e.node())),t.weightsBiasesLinechartDisplay&&r.biasHistory.length>0&&o(r,v.mouse(e.node()))}))}}(l,b,a),x){case h.RUN:Le(l,b,a,r),v.select("#nn-show-iteration").html("".concat(z,"/").concat(V.length));break;case h.LAYER:H.includes(a)&&(Le(l,b,a,r),v.select("#nn-show-iteration").html("".concat(z+1,"/").concat(V.length)));break;case h.NEURON:D.includes(a)&&Le(l,b,a,r),v.select("#nn-show-next-neuron").html(S.id==P[P.length-1].id?"-":P[C].id),v.select("#nn-show-iteration").html("".concat(z+1,"/").concat(V.length));break;default:v.select("#nn-show-next-neuron").html(""),v.select("#nn-show-iteration").html("")}e==f.LEARN&&(R&&r==p.INPUT&&Le(l,b,a,p.INPUT),T!==g.STOP&&Le(l,b,a,r)),v.select("#nn".concat(n,"-network")).insert("div",":first-child").attr({id:"canvas-".concat(s),class:"canvas"}).style({position:"absolute",left:"".concat(c+3,"px"),top:"".concat(u+3,"px")})}function Ee(e,a,r,i,o,l,s){var c=i.insert("path",":first-child"),u=a[e.source.id],p=a[e.dest.id],h={source:{y:u.cx+W/2+2,x:u.cy},target:{y:p.cx-W/2,x:p.cy+(l-(s-1)/2)/s*(s-1)}},g=v.svg.diagonal().projection((function(e){return[e.y,e.x]}));c.attr({"marker-start":"url(#markerArrow)",class:"link",id:e.source.id+"-"+e.dest.id,d:g(h,0)});if(N===d.SHOW_ALL||N===d.CLICK_NODE&&(e.source===y||e.dest===y)){var f=c.node();we=!we;var w=N===d.SHOW_ALL?we?.6:.4:e.source===y?.6:.4,b=f.getPointAtLength(f.getTotalLength()*w);Ae(i,e.source.id+"-"+e.dest.id+"".concat(n),b.x,b.y-10,e.weight.get(),e.weight.getWithPrecision(m.precision,m.weightSuppressMultOp))}var _=N===d.CLICK_NODE&&(e.source===y||e.dest===y),L=N===d.SHOW_ALL||N===d.CLICK_WEIGHT_BIAS;if(_||L){var A=N!==d.CLICK_NODE?"nn-weight-click":"nn-weight-show-click";i.append("path").attr("d",g(h,0)).attr("class",A).on("click",(function(){v.event.stopPropagation(),t.weightsBiasesEditable&&le(e,v.mouse(this)),t.weightsBiasesLinechartDisplay&&e.weightHistory.length>0&&function(e,n){Z.css("display","none");var t=n[0]+20,a=n[1]+10;t>E-360&&(t=E-370),X.css({left:"".concat(t,"px"),top:"".concat(a,"px"),display:"block"}),$.drawLineChart(),$.reset(),e.weightHistory.forEach((function(e,n){return setTimeout((function(){return $.addDataPoint(e)}),n)}))}(e,v.mouse(this))}))}return c}function Le(e,t,a,r){var i=0===a.output?a.output.toString():(Math.round(100*a.output)/100).toFixed(Number(m.precision)).toString();Ae(t,"out-".concat(a.id,"-").concat(n),4.5*M,W-4.5*M,a.output,i,!0)}function Ae(e,n,t,a,r,i,o){void 0===o&&(o=!1),e.append("rect").attr("id","rect-val-"+n);var l=e.append("text").attr({class:"nn-showval",id:"val-"+n,x:t,y:a}).text(i);return he(l,r,o),l}function ke(n,t){if(e==f.DEFINE){var a=v.select("#nn-network").append("div").classed("nn-plus-minus-neurons",!0).style("left","".concat(n,"px")),r=0==t,i=t==b-1,o=t-1,l=a.append("div"),s=null;s=r?function(){if(!(m.inputs.length>=9)){var e=de();m.inputs.push(e),se(),ae()}}:i?function(){if(!(m.outputs.length>=9)){var e=de();m.outputs.push(e),se(),ae()}}:function(){if(!(m.networkShape[o]>=9)){var e=de(!0,o+1);m.hiddenNeurons[o].push(e),m.networkShape[o]++,se(),ae()}},l.append("button").attr("class","nn-btn nn-plus-minus-neuron-button").on("click",s).append("span").attr("class","typcn typcn-plus");var c=null;c=r?function(){m.inputs.length<=1||(m.inputs.pop(),m.inputs.length<U.length&&U.splice(-1,m.inputs.length),se(),ae())}:i?function(){m.outputs.length<=1||(m.outputs.pop(),se(),ae())}:function(){m.networkShape[o]<=1||(m.networkShape[o]--,se(),ae())},l.append("button").attr("class","nn-btn nn-plus-minus-neuron-button").on("click",c).append("span").attr("class","typcn typcn-minus");var p=__spreadArray(__spreadArray([m.inputs.length],m.networkShape,!0),[m.outputs.length],!1);if(u("#nn-get-shape").val("".concat(p.toString())),r)(d=l.append("button")).attr("class","nn-btn nn-plus-minus-neuron-button").on("click",(function(){(L=!L)?(v.event.target.parentElement.classList.add("active-input"),v.event.target.classList.add("active-input")):(v.event.target.parentElement.classList.remove("active-input"),v.event.target.classList.remove("active-input"))})).append("span").attr("class","typcn typcn-edit"),L?d.classed("active-input",!0):d.classed("active-input",!1);else if(i){(d=l.append("button")).attr("class","nn-btn nn-plus-minus-neuron-button").on("click",(function(){(k=!k)?(v.event.target.parentElement.classList.add("active-output"),v.event.target.classList.add("active-output")):(v.event.target.parentElement.classList.remove("active-output"),v.event.target.classList.remove("active-output"))})).append("span").attr("class","typcn typcn-edit"),k?d.classed("active-output",!0):d.classed("active-output",!1)}else{var d;(d=l.append("button")).attr("class","nn-btn nn-plus-minus-neuron-button").on("click",(function(){(A=!A)?(v.event.target.parentElement.classList.add("active-hidden"),v.event.target.classList.add("active-hidden")):(v.event.target.parentElement.classList.remove("active-hidden"),v.event.target.classList.remove("active-hidden"))})).append("span").attr("class","typcn typcn-edit"),A?d.classed("active-hidden",!0):d.classed("active-hidden",!1)}}}}function le(e,n){var r=v.select("#nn-editCard"),i=v.select("#nn-type-plus"),l=v.select("#nn-type-minus"),s=v.select("#nn-type-finished"),c=v.select("#nn-type-cancel"),u=r.select("input");u.property("value",fe(e));var p=fe(e);se(),u.on("keydown",(function(){var n=v.event;if("h"===n.key||"i"===n.key)n.target.value=t.updValue(n.target.value,1),n.preventDefault&&n.preventDefault(),ve(e,n.target.value);else if("r"===n.key||"d"===n.key)n.target.value=t.updValue(n.target.value,-1),n.preventDefault&&n.preventDefault(),ve(e,n.target.value);else{if(13===n.which)return se(),n.preventDefault&&n.preventDefault(),!1;27===n.which&&(se(),n.preventDefault&&n.preventDefault(),ve(e,p))}u.node().focus()})).on("input",(function(){var n=v.event;ve(e,n.target.value)})),i.on("click",(function(){var n=u.property("value"),a=t.updValue(n,1);u.property("value",a),ve(e,a)})),l.on("click",(function(){var n=u.property("value"),a=t.updValue(n,-1);u.property("value",a),ve(e,a)})),s.on("click",(function(){return se(),!1})),c.on("click",(function(){se(),ve(e,p)}));var d=n[0]+20,h=n[1];d>E-360&&(d=E-370),r.style({left:"".concat(d,"px"),top:"".concat(h,"px"),display:"block"});var g=e instanceof a.Link?"NN_WEIGHT":"NN_BIAS";r.select(".nn-type").text(o.get(g)),u.node().select()}function se(){null!=v&&(v.select("#nn-editCard").style("display","none"),v.select("#nn-nameCard").style("display","none"),v.select("#nn-learn-training-bias-linechart").style("display","none"),v.select("#nn-learn-training-weight-linechart").style("display","none"),u("#nn-explore-popup-modal").modal("hide"),u("#nn-explore-upload-popup").trigger("blur"),u("#nn-learn-popup-modal").modal("hide"),u("#nn-learn-upload-popup").trigger("blur"),B=W=!1)}function ce(){var e;x=null,I=0,S=(e=[null,0])[0],C=e[1],z=0,P=null,D=[],H=[],R=!1,W=!1}function ue(e,n){var t=v.select("#nn-nameCard"),a=v.select("#nn-name-finished"),r=v.select("#nn-name-cancel"),i=t.select("input");i.property("value",e.id);var s=v.select("#nn-name-message");function c(){var n,t,a=i.property("value"),r=(n=e.id,t=a,new RegExp("^[A-Za-z][A-Za-z0-9_]*$").test(t)?n===t?null:w.network.find((function(e){return e.find((function(e){return e.id===t}))}))?"NN_USED_NEURONNAME":null:"NN_INVALID_NEURONNAME");null===r?(!function(e,n){for(var t=e.id,a=0;a<m.inputs.length;a++)m.inputs[a]===e.id&&(m.inputs[a]=n);for(a=0;a<m.hiddenNeurons.length;a++)for(var r=0;r<m.hiddenNeurons[a].length;r++)m.hiddenNeurons[a][r]===e.id&&(m.hiddenNeurons[a][r]=n);for(a=0;a<m.outputs.length;a++)m.outputs[a]===e.id&&(m.outputs[a]=n);e.id=n,l.renameNeuron(t,n)}(e,a),se(),ie()):(s.style("color","red"),s.text(o.get(r)))}s.style("color","#333"),s.text(o.get("NN_CHANGE_NEURONNAME")),se(),i.on("keydown",(function(){var e=v.event;13===e.which?c():27===e.which&&se()})),a.on("click",(function(){var e=v.event;e.preventDefault&&e.preventDefault(),c()})),r.on("click",(function(){var e=v.event;e.preventDefault&&e.preventDefault(),se()}));var u=n[0]+20,p=n[1];u>E-320&&(u=E-330),t.style({left:"".concat(u,"px"),top:"".concat(p,"px"),display:"block"});t.select(".nn-type").text(o.get("POPUP_NAME")),i.node().select()}function pe(e){var n,t="#nn".concat(e,"-svg");!function(e){var n=function(){var e=0;function n(n){var t=Math.abs(n.weight.get());t>e&&(e=t)}return w.forEachLink(n),v.scale.linear().domain([0,e]).range([2,m.weightArcMaxSize]).clamp(!0)}(),t=function(){var e=0;function n(n){var t=Math.abs(n.weight.get());t>e&&(e=t)}return w.forEachLink(n),v.scale.linear().domain([-.01,0,.01]).range(["#f59322","#222222","#0877bd"]).clamp(!0)}();w.forEachLink((function(a){var r=a.source.id+"-"+a.dest.id;e.select("#".concat(r)).style({"stroke-dashoffset":0,"stroke-width":n(Math.abs(a.weight.get())),stroke:t(a.weight.get())});var i=e.select("#val-".concat(r));i.empty()||(i.text(a.weight.getWithPrecision(m.precision,m.weightSuppressMultOp)),he(i,a.weight.get()))}))}(v.select(t).select("g.core")),n=v.scale.linear().domain([-1,0,1]).range(["#f59322","#222222","#0877bd"]).clamp(!0),w.forEachNode(!0,(function(a){v.select("#bias-".concat(a.id)).style("fill",n(a.bias.get()));var r=v.select(t).select("#val-".concat(a.id).concat(e));r.empty()||(r.text(a.bias.getWithPrecision(m.precision,m.weightSuppressMultOp)),he(r,a.bias.get()))})),w.setInputValuesFromArray(U),null!=y?v.select("#nn-show-math").html(y.id+" = "+(m.inputs.includes(y.id)?y.output:y.genMath(m.activationKey))):x==h.NEURON?v.select("#nn-show-math").html(S.id+" = "+(m.inputs.includes(S.id)?S.output:S.genMath(m.activationKey))):v.select("#nn-show-math").html("")}function de(e,n){for(var t=1,a=function(){var a=e?"h"+(null!=n?n:t++)+"n"+t++:"n"+t++;if(e){if(!m.hiddenNeurons.find((function(e){return e.find((function(e){return e===a}))})))return{value:a}}else if(m.inputs.indexOf(a)<=-1&&m.outputs.indexOf(a)<=-1)return{value:a}};;){var r=a();if("object"==typeof r)return r.value}}function he(e,n,t){var a=v.select("#rect-"+e.attr("id")),r=e.node().getBBox();function i(e){return e<0?"#f5932260":0==e?"#e8eaeb60":"#0877bd60"}a.attr("x",r.x-4),a.attr("y",r.y),a.attr("width",r.width+8),a.attr("height",r.height),t?(a.style("fill","white"),a.attr({ry:"10%",stroke:i(n),"stroke-width":4,"stroke-opacity":1})):a.style("fill",i(n))}function ge(){w=new a.Network(m)}function fe(e){return e instanceof a.Link?e.weight.getWithPrecision("*",m.weightSuppressMultOp):e instanceof a.Node?e.bias.getWithPrecision("*",m.weightSuppressMultOp):""}function ve(e,n){if(null!=n){if(e instanceof a.Link)e.weight.set(n);else{if(!(e instanceof a.Node))throw"invalid nodeOrLink";e.bias.set(n)}m.weights=w.getWeightArray(),m.biases=w.getBiasArray(),pe("")}}n.resetUiOnTerminate=function(){se(),y=null},n.reconstructNNIncludingUI=ae,n.drawNetworkUIForTabLearn=re,n.drawNetworkUIForTabDefine=ie,n.resetSelections=ce,n.resetUserInputs=function(){V=K=[]},n.programWasReplaced=function(){b=!0},n.saveNN2Blockly=function(e){if(!b){var n=e||w,t=l.getTheStartBlock();try{m.weights=n.getWeightArray(),m.biases=n.getBiasArray(),m.inputs=n.getInputNames(),m.hiddenNeurons=n.getHiddenNeuronNames(),m.outputs=n.getOutputNames(),t.data=JSON.stringify(m)}catch(e){i.error("failed to create a JSON string from nn state")}}},n.getNetwork=function(){return w}}));
//# sourceMappingURL=neuralnetwork.ui.js.map
//# sourceMappingURL=neuralnetwork.ui.js.map
