define(["require","exports","./neuralnetwork.helper","util.roberta"],(function(t,r,e,n){Object.defineProperty(r,"__esModule",{value:!0}),r.Network=r.Link=r.Node=r.NNumber=void 0;var i=function(){function t(){this.operator="*",this.asNumber=0,this.normalizedUserInput="0",this.separator=".",this.isFraction=!1}return t.prototype.setAsNumber=function(t){this.operator="",this.asNumber=t,this.normalizedUserInput=String(t),this.separator=".",this.isFraction=!1},t.prototype.set=function(r){if(0==(r=r.trim()).length)return this.operator="",this.asNumber=0,this.normalizedUserInput="0",this.separator=".",void(this.isFraction=!1);if(this.operator=r.substr(0,1),"*"===this.operator||":"===this.operator||"/"===this.operator?(r=r.substr(1),"*"===this.operator&&(this.operator="")):this.operator="",this.asNumber=0,r.indexOf("/")>=0){this.isFraction=!0,this.operator="",this.separator=".",(r=(r=r.replace(t.commaGlobal,"")).replace(t.pointGlobal,"")).indexOf("-")>=0&&(r="-"+r.replace(t.minusGlobal,""));var e=r.split("/");this.separator=".",""!==this.operator||2!==e.length?this.asNumber=0:this.asNumber=+e[0]/+e[1]}else this.isFraction=!1,this.separator=".",r.indexOf(".")>=0?r=r.replace(t.commaGlobal,""):r.indexOf(",")>=0&&(this.separator=",",r=(r=r.replace(t.pointGlobal,"")).replace(t.commaGlobal,".")),this.asNumber=+r;if(isNaN(this.asNumber))return this.asNumber=0,void(this.normalizedUserInput=r);this.normalizedUserInput=r,""!==this.operator&&(this.asNumber=1/this.asNumber)},t.prototype.get=function(){return this.asNumber},t.prototype.getWoOp=function(){return","===this.separator?this.normalizedUserInput.replace(t.pointGlobal,","):this.normalizedUserInput},t.prototype.hasFraction=function(){return this.isFraction},t.prototype.getOp=function(){return this.operator},t.prototype.getWithPrecision=function(r,e){var i=e&&"*"===this.operator?"":this.operator,o="*"===r||this.isFraction?String(this.normalizedUserInput):n.toFixedPrecision(this.normalizedUserInput,+r);return","===this.separator&&(o=o.replace(t.pointGlobal,",")),i+o},t.commaGlobal=/,/g,t.pointGlobal=/\./g,t.minusGlobal=/-/g,t}();r.NNumber=i;var o=function(){function t(t,r,e){this.inputLinks=[],this.bias=new i,this.biasHistory=[],this.outputs=[],this.output=0,this.outputDer=0,this.inputDer=0,this.accInputDer=0,this.numAccumulatedDers=0,this.id=t,this.activation=r,null!=e&&this.bias.setAsNumber(e*Math.random())}return t.prototype.updateOutput=function(){this.totalInput=this.bias.get();for(var t=0;t<this.inputLinks.length;t++){var r=this.inputLinks[t];this.totalInput+=r.weight.get()*r.source.output}return this.output=this.activation.output(this.totalInput),this.output},t.prototype.genMath=function(t){var r=0===this.bias.get(),e=0===this.inputLinks.length,n="linear"===t,i=n?"":t+"( ";if(e)return i+=this.bias.get(),n||(i+=" )"),i;r||(i+=this.bias.get());var o=r;return this.inputLinks.forEach((function(t){var r=t.weight;if(0!==r.get()){var e=r.getOp(),n=r.get()>=0,s=t.source.id;":"===e||"/"===e?n?(o?o=!1:i+=" + ",i+=s+"/"+r.getWoOp()):(o&&(i+="0",o=!1),i+=" - "+s+"/"+-r.getWoOp()):n?(o?o=!1:i+=" + ",i+=r.getWoOp()+"*"+s):(o&&(i+="0",o=!1),r.hasFraction()?i+=" - "+r.getWoOp().substr(1)+"*"+s:i+=" - "+-r.getWoOp()+"*"+s)}})),o&&(i+="0"),n||(i+=" )"),i},t}();r.Node=o;var s=function(t,r,e,n){this.weight=new i,this.weightHistory=[],this.isDead=!1,this.errorDer=0,this.accErrorDer=0,this.numAccumulatedDers=0,this.id=t.id+"-"+r.id,this.source=t,this.dest=r,this.regularization=e,null!=n&&this.weight.setAsNumber(n*Math.random())};r.Link=s;var u=function(){function t(t){for(var r=[t.inputs.length].concat(t.networkShape).concat([t.outputs.length]),e=r.length,n=[],i=0;i<e;i++){var u=i===e-1,a=0===i,h=[];n.push(h);for(var p=r[i],l=0;l<p;l++){var g=a?t.inputs[l]:u?t.outputs[l]:t.hiddenNeurons[i-1][l],f=new o(g,t.activation);if(h.push(f),i>=1)for(var c=0;c<n[i-1].length;c++){var v=n[i-1][c],d=new s(v,f,t.regularization);v.outputs.push(d),f.inputLinks.push(d)}}}this.network=n,this.setWeightsFromArray(t.weights),this.setBiasFromArray(t.biases)}return t.prototype.forwardProp=function(){for(var t=1;t<this.network.length;t++)for(var r=this.network[t],e=0;e<r.length;e++){r[e].updateOutput()}},t.prototype.backProp=function(t,r){void 0===r&&(r=e.Errors.SQUARE);for(var n=this.network[this.network.length-1],i=0;i<n.length;i++){var o=n[i];o.outputDer=r.der(o.output,t[i])}for(var s=this.network.length-1;s>=1;s--){var u=this.network[s];for(i=0;i<u.length;i++){(a=u[i]).inputDer=a.outputDer*a.activation.der(a.totalInput),a.accInputDer+=a.inputDer,a.numAccumulatedDers++}for(i=0;i<u.length;i++)for(var a=u[i],h=0;h<a.inputLinks.length;h++){var p=a.inputLinks[h];p.isDead||(p.errorDer=a.inputDer*p.source.output,p.accErrorDer+=p.errorDer,p.numAccumulatedDers++)}if(1!==s){var l=this.network[s-1];for(i=0;i<l.length;i++){(a=l[i]).outputDer=0;for(h=0;h<a.outputs.length;h++){var g=a.outputs[h];a.outputDer+=g.weight.get()*g.dest.inputDer}}}}},t.prototype.updateWeights=function(t,r){for(var n=1;n<this.network.length;n++)for(var i=this.network[n],o=0;o<i.length;o++){var s=i[o];s.numAccumulatedDers>0&&(s.biasHistory.push(s.bias.get()),s.bias.setAsNumber(s.bias.get()-t*s.accInputDer/s.numAccumulatedDers),s.accInputDer=0,s.numAccumulatedDers=0);for(var u=0;u<s.inputLinks.length;u++){var a=s.inputLinks[u];if(!a.isDead){var h=a.weight.get(),p=a.regularization?a.regularization.der(h):0;if(a.numAccumulatedDers>0){a.weightHistory.push(h);var l=(h-=t/a.numAccumulatedDers*a.accErrorDer)-t*r*p;a.regularization===e.RegularizationFunction.L1&&h*l<0?(a.weight.setAsNumber(0),a.isDead=!0):a.weight.setAsNumber(l),a.accErrorDer=0,a.numAccumulatedDers=0}}}}},t.prototype.getLoss=function(t){var r=this,n=0,i=this.network[this.network.length-1];return t.forEach((function(t){var o=t.slice(0,r.getInputNames().length),s=t.slice(r.getInputNames().length);r.setInputValuesFromArray(o),r.forwardProp(),i.forEach((function(t,r){n+=e.Errors.SQUARE.error(t.output,s[r])}))})),n},t.prototype.forEachNode=function(t,r){for(var e=t?1:0;e<this.network.length;e++)for(var n=this.network[e],i=0;i<n.length;i++){r(n[i])}},t.prototype.forEachLink=function(t){for(var r=0;r<this.network.length;r++)for(var e=this.network[r],n=0;n<e.length;n++)for(var i=e[n],o=0;o<i.inputLinks.length;o++){t(i.inputLinks[o])}},t.prototype.getLayerAndNodeArray=function(){return this.network},t.prototype.getWeightArray=function(){var t=[];if(null!=this.network&&this.network.length>0)for(var r=0,e=this.network;r<e.length;r++){for(var n=[],i=0,o=e[r];i<o.length;i++){for(var s=[],u=0,a=o[i].outputs;u<a.length;u++){var h=a[u];s.push(h.weight.getOp()+h.weight.getWoOp())}n.push(s)}t.push(n)}return t},t.prototype.getBiasArray=function(){var t=[];if(null!=this.network&&this.network.length>0)for(var r=0,e=this.network;r<e.length;r++){for(var n=[],i=0,o=e[r];i<o.length;i++){var s=o[i];n.push(s.bias.getOp()+s.bias.getWoOp())}t.push(n)}return t},t.prototype.getInputNames=function(){var t=[];if(null!=this.network&&this.network.length>0)for(var r=0,e=this.network[0];r<e.length;r++){var n=e[r];t.push(n.id)}return t},t.prototype.getHiddenNeuronNames=function(){var t=[];if(null!=this.network&&this.network.length>2)for(var r=1;r<this.network.length-1;r++){for(var e=[],n=0,i=this.network[r];n<i.length;n++){var o=i[n];e.push(o.id)}t.push(e)}return t},t.prototype.getHiddenNeuronNamesFlattened=function(){var t=[];if(null!=this.network&&this.network.length>2)for(var r=1;r<this.network.length-1;r++)for(var e=0,n=this.network[r];e<n.length;e++){var i=n[e];t.push(i.id)}return t},t.prototype.getOutputNames=function(){var t=[];if(null!=this.network&&this.network.length>0)for(var r=0,e=this.network[this.network.length-1];r<e.length;r++){var n=e[r];t.push(n.id)}return t},t.prototype.setInputNeuronVal=function(t,r){this.getNeuronById(t).output=r},t.prototype.getNeuronVal=function(t){var r=this.getNeuronById(t);return null!=r?r.output:0},t.prototype.getWeight=function(t,r){var e=this.getNeuronById(t);if(null!=e)for(var n=0;n<e.outputs.length;n++){var i=e.outputs[n];if(i.dest.id===r)return i.weight.get()}return 0},t.prototype.getBias=function(t){var r=this.getNeuronById(t);return null!=r?r.bias.get():0},t.prototype.changeWeight=function(t,r,e){var n=this.getNeuronById(t);if(null!=n)for(var i=0;i<n.outputs.length;i++){var o=n.outputs[i];if(o.dest.id===r)return void o.weight.setAsNumber(e)}},t.prototype.changeBias=function(t,r){var e=this.getNeuronById(t);null==e||e.bias.setAsNumber(r)},t.prototype.getNeuronById=function(t){if(null!=this.network&&this.network.length>0)for(var r=0;r<this.network.length;r+=1){var e=this.network[r];if(null==e)break;for(var n=0;n<e.length;n+=1){var i=e[n];if(i.id===t)return i}}return null},t.prototype.setWeightsFromArray=function(t){if(null!=this.network&&this.network.length>0&&null!=t)for(var r=0;r<t.length&&r<this.network.length;r+=1){var e=this.network[r],n=t[r];if(null==e||null==n)break;for(var i=0;i<n.length&&i<e.length;i+=1){var o=e[i],s=n[i];if(null==o||null==s)break;for(var u=0;u<s.length&&u<o.outputs.length;u+=1){var a=o.outputs[u],h=s[u];if(null==a||null==h)break;a.weight.set(h)}}}},t.prototype.setBiasFromArray=function(t){if(null!=this.network&&this.network.length>0&&null!=t)for(var r=0;r<t.length&&r<this.network.length;r+=1){var e=this.network[r],n=t[r];if(null==e||null==n)break;for(var i=0;i<n.length&&i<e.length;i+=1){var o=e[i],s=n[i];if(null==o||null==s)break;o.bias.set(s)}}},t.prototype.setInputValuesFromArray=function(t){if(null!=this.network&&this.network.length>0&&t.length>0)for(var r=this.network[0],e=0;e<t.length&&e<r.length;e+=1)r[e].output=t[e]},t}();r.Network=u}));
//# sourceMappingURL=neuralnetwork.nn.js.map
//# sourceMappingURL=neuralnetwork.nn.js.map
