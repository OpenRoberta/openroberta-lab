var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(o){for(var t,e=1,n=arguments.length;e<n;e++)for(var r in t=arguments[e])Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=t[r]);return o},__assign.apply(this,arguments)},__rest=this&&this.__rest||function(o,t){var e={};for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&t.indexOf(n)<0&&(e[n]=o[n]);if(null!=o&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(o);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(o,n[r])&&(e[n[r]]=o[n[r]])}return e},__spreadArray=this&&this.__spreadArray||function(o,t,e){if(e||2===arguments.length)for(var n,r=0,i=t.length;r<i;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return o.concat(n||Array.prototype.slice.call(t))};define(["require","exports","./wires","./const.robots","./robotBlock","./port","jquery"],(function(o,t,e,n,r,i,s){Object.defineProperty(t,"__esModule",{value:!0}),t.CircuitVisualization=void 0;var c=2.5;"remove"in Element.prototype||(Element.prototype.remove=function(){this.parentNode&&this.parentNode.removeChild(this)});var a=function(){function o(o,t){var n=this;if(this.scale=1,this.observers=[],this.clear=function(){for(;n.workspace.getAllBlocks().length;)n.workspace.getAllBlocks()[0].dispose()},this.onChangeListener=function(o){var t;if(o.blockId)t=o.blockId;else{if(!o.newValue)return;t=o.newValue}var e=n.workspace.getBlockById(t);switch(o.type){case window.Blockly.Events.CREATE:for(n.createBlockPorts(e),n.initEventListeners(e),n.renderBlockConnections(e);e&&e.getChildren().length>0;)e=e.getChildren()[0],n.createBlockPorts(e),n.initEventListeners(e),n.renderBlockConnections(e);break;case window.Blockly.Events.CHANGE:n.updateBlockPorts(e),n.updateConnections(e),n.renderBlockConnections(e);break;case window.Blockly.Events.DELETE:n.deleteConnections(o.ids),e&&e.ports&&e.ports.forEach((function(o){return o.element.remove()}))}},this.updateBlockPorts=function(o){o.ports.forEach((function(t){var e=t.position;t.moveTo(__assign(__assign({},e),{x:n.calculatePortPosition(o,t.connectedTo)}))})),n.connections=n.connections.map((function(t){var e=t.position,r=t.connectedTo,i=__rest(t,["position","connectedTo"]);return i.blockId!==o.id?__assign({position:e,connectedTo:r},i):__assign({position:__assign(__assign({},e),{x:n.calculatePortPosition(o,r)}),connectedTo:r},i)}))},this.createBlockPorts=function(o){o.ports=[],o.inputList.length>0?o.inputList.forEach((function(t,e){0===e?n.robot.getPortByName(o.confBlock)&&n.appendPortAndConnection(o,t.fieldRow[0].textElement_,name,o.confBlock):t.fieldRow.forEach((function(t){var e=t.fieldGroup_,r=t.name,i=t.value_;if(r=r||i){var s=n.robot.getPortByName(o.confBlock+" "+i)?o.confBlock+" "+i:n.robot.getPortByName(o.getFieldValue(r))?o.getFieldValue(r):n.robot.getPortByName(r)?r:null;s&&n.appendPortAndConnection(o,e,r,s)}}))})):n.robot.getPortByName(o.confBlock)&&n.appendPortAndConnection(o,o.inputList[0],o.confBlock,o.confBlock)},this.appendPortAndConnection=function(o,t,r,s){var c=t.transform.baseVal.getItem(0).matrix,a={x:n.calculatePortPosition(o,s),y:c.f+6},l=new i.Port(o.getSvgRoot(),r,a,s);o.ports.push(l);var u=e.default.getColor(o,r),p=window.Blockly.createSvgElement("path",{fill:"none",stroke:u,"stroke-width":1.8,"stroke-linecap":"round","stroke-linejoin":"round"},n.wireGroup);n.connections.push({blockId:o.id,connectedTo:s,blockPort:l,name:r,position:a,wireSvg:p})},this.updateConnections=function(o){var t=n.connections.filter((function(t){return t.blockId===o.id}));t=t.map((function(t){var e=t.name,r=__rest(t,["name"]);return __assign(__assign({name:e},r),{connectedTo:n.robot.getPortByName(o.confBlock+" "+o.getFieldValue(e))?o.confBlock+" "+o.getFieldValue(e):o.getFieldValue(e)||r.connectedTo})})),n.connections=n.connections.filter((function(t){return t.blockId!==o.id})),n.connections=__spreadArray(__spreadArray([],n.connections,!0),t,!0)},this.deleteConnections=function(o){n.connections=n.connections.filter((function(t){return!o.includes(t.blockId)||(t.wireSvg.remove(),!1)}))},this.dom=t,this.workspace=o,!window.Blockly)throw new Error("Blockly required");this.components={},this.connections=[],this.currentRobot=this.workspace.device+"_"+this.workspace.subDevice,this.injectRobotBoard(),this.workspace.addChangeListener(this.onChangeListener),this.wireGroup=window.Blockly.createSvgElement("g",{id:"wireGroup"},this.workspace.getCanvas())}return o.domToWorkspace=function(t,e){var n=new o(e,t);return{dispose:n.dispose.bind(n),refresh:n.refresh.bind(n),resetRobot:n.reset.bind(n),getXml:n.getXml.bind(n)}},o.isRobotVisualized=function(o,t){return n.ROBOTS[o+"_"+t]||void 0!==n.ROBOTS[o]},o.prototype.reset=function(){var o=this.workspace.device+"_"+this.workspace.subDevice;o!==this.currentRobot&&(this.currentRobot=o,this.dom=this.getXml(),this.clear(),this.injectRobotBoard())},o.prototype.refresh=function(){var o=this;this.workspace.getAllBlocks().forEach((function(t){o.updateBlockPorts(t),o.renderConnections(o.connections)}))},o.prototype.dispose=function(){this.workspace.removeChangeListener(this.onChangeListener),this.wireGroup.remove(),this.observers.forEach((function(o){return o.disconnect()})),this.observers=[]},o.prototype.getXml=function(){return window.Blockly.Xml.workspaceToDom(this.workspace)},o.prototype.injectRobotBoard=function(){if(window.Blockly.Blocks.robConf_robot=(0,r.createRobotBlock)(this.currentRobot),!this.dom.querySelector("block[type=robConf_robot]")){var o=(new DOMParser).parseFromString('<instance x="250" y="250"><block type="robConf_robot" id="robot"></block></instance>',"text/xml").firstChild;this.dom.appendChild(o)}window.Blockly.Xml.domToWorkspace(this.dom,this.workspace),this.robot=this.workspace.getBlockById("robot")},o.prototype.initEventListeners=function(o){var t=this,e=new MutationObserver((function(){return t.renderBlockConnections(o)}));e.observe(o.svgGroup_,{childList:!1,subtree:!1,attributes:!0,attributeFilter:["transform"]}),this.observers.push(e)},o.prototype.renderBlockConnections=function(o){if("robot"===o.id)return this.renderConnections(this.connections);var t=[];for(t.push(o.id);o&&o.getChildren().length>0;)o=o.getChildren()[0],t.push(o.id);return this.renderConnections(this.connections.filter((function(o){var e=o.blockId;return t.includes(e)})))},o.prototype.renderConnections=function(o){var t=this;if(0!==o.length){var n=this.robot.getRelativeToSurfaceXY();o.forEach((function(o){var r=o.blockId,i=o.position,s=o.connectedTo,a=o.wireSvg,l=o.blockPort,u=t.workspace.getBlockById(r);if(u){t.needToUpdateBlockPorts(u,i,s)&&(t.updateBlockPorts(u),i.x=t.calculatePortPosition(u,s));var p=u.getRelativeToSurfaceXY(),d={x:p.x+i.x+c,y:p.y+i.y+c},h=t.robot.getPortByName(s);if(h){var f={x:n.x+h.position.x+c,y:n.y+h.position.y+c},k=t.shouldWireWrap(u,f),g=new e.default(d,f,u.ports.indexOf(l),k?t.calculateBlockCorners(u):void 0);a.setAttribute("d",g.path),a.setAttribute("stroke-width",1.8)}}})),s(this.wireGroup).remove().appendTo(this.workspace.getCanvas())}},o.prototype.shouldWireWrap=function(o,t){var n=this.calculateBlockCorners(o),r=n.lowerRight,i=r.x,s=(r.y,n.upperLeft),c=s.x;s.y;return c-e.default.SEPARATOR<=t.x&&t.x<=i+e.default.SEPARATOR},o.prototype.calculateBlockCorners=function(o){var t=o.getRelativeToSurfaceXY();return{upperLeft:t,lowerRight:{x:t.x+o.width,y:t.y+o.height}}},o.prototype.needToUpdateBlockPorts=function(o,t,e){if(e)return t.x!==this.calculatePortPosition(o,e)},o.prototype.calculatePortPosition=function(o,t){return o.getRelativeToSurfaceXY().x+o.width/2<this.robot.getRelativeToSurfaceXY().x+this.robot.getPortByName(t).position.x?o.width-c:-2.5},o}();t.CircuitVisualization=a}));
//# sourceMappingURL=confVisualization.js.map
//# sourceMappingURL=confVisualization.js.map
