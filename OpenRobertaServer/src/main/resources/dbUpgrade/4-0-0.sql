create cached table USERGROUP (
  ID INTEGER not null,
  NAME varchar(255) not null,
  OWNER_ID INTEGER not null,
  ACCESS_RIGHT varchar(32) not null,
  CREATED timestamp not null,
  primary key (ID)
);
alter table USERGROUP add foreign key (OWNER_ID) references USER(ID) ON DELETE CASCADE;
create unique index usergroupOwnerNameIdx on USERGROUP(OWNER_ID, NAME);
alter table USERGROUP alter column ID generated by default as identity (start with 93);

alter table USER add USERGROUP_ID INTEGER default null;
alter table USER add foreign key (USERGROUP_ID) references USERGROUP(ID) ON DELETE CASCADE;
drop index accountIdx;
create unique index usergroupAccountIdx on USER(USERGROUP_ID, ACCOUNT);

create cached table USERGROUP_PROGRAM (
  ID INTEGER not null,
  USERGROUP_ID INTEGER not null,
  PROGRAM_ID INTEGER not null,
  RELATION varchar(32) not null, -- [READ | WRITE]
  primary key (ID)
);

alter table USERGROUP_PROGRAM add foreign key (USERGROUP_ID) references USERGROUP(ID) on delete cascade;
alter table USERGROUP_PROGRAM add foreign key (PROGRAM_ID) references PROGRAM(ID) on delete cascade;
create unique index usergroupProgramIdx on USERGROUP_PROGRAM(USERGROUP_ID, PROGRAM_ID);
alter table USERGROUP_PROGRAM alter column ID generated by default as identity (start with 93);

-- small correction to other tables. Sets the type to cached ('persistent', not in memory)
set table LOST_PASSWORD               type CACHED;
set table PENDING_EMAIL_CONFIRMATIONS type CACHED;

-- drop the unused table
drop table TOOLBOX;

-- safety
commit;